/**
 * IBOSApp
 * @version v1.5.0
 * @link http://www.kubangong.cn
 * @author IBOS前端组
 */
function getProvider(t){return angular.element(document.body).injector().get(t)}angular.module("ibosApp.controllers",[]).controller("LoginCtrl",["$scope","$state","Settings","User",function(t,e,n,i){t.user={username:"",password:""},t.submitLogin=function(){t.logining=!0,i.login(t.user).success(function(t){t.login&&e.go(n.mainState)})["finally"](function(){t.logining=!1})}}]).controller("AppsCtrl",["$scope","$ionicModal","$localstorage","$timeout","Utils","User","Apps",function(t,e,n,i,r,o,a){function s(t){return function(e,n){var i=l[e.name],r=l[n.name];if(i&&"undefined"!=typeof i[t])return r&&"undefined"!=typeof r[t]?i[t]>r[t]?1:-1:1}}var c="portal.settings",l=n.getObject(c)||{};t.apps=a.all(),t.user=o.user;var u={icon:[],panel:["cabinet","contacts","thread"]};["icon","panel"].forEach(function(e){t.settings=t.settings||{};var r=t.settings[e]={apps:[],isDisabled:function(t){return u[e].indexOf(t.name)!==-1},getApps:function(){return this.apps=t.apps.filter(this.isShow.bind(this)).sort(s(e+"Index")),this.apps},isShow:function(t){return!this.isDisabled(t)&&(!l||!l[t.name]||l[t.name][e]!==!1)},toggleShow:function(t,i){l[i.name]=l[i.name]||{},l[i.name][e]=t.target.checked,delete l[i.name][e+"Index"],n.setObject(c,l),this.getApps()},reorder:function(t,i,r){this.apps.splice(i,1),this.apps.splice(r,0,t),this.apps.forEach(function(t,n){l[t.name]=l[t.name]||{},l[t.name][e+"Index"]=n}),n.setObject(c,l)}};r.getApps(),t.refresh=function(){t.$broadcast("portal"),i(function(){t.$broadcast("scroll.refreshComplete")},1e3)}}),e.fromTemplateUrl("templates/portal-setting.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.setModal=e,t.$on("$destroy",function(){e.remove()}),t.$on("$ionicView.leave",function(){e.hide()})}),e.fromTemplateUrl("templates/portal-order.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.orderModal=e,t.$on("$destroy",function(){e.remove()}),t.$on("$ionicView.leave",function(){e.hide()})})}]).controller("AppsDiaryCtrl",["$scope","$http","Settings",function(t,e,n){t.personal={url:n.rootUrl+"/diary",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.review={url:n.rootUrl+"/diary/allsubs",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.diary})}},t.follow={url:n.rootUrl+"/diary/attention",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.diary})}},t.tabOn="",t.tab=function(e){t.tabOn=e,t[e].loading=!0,t[e].load()["finally"](function(){t[e].loading=!1})},t.tab("personal"),t.$on("portal",function(){t.tab("personal")})}]).controller("AppsWorkflowCtrl",["$scope","$http","Settings",function(t,e,n){t.todo={loading:!1,url:n.rootUrl+"/work&type=todo"},t.follow={loading:!1,url:n.rootUrl+"/work/follow"},t.done={loading:!1,url:n.rootUrl+"/work&type=done"},t.tabOn="",t.tab=function(n){t.tabOn=n,t[n].loading=!0,e.get(t[n].url).success(function(e){t[n].list=e.data||e.datas})["finally"](function(){t[n].loading=!1})},t.tab("todo"),t.$on("portal",function(){t.tab("todo")})}]).controller("AppsCalendarCtrl",["$scope","$http","Settings","Calendar","CalendarUtil",function(t,e,n,i,r){function o(){e.get(t.calendar.url,{params:r.getDateRange()}).success(function(e){t.calendar.list=r.parseEvents(e.events)})["finally"](function(){t.calendar.loading=!1})}t.calendar={loading:!0,url:n.rootUrl+"/calendar"},o(),t.isInterDay=function(t){return t.endtime-t.starttime>864e5},t.$on("portal",o)}]).controller("AppsAssignmentCtrl",["$scope","$http","Settings",function(t,e,n){t.unfinished={url:n.rootUrl+"/assignmentunfinished",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.chargeData})}},t.finished={url:n.rootUrl+"/assignmentfinished",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.tabOn="",t.tab=function(e){t.tabOn=e,t[e].loading=!0,t[e].load()["finally"](function(){t[e].loading=!1})},t.tab("unfinished"),t.isOverdue=function(t){return t&&t.endtime&&Date.now()>1e3*t.endtime},t.haveRemind=function(e){return e&&!t.isOverdue(e)&&e.remindtime>0},t.$on("portal",function(){t.tab("unfinished")})}]).controller("AppsDocsCtrl",["$scope","$http","Settings",function(t,e,n){t.unsigned={url:n.rootUrl+"/docs&type=nosign",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.published={url:n.rootUrl+"/docs",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.tabOn="",t.tab=function(e){t.tabOn=e,t[e].loading=!0,t[e].load()["finally"](function(){t[e].loading=!1})},t.tab("unsigned"),t.$on("portal",function(){t.tab("unsigned")})}]).controller("AppsNewsCtrl",["$scope","$http","Settings",function(t,e,n){t.unread={url:n.rootUrl+"/news&type=new",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.published={url:n.rootUrl+"/news",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.tabOn="",t.tab=function(e){t.tabOn=e,t[e].loading=!0,t[e].load()["finally"](function(){t[e].loading=!1})},t.tab("unread"),t.$on("portal",function(){t.tab("unread")})}]).controller("AppsEmailCtrl",["$scope","$http","Settings",function(t,e,n){t.inbox={url:n.rootUrl+"/mail&type=inbox",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.todo={url:n.rootUrl+"/mail&type=todo",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas})}},t.tabOn="",t.tab=function(e){t.tabOn=e,t[e].loading=!0,t[e].load()["finally"](function(){t[e].loading=!1})},t.tab("inbox"),t.$on("portal",function(){t.tab("inbox")})}]).controller("AppsActivityCtrl",["$scope","$http","Settings",function(t,e,n){t.activity={url:n.rootUrl+"/activity",loading:!1,load:function(){var t=this;return e.get(this.url).success(function(e){t.list=e.data||e.datas,console.log(t.list,"活动")})}},t.tabOn="",t.tab=function(e){t.tabOn=e,t[e].loading=!0,t[e].load()["finally"](function(){t[e].loading=!1})},t.tab("inbox"),t.$on("portal",function(){t.tab("inbox")})}]),angular.module("datetime",[]).factory("DateUtils",["dateFilter",function(t){var e=864e5;return{floorDate:function(t){return t=angular.isDate(t)?t:"undefined"!=typeof t?new Date(t):new Date,t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t},ceilDate:function(t){return t=angular.isDate(t)?t:"undefined"!=typeof t?new Date(t):new Date,t.setTime(+this.floorDate(t)+e-1),t},isToday:function(t,e){return t=new Date(t),e=e?new Date(e):new Date,t>=this.floorDate(e)&&t<=this.ceilDate(e)},isTomorrow:function(t,n){t=new Date(t),n=n?new Date(n):new Date;var i=new Date(+n+e);return t>=this.floorDate(i)&&t<=this.ceilDate(i)},isYesterday:function(t,n){t=new Date(t),n=n?new Date(n):new Date;var i=new Date(+n-e);return t>=this.floorDate(i)&&t<=this.ceilDate(i)},inThisWeek:function(t){t=new Date(t);var n=new Date,i=t.getTime(),r=+this.floorDate(n)-n.getDay()*e,o=+this.ceilDate(n)+(6-n.getDay())*e;return i>=r&&i<=o},inThisYear:function(t){t=new Date(t);var e=new Date;return e.getFullYear()===t.getFullYear()}}}]).filter("humanizedTime",["dateFilter",function(t){return function(e,n){e=+e,n=n||"yyyy-MM-dd";var i=+new Date,r=i>=e?["秒前","分钟前","小时前","天前"]:["秒后","分钟后","小时后","天后"],o=Math.abs(i-e)/1e3;return o<60?Math.floor(o)+r[0]:(o/=60,o<60?Math.floor(o)+r[1]:(o/=60,o<24?Math.floor(o)+r[2]:(o/=24,o<7?Math.floor(o)+r[3]:t(e,n))))}}]).filter("humanizedDate",["dateFilter",function(t){return function(e,n){e=+e,n=n||"yyyy-MM-dd";var i=new Date;i.setHours(0),i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0);var r=(e-i)/864e5;switch(Math.floor(r)){case-2:return"前天";case-1:return"昨天";case 0:return"今天";case 1:return"明天";case 2:return"后天";default:return t(e,n)}}}]).filter("humanizedDateTime",["dateFilter","DateUtils",function(t,e){var n={today:"HH:mm",yesterday:"昨天",tomorrow:"明天",thisWeek:"EEE",thisYear:"MM-dd","default":"yyyy-MM-dd"};return function(i,r){var o="default";return r=angular.extend({},n,r),e.isToday(i)?o="today":e.isYesterday(i)?o="yesterday":e.isTomorrow(i)?o="tomorrow":e.inThisWeek(i)?o="thisWeek":e.inThisYear(i)&&(o="thisYear"),t(i,r[o])}}]).filter("isToday",["dateFilter",function(t){return function(e){return t(new Date,"yyyyMMdd")===t(e,"yyyyMMdd")}}]).filter("isAfterThanNow",function(){return function(t){return t>+new Date}}).filter("isBeforeThanNow",function(){return function(t){return t<+new Date}}).directive("dateStrInput",["dateFilter",function(t){return{restrict:"A",require:"ngModel",link:function(e,n,i,r){var o=i.dateStrInput||"yyyy-MM-dd";r.$parsers.push(function(e){return t(e,o)}),r.$formatters.push(function(t){return new Date(t)})}}}]),angular.module("ibosApp.directives",[]).directive("copyright",function(){return{restrict:"E",template:"<p>Copyright © 2009-2017 IBOS 深圳市博思协创网络科技有限公司</p>",replace:!0}}).directive("hideTabs",["$rootScope","$timeout",function(t,e){return{restrict:"A",link:function(e,n){t.hideTabs=!0,e.$on("$destroy",function(){t.hideTabs=!1})}}}]).directive("imgPreview",["ImgViewer",function(t){var e=Array.prototype.map;return{restrict:"AC",priority:1,compile:function(n,i){return function(i,r,o){var a,s=r[0].tagName.toLowerCase();if("img"===s){var c=o.imgPreview||"";r.on("click",function(){var n=this.getAttribute("img-preview-src")||this.src,i=document.querySelectorAll('img[img-preview="'+c+'"]'),r=e.call(i,function(t){return t.getAttribute("img-preview-src")||t.src});t.view(n,r)})}else n.on("click",function(n){if("IMG"===n.target.tagName.toUpperCase()){var i=r[0].querySelectorAll("img");a=e.call(i,function(t){return t.src}),t.view(n.target.src,a)}})}}}}]).directive("letter",["$location","$document","$timeout","$ionicLoading","$ionicScrollDelegate","$ionicLoadingConfig",function(t,e,n,i,r,o){function a(){return"#ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").map(function(t,e){return'<a flag="'+t+'">'+t+"</a>"}).join("")}var s=Array.prototype.map;return{restrict:"A",template:a(),compile:function(a,c){return a.addClass("letter-bar"),function(c,l,u){function d(){return s.call(l.find("a"),function(t){return{top:t.offsetTop,bottom:t.offsetTop+t.clientHeight,flag:t.getAttribute("flag")}})}function f(t){if(t<b[0].top)return b[0].flag;if(t>b[b.length-1].bottom)return b[b.length-1].flag;for(var e=0;e<b.length;e++)if(b[e].top<=t&&b[e].bottom>=t)return b[e].flag}function p(t){n.cancel(w),ionic.off("touchmove",p,e[0]);var i=(t.clientY||t.touches[0].clientY)-v;m(f(i)),w=n(function(){ionic.on("touchmove",p,e[0])},50),t.stopPropagation(),t.preventDefault()}function m(e){var n,o;e=e||"",i.show({noBackdrop:!0,template:'<div class="letter-text">'+e+"</div>"}),n=$+"_"+e,o=document.getElementById(n),o&&"none"!==o.style.display&&(t.replace().hash(n),r.anchorScroll())}function h(t){var n=this.getAttribute("flag");y=angular.extend({},o),v=l[0].getBoundingClientRect().top,l.addClass("active"),b=d(),m(n),ionic.on("touchmove",p,e[0]),ionic.on("touchend",g,e[0]),ionic.on("touchcancel",g,e[0]),t.stopPropagation()}function g(){n.cancel(w),l.removeClass("active"),i.hide(),o.template=y.template,ionic.off("touchmove",p,e[0]),ionic.off("touchend",p,e[0]),ionic.off("touchcancel",p,e[0])}var v,w,y,$=u.letter,b=d();angular.forEach(l.find("a"),function(t,e){ionic.on("touchstart",h,t)});var C=c;c.$watch(function(){return(C.$hasHeader?" has-header":"")+(C.$hasSubheader?" has-subheader":"")+(C.$hasFooter?" has-footer":"")+(C.$hasSubfooter?" has-subfooter":"")},function(t,e){a.removeClass(e),a.addClass(t)})}}}}]).directive("userSelector",["$filter","removeFilter","userInfoFilter","departmentInfoFilter","positionInfoFilter",function(t,e,n,i,r){return{restrict:"E",replace:!0,require:"ngModel",scope:!0,template:'<div><div class="user-selector"><span ng-repeat="val in collection" ng-click="remove(val)">{{ getName(val) }}</span></div><input type="hidden"></div>',compile:function(t,o){var a=t.find("input");return angular.forEach({name:o.name,"ng-value":o.ngValue,"ng-model":o.ngModel,"ng-disabled":o.ngDisabled,"ng-change":o.ngChange,required:o.required},function(t,e){angular.isDefined(t)&&a.attr(e,t)}),function(t,o,a,s){var c=a.selectType||"user";t.getName=function(t){return"user"==c?n(t,"realname"):"position"==c?r(t,"posname"):"department"==c?i(t,"deptname"):void 0},t.remove=function(e){if(console.log("disabledRemove"),"true"!==a.disabledRemove){var n=t.collection.indexOf(e);n!==-1&&(t.collection.splice(n,1),s.$setViewValue(t.collection.join(",")))}},s.$render=function(){angular.isString(s.$viewValue)?t.collection=e(s.$viewValue?s.$viewValue.split(","):[],""):t.collection=[]}}}}}]).directive("userSelectorTrigger",["UserSelector",function(t){return{restrict:"A",require:"ngModel",link:function(e,n,i,r){function o(t){r.$setViewValue(t.join(",")),s.hide()}function a(){var n,a;if(i.enabledUsers&&(n=e.$eval(i.enabledUsers),angular.isString(n)&&(n=n.split(","))),a={values:r.$viewValue?r.$viewValue.split(","):[]},s)s.show(a,o);else{var c={};i.maxSelection&&(c.maxSelection=i.maxSelection),n&&(c.enabled=n),t.create(c).then(function(t){s=t,s.show(a,o)})}}var s;n.on("click",a),e.$on("$destroy",function(){s&&s.remove()})}}}]).directive("userAvatarSelector",["$filter","removeFilter","userInfoFilter","departmentInfoFilter","positionInfoFilter",function(t,e,n,i,r){return{restrict:"E",require:"ngModel",scope:{ngModel:"="},template:'<div class="cslist" ng-click="outRemoveMode()"><li ng-repeat="val in collection track by $index"><i class="o40-minus-assertive-so" ng-show="removeMode" ng-click="remove($event, val)"></i><img avatar="{{ val | userInfo:\'avatar_middle\' | fullUrl }}" alt="{{ uid | userInfo:\'realname\' }}"/><div class="cslist-desc ellipsis">{{ val | userInfo: \'realname\'}} </div></li><li class="cslist-plus"><div class="cslist-plus-icon"><i class="ion-ios-plus-empty" user-selector-trigger ng-model="ngModel"></i></div></li><li class="cslist-plus" ng-show="!removeMode && collection.length" ng-click="toRemoveMode($event)"><div class="cslist-plus-icon"><i class="ion-ios-minus-empty"></i></div></li></div>',compile:function(t,o){var a=t.find("input");return angular.forEach({name:o.name,"ng-value":o.ngValue,"ng-model":o.ngModel,"ng-disabled":o.ngDisabled,"ng-change":o.ngChange,required:o.required},function(t,e){angular.isDefined(t)&&a.attr(e,t)}),function(t,o,a,s){var c=a.selectType||"user";t.getName=function(t){return"user"==c?n(t,"realname"):"position"==c?r(t,"posname"):"department"==c?i(t,"deptname"):void 0},t.outRemoveMode=function(e){t.removeMode=!1},t.removeMode=!1,t.toRemoveMode=function(e){t.removeMode=!0,e.stopPropagation()},t.remove=function(e,n){var i=t.collection.indexOf(n);i!==-1&&(t.collection.splice(i,1),s.$setViewValue(t.collection.join(","))),t.collection.length||(t.removeMode=!1),e.stopPropagation()},s.$render=function(){angular.isString(s.$viewValue)?t.collection=e(s.$viewValue?s.$viewValue.split(","):[],""):t.collection=[]}}}}}]).directive("charcount",["Utils",function(t){return{restrict:"E",require:"ngModel",replace:!0,scope:!0,transclude:!0,template:'<span class="charcount"> <em>{{count}}</em> <span ng-transclude></span> </span>',link:function(e,n,i,r){var o=isNaN(+i.max)?0:+i.max,a="true"==i.countdown;e.count=a?o:0,r.$render=function(){var n=t.getCharLength(r.$viewValue||"");e.count=a?o-n:n,r.$setValidity("charcount",n<=o)}}}}]).directive("ibDownload",["Downloader",function(t){return{restrict:"A",compile:function(e){function n(e,n,i){n.on("click",function(){t.down(i.ibDownload)})}return{pre:n}}}}]).directive("datetimeLocal",["Utils",function(t){return{restrict:"E",replace:!0,require:"ngModel",template:function(){return t.isDateTimeLocalSupport?'<input type="datetime-local" />':'<input type="text" />'},compile:function(t,e){angular.forEach({name:e.name,"ng-value":e.ngValue,"ng-model":e.ngModel,"ng-disabled":e.ngDisabled,"ng-change":e.ngChange,required:e.required,placeholder:e.placeholder},function(e,n){angular.isDefined(e)&&t.attr(n,e)})}}}]).directive("fileOnChange",function(){return{restrict:"A",link:function(t,e,n){e.bind("change",function(){var i=t.$eval(n.fileOnChange);i.apply(e,arguments)})}}}).directive("fileImageData",["$parse","Utils",function(t,e){function n(t){return!!i.test(t.type)||(alert("“"+t.name+"” 为不支持的文件格式 "+t.type),!1)}var i=/image\/(jpg|jpeg|png|bmp|gif)/;return{restrict:"A",link:function(i,r,o){var a=o.fileImageData,s=o.fileImageMaxlength;r.on("change",function(r){var o,c=r.target.files;if(c.length)if(s){var l=t(a)(i);if(!angular.isArray(l))return void console.error(a+" 不是一个数组！");for(var u=l.length,d=0;d<c.length;d++)if(o=c[d],n(o)){if(s&&u>=s){alert("已达到最大选择数 "+s);break}u++,e.getImagePreviewUrl(o,function(t){l.push(t),i.$apply(a)})}}else{if(o=c[0],!n(o))return;e.getImagePreviewUrl(o,function(t){i.$eval(a+' = "'+t+'"'),i.$apply(a)})}})}}}]).directive("stopPropagation",function(){function t(t){t.stopPropagation()}return{restrict:"A",link:function(e,n,i){var r=i.stopPropagation;angular.forEach(r.split(","),function(e){n.on(e,t)})}}}).directive("focusOn",["$timeout",function(t){return{restrict:"A",link:function(e,n,i){e.$watch(i.focusOn,function(r){t(function(){r&&n[0].focus()},e.$eval(i.focusDelay)||0)})}}}]).directive("avatar",function(){return{restrict:"A",link:function(t,e,n){var i=["big","middle","small"].indexOf(n.avatarDefaultSize)!==-1?n.avatarDefaultSize:"middle",r=n.avatarDefaultUrl||"./img/noavatar_"+i+".png";"img"===e[0].tagName.toLowerCase()&&t.$watch(function(){return n.avatar},function(t){e.attr("src",r),t&&angular.element("<img />").on("load",function(){e.attr("src",t)}).attr("src",t)})}}}).directive("attachList",["fullUrlFilter","Downloader",function(t,e){return{retrict:"E",templateUrl:"templates/attach.html",replace:!0,scope:{attach:"="},link:function(n,i,r){n.download=function(n){e.down(t(n.entireattachurl||n.officereadurl))}}}}]).directive("transheader",["$ionicScrollDelegate",function(t){return{restrict:"A",link:function(e,n,i){function r(t){angular.forEach(document.querySelectorAll("ion-header-bar"),function(e){angular.element(e).toggleClass("trans-header",t)})}function o(t){r(t.detail.scrollTop<=0)}var a=n.find("ion-content");e.$on("$ionicView.enter",function(){r(t.getScrollPosition().top<=0),a.on("scroll",o)}),e.$on("$ionicView.leave",function(){r(!1),a.off("scroll",o)})}}}]).directive("defaultNavBackButton",["$ionicHistory","$ionicConfig","$ionicPlatform","DefaultBack",function(t,e,n,i){function r(n,r,o){n.backTitle=function(){var n=i.get();if(e.backButton.previousTitleText()&&n)return t.backTitle()||n.title},n.goBack=i.goBack,n.$on("$stateChangeSuccess",function(){r.toggleClass("hide",!i.get())})}return{link:r,restrict:"EA"}}]).directive("clickInput",function(){return{restrict:"A",link:function(t,e,n){e.on("click",function(t){t.target.nodeName.toLocaleLowerCase();t.target.parentNode.querySelector("input").click()})}}}),function(){function t(t){return function(e,n){if(null==e)return"";e+="";var i=e.split(",");return i.length>1?i.map(function(e){return t[e]?n?t[e][n]:t[e]:""}).join(","):t[e]?n?t[e][n]:t[e]:""}}angular.module("ibosApp.filters",[]).filter("htmlToPlaintext",function(){return function(t){return t?String(t).replace(/<[^>]+>/gm,""):""}}).filter("fileSize",function(){var t=["B","KB","MB","GB"];return function(e,n){e=+e||0,n=null==n?2:n;for(var i=1;e>1024;)e/=1024,i++;return n?e.toFixed(n)+t[i-1]:e+t[i-1]}}).filter("filetypeIcon",function(){return function(t,e){if(!t)return"";var n=t.lastIndexOf("/"),i=t.lastIndexOf(".");return n!==-1&&(t=t.substring(n+1,i)),e&&(t+="_"+e),"img/filetype/"+t+".png"}}).filter("fileIconByExtname",["FileUtils",function(t){return t.getFileIconByExtname}]).filter("fileIconByFilename",["fileIconByExtnameFilter",function(t){return function(e,n){return"string"==typeof e?t(e.split(".").pop(),n):""}}]).filter("fullUrl",["Settings",function(t){var e=/^https?:\/\//;return function(n){return n=n||"",e.test(n)?n:t.hostUrl+n}}]).filter("editorContent",["$filter",function(t){return function(e){if(!e)return e;var n=/src\s*=\s*['"]\/?((data|static).*?)['"]/g;return e.replace(n,function(e,n){return'src="'+t("fullUrl")(n)+'"'})}}]).filter("avatar",["$filter","User",function(t,e){return function(n,i){return i=i||"middle",n&&e.users[n]?t("fullUrl")(e.users[n]["avatar_"+i]):"img/noavatar_"+i+".png"}}]).filter("userInfo",["User",function(e){return t(e.users)}]).filter("removeUserPrefix",["User",function(t){return function(e){return t.removePrefix(e)}}]).filter("positionInfo",["User",function(e){return t(e.positionData.datas)}]).filter("departmentInfo",["User",function(e){return t(e.departmentData.datas)}]).filter("asHtml",["$sce",function(t){return function(e){return t.trustAsHtml(e)}}]).filter("httpPrefix",function(){return function(t){return t?/^https?:\/\//i.test(t)?t:"http://"+t:""}}).filter("defaultAvatar",function(){return function(t,e){return e=e||"middle",t?t:"img/noavatar_"+e+".png"}}).filter("attachUrl",["Settings",function(t){return function(e){return 0===e.indexOf("data/attachment/")?t.hostUrl+e:e}}]).filter("currencyToNumber",function(){function t(e){var n=Number(e);return isNaN(n)?"string"==typeof e?t(e.replace(/,/g,"")):0:n}return t})}(),angular.module("ibosApp.services",[]).constant("REGEXP_ENUM",{notempty:"\\S+",chinese:"^[\\u4E00-\\u9FA5\\uF900-\\uFA2D]+$",letter:"^[A-Za-z]+$",num:"^([+-]?)\\d*\\.?\\d+$",idcard:"^[1-9]([0-9]{14}|[0-9]{17})$",mobile:"^1\\d{10}$",money:"^(-)?(([1-9]{1}d*)|([0]{1}))(.(d){1,2})?$",tel:"^(([0\\+]\\d{2,3}-)?(0\\d{2,3})-)?(\\d{7,8})(-(\\d{3,}))?$",zipcode:"^\\d{6}$",email:"^\\w+((-\\w+)|(\\.\\w+))*\\@[A-Za-z0-9]+((\\.|-)[A-Za-z0-9]+)*\\.[A-Za-z0-9]+$"}).constant("API_SERVER","https://api.ibos.cn/v1").provider("Resolvers",function(){var t={qqmap:["$ocLazyLoad",function(t){return t.load("components/qqmap/qqmap.js")}],canvasPainter:["$ocLazyLoad",function(t){return t.load("components/angular-canvas-painter/angular-canvas-painter.min.js")}]};return{get:function(e){var n={};return e&&e.length&&angular.forEach(e,function(e){n[e]=t[e]}),n},$get:function(){return{}}}}).factory("Settings",["$location","$window","$ionicPopup","Utils",function(t,e,n,i){function r(){var t=e.location.href.match(/(^.*\/)mobile/);return t?t[1]:""}function o(t,e,i,r){t=t||{},r=r||{};var o=0==e&&null==t?'CORS 跨域请求失败，请参考 <a href="http://doc.ibos.com.cn/article/detail/id/268">http://doc.ibos.com.cn/article/detail/id/268</a> 配置服务器':"string"==typeof t?t:angular.toJson(t);return n.alert({title:"服务器连接失败",template:"<strong>url</strong>: "+r.url+"<br> <strong>status</strong>: "+e+"<br> <strong>msg</strong>: "+o})}var a="微办公",s=i.parseSearch(e.location.search),c=s&&s.host?s.host.replace(/\/*$/,"/"):r(),l=c+"?r=mobile",u=window.corptoken?window.corptoken:t.search().corptoken?t.search().corptoken:s&&s.corptoken||"",d="portal";return{appName:a,corptoken:u,hostUrl:c,rootUrl:l,mainState:d,requestError:o}}]).factory("Utils",["$http","$q","$window","$timeout","$state","$ionicHistory","$ionicScrollDelegate","$ionicViewSwitcher","IbPopup",function(t,e,n,i,r,o,a,s,c){function l(t){return"[object File]"===toString.call(t)}function u(t){return"[object Blob]"===toString.call(t)}var d={isFormTypeSupported:function(t){var e=document.createElement("input");return e.setAttribute("type",t),e.type==t},parseSearch:function(t){t=decodeURIComponent(t).replace(/^\?/,"");for(var e=t.split("&"),n={},i=0;i<e.length;i++){var r=e[i].split("=");n[r[0]]=r[1]}return n},capitalize:function(t){return t=null==t?"":String(t),t.charAt(0).toUpperCase()+t.slice(1)},commasInclude:function(t,e){return t.split(",").indexOf(e)!==-1},pick:function(t,e){var n={};return t&&e?(angular.forEach(e,function(e){t.hasOwnProperty(e)&&(n[e]=t[e])}),n):t},eliminate:function(t,e){var n=t.indexOf(e);return n!==-1&&t.splice(n,1),n},toggle:function(t,e){var n=t.indexOf(e);return n>-1?t.splice(n,1):t.push(e),t},concatTo:function(t,e,n){return angular.forEach(e,function(e){n&&t.indexOf(e)!==-1||t.push(e)}),t},removeFrom:function(t,e){return angular.forEach(e,function(e){var n=t.indexOf(e);n!==-1&&t.splice(n,1)}),t},promptNoPermission:function(){c.alert({title:"权限错误,请检查您有无相应的权限进行操作"}).then(function(){s.nextDirection("back"),r.go("portal")})},containsArray:function(t,e){for(var n=0;n<e.length;n++)if(t.indexOf(e[n])===-1)return!1;return!0},getCharLength:function(){var t=function(t){if("undefined"==typeof t)return 0;var e=t.match(/[^\x00-\x80]/g);return t.length+(e?e.length:0)};return function(e,n){n=n||{},n.max=n.max||140,n.surl=n.surl||20;var i=e.trim().length;if(i>0){for(var r=e.match(/(http|https):\/\/[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)+([-A-Z0-9a-z\$\.\+\!\_\*\(\)\/\,\:;@&=\?~#%]*)*/gi)||[],o=0,a=0,s=r.length;a<s;a++){var c=t(r[a]);o+=c<=n.max?n.surl:c-n.max+n.surl,e=e.replace(r[a],"")}return Math.ceil((o+t(e))/2)}return 0}}(),serverWarning:function(t){},serverError:function(t){},postJsonData:function(e,n,i){return t(angular.extend({method:"POST",url:e,headers:{"Content-type":"application/json"},data:n,transformRequest:[function(t){return!angular.isObject(t)||l(t)||u(t)?t:angular.toJson(t)}]},i))},postFormData:function(e,n,i){return t(angular.extend({method:"POST",url:e,headers:{"Content-Type":void 0},data:n,transformRequest:angular.identity},i))},getImagePreviewUrl:function(t,e){angular.isFunction(e)&&(n.URL?e(n.URL.createObjectURL(t)):n.webkitURL?e(n.webkitURL.createObjectURL(t)):this.readFile(t,function(t){e(t.target.result)}))},setDocumentTitle:function(t){if(document.title=t,ionic.Platform.isIOS()){var e=angular.element('<iframe src="/favicon.ico" style="display: none;"></iframe>').on("load",function(){setTimeout(function(){e.off("load").remove()},0)});angular.element(document.body).append(e)}},httpPromise:function(t){return t.success=function(e){return t.then(e),t},t.error=function(e){return t.then(null,e),t},t},disableBack:function(t){return o.nextViewOptions(angular.extend({disableBack:!0},t))},triggerScrollViewPullToRefresh:function(t){i(function(){t.__publish(t.__scrollLeft,-t.__refreshHeight,t.__zoomLevel,!0);var e=new Date;t.refreshStartTime=e.getTime(),t.__refreshActive=!0,t.__refreshHidden=!1,t.__refreshShow&&t.__refreshShow(),t.__refreshActivate&&t.__refreshActivate(),t.__refreshStart&&t.__refreshStart()})},triggerScrollViewPullToRefreshByHandle:function(t){var e=a.$getByHandle(t).getScrollView();e&&this.triggerScrollViewPullToRefresh(e)},clearStateCacheAndGo:function(t){return o.clearCache([t]).then(function(){r.go(t)})},checkFormDirtyBeforeLeave:function(t,e,i){var r;i=i||"还有未保留的修改，是否确定离开",r=t.$on("$stateChangeStart",function(o,a,s){var l=t[e];l&&l.$dirty&&(o.preventDefault(),n.history.pushState(null,"",n.location.href),c.confirm({title:"提示",content:i}).then(function(t){t&&(r(),n.history.back())}))})}};return d.isDateTimeLocalSupport=d.isFormTypeSupported("datetime-local"),d}]).factory("$localstorage",["$window",function(t){return t.localStorage?{set:function(e,n){t.localStorage.setItem(e,n)},get:function(e,n){return t.localStorage.getItem(e)||n},remove:function(e){t.localStorage.removeItem(e)},setObject:function(e,n){t.localStorage.setItem(e,JSON.stringify(n))},getObject:function(e){return JSON.parse(t.localStorage.getItem(e))}}:{set:angular.noop,get:function(t,e){return e},remove:angular.noop,setObject:angular.noop,getObject:angular.noop}}]).factory("TalkingData",["User","Settings",function(t,e){return{onEvent:function(n,i,r){if("undefined"!=typeof TDAPP)return r=angular.extend({},r,{uid:t.uid,hostUrl:e.hostUrl}),TDAPP.onEvent(n,i,r)}}}]).factory("Apps",function(){var t=[];return{install:function(e){t.push(e)},all:function(){return t}}}).provider("User",function(){var t=["$rootScope","$state","$ionicModal","TalkingData","Settings","User","IbPopup","API_SERVER",function(t,e,n,i,r,o,a,s){if(!o.isLogin){var c=o.login().success(function(t){t.login?i.onEvent("登录成功","",{hostUrl:r.hostUrl}):i.onEvent("登录失败","",{hostUrl:r.hostUrl,res:t})}).error(function(t){console.log(t),i.onEvent("登录出错","",{res:t,hostUrl:r.hostUrl}),e.go("login")});return c}}];return{resolve:{user:t},$get:["$http","$state","$rootScope","$q","$window","$ionicPopup","Settings","IbPopup","Utils","API_SERVER",function(t,e,n,i,r,o,a,s,c,l){function u(t){o.alert({title:"登录失败",template:t.msg||"未知错误"}),e.go("login")}function d(e){var i=t.get(a.rootUrl+"/default/login&issetuser=true",{params:e,responseType:"json"}).success(function(e){e.login?(w.uid=e.uid,w.user=e.user,w.formhash=e.formhash,w.isLogin=!0,w.departmentData=e.departmentData,w.positionData=e.positionData,t.get(a.rootUrl+"/default/login").success(function(t){w.userData=t.userData,angular.extend(w.users,t.userData.datas),angular.extend(w.group,t.userData.group)}),n.user=e.user):u(e)}).error(a.requestError);return i}function f(e){return t.jsonp(l+"/oauth/connect",{params:{corptoken:e,callback:"JSON_CALLBACK"}})}function p(){var t;if(/[?&]corptoken=/.test(r.location.search))t=r.location.href;else{var e=r.location.href.split(/(?=#)/);e.splice(1,0,(e[0].indexOf("?")!==-1?"&":"?")+"corptoken="+a.corptoken),t=e.join("")}return t}function m(e){var n=i.defer();return f(e).success(function(i){if(0===i.code){a.hostUrl=i.data.systemurl+("/"===i.data.systemurl.charAt(i.data.systemurl.length-1)?"":"/"),a.rootUrl=a.hostUrl+"?r=mobile",delete i.data.systemurl;var o=t.get(a.hostUrl+"api/co/oauth/",{params:i.data,responseType:"json"}).success(function(t){t.isSuccess?d().success(function(t){n.resolve(t)}).error(function(t){n.reject(t)}):s.alert({title:"请先绑定IBOS账号！"}).then(function(){r.location.href=l+"/oauth/connect?corptoken="+e+"&redirect_uri="+p()})}).error(a.requestError);return o}alert(i.message||"登录失败：corptoken: "+e)}),c.httpPromise(n.promise)}function h(t){t.login&&t.unit&&c.setDocumentTitle(t.unit.shortname)}function g(t,e){return t?(e+t).replace(/,/g,","+e):t}function v(t,e){if(angular.isArray(t))return t.map(function(t){return t.replace(new RegExp("^"+e),"")});if(angular.isString(t)){var n=new RegExp(","+e,"g");return t.replace(n,",").slice(2)}return t}var w={uid:"",user:{},users:{},group:{},isLogin:!1};return w.login=function(t){return a.corptoken?m(a.corptoken).success(h):a.hostUrl?d(t).success(h):c.httpPromise(i.reject())},w.logout=function(){return t.get(a.rootUrl+"/default/logout").success(function(){e.go("login")})},w.getAuthority=function(){return t.get(a.hostUrl+"?r=mobile/authority/index")},w.getUser=function(t){return w.users[t||w.uid]||null},w.groupUidByLetter=function(t){var e={},n=this.group;return angular.forEach(n,function(n,i){angular.forEach(n,function(n){t.indexOf(+n)===-1&&t.indexOf(""+n)===-1||(e[i]=e[i]||[],e[i].push(n))})}),e},angular.forEach({Prefix:"u_",PositionPrefix:"p_",DepartmentPrefix:"d_"},function(t,e){w["add"+e]=function(e){return g(e,t)},w["remove"+e]=function(e){return v(e,t)}}),w}]}}).factory("Department",["Utils","User",function(t,e){var n={getDepartments:function(){return e.departmentData.datas},getSubDepartments:function(t){var e=[],n=this.getDepartments();return t=t||"0",angular.forEach(n,function(n){n.pid==t&&e.push(n)}),e},getUserByDepartment:function(n){var i=[],r=e.userData.datas;return n=n||"0",angular.forEach(r,function(e){t.commasInclude(e.deptid,n)&&i.push(e)}),i},getUidGroupByDepartment:function(t){var n=this.getUserByDepartment(t),i=n.map(function(t){return t.uid});return e.groupUidByLetter(i)}};return n}]).factory("Position",["Utils","User",function(t,e){return{getPositions:function(){return e.positionData.datas},getUserByPosition:function(n){var i=[],r=e.users;return angular.forEach(r,function(e){t.commasInclude(e.positionid,n)&&i.push(e)}),i},getUidGroupByPosition:function(t){var n=this.getUserByPosition(t),i=n.map(function(t){return t.uid});return e.groupUidByLetter(i)}}}]).factory("ImgViewer",["Settings","$window","$timeout","$rootScope","$ionicModal","$ionicSlideBoxDelegate",function(t,e,n,i,r,o){function a(t,e){if("undefined"!=typeof WeixinJSBridge)WeixinJSBridge.invoke("imagePreview",{current:t,urls:e});else if(s)s.scope.urls=e,s.scope.current=e.indexOf(t),n(function(){s.show()},50);else{var a=i.$new();a.urls=e,
a.current=e.indexOf(t),r.fromTemplateUrl("templates/img-preview.html",{scope:a,animation:"none"}).then(function(t){s=t,t.show(),t.hideDelay=1,a.closeModal=function(){t.hide()}}),a.$on("modal.shown",function(t,e){var n=o.$getByHandle("imgPreviewSlide");n&&n.slide(e.scope.current,-1)}),a.$on("modal.hidden",function(t,e){e.scope.urls=[],e.scope.current=0}),a.zoomImg=function(t){t.target.style.width=t.target.zoomFlag?"auto":"100%",t.target.zoomFlag=!t.target.zoomFlag}}}var s;return{view:a}}]).factory("FileUtils",["$window","$rootScope","$sce","IbPopup",function(t,e,n,i){function r(t){return t=(""+t).toLowerCase(),u.indexOf(t)!==-1}function o(t){return t=(""+t).toLowerCase(),d.indexOf(t)!==-1}function a(t){t=t.split("?")[0];var e=t.lastIndexOf("."),n=e!==-1?t.slice(e+1):t;return"string"==typeof n?n.toLowerCase():""}function s(e,n){e="string"==typeof e?e.toLowerCase():"";var i=t.location.pathname,r=i.split("/");r.pop();var o=r.concat([""]).join("/");return t.location.protocol+"//"+t.location.host+o+"/img/filetype/"+(f[e]||f.unknown)+(n?"_"+n:"")+".png"}function c(t){var e={title:"复制地址在浏览器中访问即可下载",template:'<div class="selectable">'+n.getTrustedHtml(t)+"</div>"};return i.alert(e)}function l(t){if(t)if(e.isWeiXin){var n=a(t);r(n)||o(n)||"html"==n||"htm"==n?window.location=t:c(t)}else window.location=t}var u=["doc","docx","xls","xlsx","ppt","pptx","pdf"],d=["jpg","jpeg","png","bmp","gif"],f={zip:"zip","7z":"7z",ai:"ai",exe:"exe",fla:"fla",html:"html",pdf:"pdf",psd:"psd",rar:"rar",swf:"swf",txt:"txt",php:"code",js:"code",asp:"code",aspx:"code",jsp:"code",xls:"excel",xlsx:"excel",doc:"word",docx:"word",ppt:"ppt",pptx:"ppt",pps:"ppt",ppsx:"ppt",mp3:"music",wav:"music",wma:"music",flac:"music",ape:"music",png:"photo",jpg:"photo",jpeg:"photo",gif:"photo",mp4:"video",rmvb:"video",rm:"video",avi:"video",flv:"video",mkv:"video",wmv:"video",unknown:"unknown"};return{isOfficeFile:r,isImage:o,getExtname:a,showDownloadTip:c,download:l,getFileIconByExtname:s}}]).factory("Downloader",["$window","$rootScope","IbPopup",function(t,e,n){var i=["doc","docx","xls","xlsx","ppt","pptx","pdf","txt","png","gif","jpg","jpeg"],r="wxdownload.html";return{down:function(n){if(e.isWeiXin){var r=n.split("."),o=r[r.length-1];if(i.indexOf(o)===-1)return void this.downloadInWx(n)}t.location.href=n},downloadInWx:function(e){t.location.href=r+"?url="+encodeURIComponent(e)}}}]).factory("External",["$rootScope","$window",function(t,e){var n=t.isWeiXin;return{getLocation:function(t,e){n?wx.ready(function(){wx.getLocation({success:function(e){t(e)},fail:e})}):navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){t({latitude:e.coords.latitude,longitude:e.coords.longitude})},e)},openLocation:function(t){if(n)wx.openLocation(t);else{var i="http://apis.map.qq.com/uri/v1/geocoder?coord="+t.latitude+","+t.longitude+"&referer=酷办公";e.open(i)}}}}]).factory("UserSelector",["$rootScope","$q","$ionicModal","$ionicScrollDelegate","Utils","isEmptyFilter","toArrayFilter","User","Department","Position",function(t,e,n,i,r,o,a,s,c,l){function u(t,e,n){var i={};return e?(e.length&&angular.forEach(t,function(t,n){var r=t.filter(function(t){return e.indexOf(+t)!==-1||e.indexOf(""+t)!==-1});r.length&&(i[n]=r)}),i):n?(n.length?angular.forEach(t,function(t,e){var r=t.filter(function(t){return n.indexOf(+t)===-1||n.indexOf(""+t)===-1});r.length&&(i[e]=r)}):i=t,i):t}function d(e){e=e||{};var s,c=t.$new(!0),l=n.fromTemplateUrl(e.template,{scope:c,animation:"slide-in-up"});return c.usid=h++,c.selected=c.selected||[],c.departments={},c.positions={},c.groups={},c.getSelected=function(){return Object.keys(c.selected).filter(function(t){return c.selected[t]})},c.getSelectedCount=function(){return e.maxSelection?(c.selected.length||0)+"/"+e.maxSelection:c.selected.length||0},c.setGroup=function(t){c.groups=u(t,e.enabled,e.disabled)},c.toggleSelect=function(t){t=""+t,c.selected.indexOf(t)!==-1?(r.eliminate(c.selected,t),t===s&&(s=c.selected[c.selected.length-1])):(c.selected.push(t),c.selected.length>e.maxSelection&&r.eliminate(c.selected,s),s=t)},c.toggleSelectAll=function(t){var e=Array.prototype.concat.apply([],a(c.groups));e=e.map(function(t){return""+t}),t.target.checked?r.concatTo(c.selected,e,!0):r.removeFrom(c.selected,e)},c.isSelected=function(t){return t=""+t,c.selected.indexOf(t)!==-1},c.isSelectAllShow=function(){return!e.maxSelection&&!o(c.groups)},c.$watchCollection("selected",function(t){i.$getByHandle("us-scroll").scrollBottom(!0)}),l.then(function(t){var n=t.show;t.show=function(i,r){return i=i||{},c.group={},c.selected=i.values||[],s=c.selected[c.selected.length-1],c.save=function(){angular.isFunction(r)&&r.call(t,c.selected)},c.setGroup(e.groups||{}),n.apply(t)},c.modal=t}),l}function f(t){return d(angular.extend({template:"templates/user-select-modal.html"},t)).then(function(t){function e(t){var e=[],n=[];t&&("department"===t.type?e=c.getSubDepartments(t.id):"position"!==t.type||t.id||(n=l.getPositions())),o.departments=e,o.positions=n}function n(t){var e=s.group;return t&&("department"===t.type?e=c.getUidGroupByDepartment(t.id):"position"===t.type&&t.id&&(e=l.getUidGroupByPosition(t.id))),e}function r(t,e){for(var n={},i=Object.keys(t).sort(),r=0,o=0;o<i.length;o++){var a=i[o],s=t[a];if(!(r+s.length<e)){n[a]=[].concat(s.slice(0,e-r));break}n[a]=[].concat(s),r+=s.length}return n}var o=t.scope,a=0,u=20,d=0,f={};return o.paths=[],o.$watchCollection("paths",function(t,r){var s=t[t.length-1];a=0,f=n(s),d=Object.keys(f).map(function(t){return f[t].length}).reduce(function(t,e){return t+e},0),e(s),o.loadMore(),i.$getByHandle("us-modal").scrollTop()}),o.loadMore=function(){o.setGroup(r(f,a+u)),a+=u,o.$broadcast("scroll.infiniteScrollComplete")},o.hasLoadMore=function(){return d>a},o.back=function(){o.paths.pop()},o.openDepartment=function(t){o.paths.push({type:"department",id:t})},o.openPosition=function(t){o.paths.push({type:"position",id:t})},o.$on("modal.shown",function(){o.paths.length?o.paths=[]:o.loadMore()}),t})}function p(t){return d(angular.extend({groups:s.positionData.group,template:"templates/user-select-position-modal.html"},t))}function m(t){return d(angular.extend({groups:s.departmentData.group,template:"templates/user-select-department-modal.html"},t))}var h=0;return{create:f,createPosition:p,createDepartment:m}}]).factory("IbPopup",["$timeout","$ionicPopup","$ionicBackdrop",function(t,e,n){var i=angular.extend;return{confirm:function(t){return e.confirm(i({title:"提示",okText:"确定",cancelText:"取消"},t))},alert:function(t){return e.alert(i({okText:"确定"},t))},prompt:e.prompt,show:e.show,tip:function(e,i,r){r=r||1500,i=i||"info";var o=this.show({cssClass:"ib-tip ib-tip-"+i,content:e});return n.release(),t(o.close,r),o}}}]).factory("IbList",["$http","$ionicLoading","Settings",function(t,e,n){function i(t,e){this.url=t,this.options=e||{},this.hasMore=!0,this.items=[],this.params={},this.idAttr=this.options.idAttr||"id"}return angular.extend(i.prototype,{parse:function(t){return t},showLoading:function(){e.show()},hideLoading:function(){e.hide()},fetch:function(e,n,i){var r=this;n&&this.reset(),i===!1?this.params=e:angular.extend(this.params,e),this.loading=!0,this.showLoading();var o=t.get(this.url,{params:this.params}).success(function(t){r.items=r.items.concat(r.parse(t.data||t.datas)),r.hasMore=t.hasMore});return o["finally"](function(){r.loading=!1,r.hideLoading()}),o},get:function(t){var e=null,n=this.idAttr;return angular.forEach(this.items,function(i){if(i[n]==t)return e=i,!1}),e},hasItems:function(){return!!this.items.length},getOffset:function(){return this.items.length},search:function(t){return this.fetch({offset:0,search:t},!0)},loadMore:function(){return this.fetch({offset:this.getOffset()})},checkNoData:function(){return!this.items.length&&!this.hasMore},remove:function(t){var e=this,n=this.idAttr;this.items.length&&angular.forEach(this.items,function(i,r){if(i[n]==t)return e.items.splice(r,1),!1})},reset:function(){this.items=[],this.hasMore=!0,this.params={}},refresh:function(){return this.fetch({offset:0},!0)}}),i}]).factory("SearchModal",["$q","$ionicModal",function(t,e){function n(n){var i=this;this.key=this.lastKey="",this.result=[];var r=n.scope,o=angular.isFunction(n.searchFunc)?n.searchFunc:angular.noop;this.send=ionic.debounce(function(e){return i.canceler&&i.canceler.resolve(),e?void(e!==i.lastKey&&(i.canceler=t.defer(),i.searching=!0,o(angular.extend({},n.defaultParams,{key:e}),{timeout:i.canceler.promise}).success(function(t){t.isSuccess&&(i.lastKey=e,i.result=t.data)})["finally"](function(){i.searching=!1}))):void i.reset()},200),this.reset=function(){this.searching=!1,this.lastKey="",this.key="",this.result=[]},this.showModal=function(){this.modal?this.modal.show():e.fromTemplateUrl(n.templateUrl,{scope:r,animation:"none"}).then(function(t){t.hideDelay=10,t.show(),i.modal=t,r.$on("modal.hidden",function(){i.reset()}),r.$on("$ionicView.leave",function(){i.modal.hide()}),r.$on("$destroy",function(){i.modal.remove()})})},this.hideModal=function(){this.modal&&this.modal.hide()},this.removeModal=function(){this.modal&&this.modal.remove()},r.$watch(function(){return i.key},function(t){t&&(i.searching=!0),i.send(t)})}return n}]).factory("DefaultBack",["$ionicHistory","$window","$state","$stateParams","$ionicViewSwitcher",function(t,e,n,i,r){function o(){return(n.current||{}).defaultBack}function a(){r.nextDirection("back"),t.nextViewOptions({disableBack:!0,historyRoot:!0});var e={},a=o()||{};a.state&&(a.getStateParams&&(e=a.getStateParams(i)),n.go(a.state,e))}return{get:o,goBack:function(){t.backView()?e.history.back():a()}}}]).factory("CommonApi",["$http","Settings","Utils",function(t,e,n){return{uploadAttach:function(t,i){return n.postFormData(e.hostUrl+"?r=main/upload/upload",t,i)},uploadBase64Img:function(n){return t.post(e.hostUrl+"?r=main/attach/uploadbase",{img:n})}}}]).service("UploadFile",["Settings",function(t){var e=this;this.encodeURI=function(t){var e=[];for(var n in t)e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},this.upload=function(n){var i=n.url||t.hostUrl+"?r=main/upload/upload";!n.url&&n.params&&(i=i+"&"+this.encodeURI(n.params));var r=new XMLHttpRequest;return r.upload&&(r.upload.addEventListener("progress",function(t){n.onProgress&&n.onProgress(Math.ceil(t.loaded/t.total*100))},!1),r.addEventListener("timeout",e.onTimeout,!1),r.onreadystatechange=function(t){4===r.readyState&&(200===r.status?n.onSuccess&&n.onSuccess(r.responseText&&angular.fromJson(r.responseText)):n.onFail&&n.onFail(r.responseText&&angular.fromJson(r.responseText)))},r.open("POST",i,!0),r.useXDomain=!0,r.withCredentials=!0,r.setRequestHeader("ISCORS",!0),r.send(n.data)),r}}]),angular.module("wechat",["co"]).constant("WECHAT_PUBLIC_APPID","wx4a2205ee65d28309").factory("WechatApi",["$http","$q","$window","Utils","API_APP_URL","WECHAT_PUBLIC_APPID",function(t,e,n,i,r,o){var a=r+"/wechat",s={getData:function(){return this.data?e.when(this.data):this.getInfo(this.openid).then(function(t){var n=t.data;return 0===n.code?e.when(n.data):e.reject()})},cleanAuthParams:function(t){var e=t.replace(/([?&])code=([^&]*)(&?)/,function(t,e){return e});return e.replace(/([?&])state=([^&]*)(&?)/,function(t,e){return e})},getJsSdkSign:function(e){return e=encodeURIComponent((e||n.location.href).split("#")[0]),t.get(a+"/getjssdksign?url="+e)},getOAuthUrl:function(e,n){s.cleanAuthParams(e);return t.get(a+"/getoauthurl?redirect_uri="+encodeURIComponent(e)+"&state="+(n||""))},getAuth:function(e){return t.get(a+"/getauth?code="+e)},getInfo:function(e){return t.get(a+"/getinfo?openid="+e)},initJsSdk:function(t){return s.getJsSdkSign().success(function(e){0===e.code&&"undefined"!=typeof wx&&wx.config(angular.extend({debug:!1,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","chooseImage","previewImage","openLocation","getLocation"]},t,{appId:o,timestamp:e.data.timestamp,nonceStr:e.data.noncestr,signature:e.data.signature}))})},initShareConfig:function(t){wx.ready(function(){wx.onMenuShareAppMessage(t),wx.onMenuShareTimeline(t),wx.onMenuShareQQ(t),wx.onMenuShareWeibo(t)})}};return s}]),angular.module("activity",["ionic","activity.controllers","activity.services"]).run(["Apps",function(t){t.install({name:"activity",title:"活动",route:"#/activity",state:"activity.index",icon:"img/modicon/activity.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/activity","/activity/index"),t.state("activity",{url:"/activity","abstract":!0,template:'<ion-nav-view name="activity"></ion-nav-view>',resolve:n.resolve}).state("activity.index",{url:"/index",views:{activity:{templateUrl:"templates/activity/activity-index.html",controller:"ActivityIndexCtrl"}}}).state("activity.join",{url:"/join",views:{activity:{templateUrl:"templates/activity/activity-index.html",controller:"ActivityJoinCtrl"}}}).state("activity.create",{url:"/create/:id?formdataid",cache:!1,views:{activity:{templateUrl:"templates/activity/activity-create.html",controller:"ActivityCreateCtrl"}}}).state("activity.view",{url:"/view/:id",cache:!1,views:{activity:{templateUrl:"templates/activity/activity-view.html",controller:"ActivityViewCtrl"}}}).state("activity.info",{url:"/info/:id",cache:!1,views:{activity:{templateUrl:"templates/activity/activity-info.html",controller:"ActivityInfoCtrl"}}}).state("activity.arrange",{url:"/arrange/:id",views:{activity:{templateUrl:"templates/activity/activity-arrange.html",controller:"ActivityArrangeCtrl"}}})}]),angular.module("activity.controllers",[]).controller("ActivityIndexCtrl",["$scope","$state","$ionicScrollDelegate","ActivityList",function(t,e,n,i){t.stateName=e.$current.name,t.activity=new i({type:"all"}),t.load=function(){t.activity.load().success(function(){n.resize()})},t.reload=function(){t.activity.reload()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.load()}]).controller("ActivityJoinCtrl",["$scope","$state","$ionicScrollDelegate","ActivityList",function(t,e,n,i){t.stateName=e.$current.name,t.activity=new i({type:"me"}),t.load=function(){t.activity.load().success(function(){n.resize()})},t.reload=function(){t.activity.reload()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.load()}]).controller("ActivityViewCtrl",["$scope","$timeout","$stateParams","$ionicScrollDelegate","$ionicLoading","Activity",function(t,e,n,i,r,o){t.activityId=n.id,r.show(),o.view(n).success(function(e){e.isSuccess&&(t.item=e.data)})["finally"](r.hide),t.toggleOpen=!0,t.toggleView=function(){t.toggleOpen=!t.toggleOpen,e(function(){i.resize()},100)},t.openMap=function(){window.location.href="http://api.map.baidu.com/place/search?query="+t.item.address+"&region="+t.item.address+"&output=html"}}]).controller("ActivityCreateCtrl",["$scope","$state","$stateParams","$ionicLoading","IbPopup","User","Activity",function(t,e,n,i,r,o,a){t.fields=[],t.form={},t.note={},i.show(),a.formField(n).success(function(e){e.isSuccess?(t.fields=e.data.formdata,n.formdataid?angular.forEach(t.fields,function(e){"3"==e.fieldtype?"0."===e.value?t.form[e.fieldname]=!1:(t.form[e.fieldname]=!0,t.note[e.fieldname]=e.value.slice(2)):t.form[e.fieldname]=e.value}):(t.form[t.fields[0].fieldname]=o.user.realname,t.form[t.fields[1].fieldname]=o.user.mobile,angular.forEach(t.fields,function(e){"3"==e.fieldtype&&(t.form[e.fieldname]=!1)}))):r.alert({title:e.msg})})["finally"](i.hide),t.save=function(){var o=angular.extend({},t.form),s="createSignUp";o.moduleid=n.id,n.formdataid&&(s="updateSignUp",o.formdataid=n.formdataid),angular.forEach(t.fields,function(e){"3"==e.fieldtype&&(t.form[e.fieldname]?o[e.fieldname]="1."+(t.note[e.fieldname]||""):o[e.fieldname]="0.")}),i.show(),a[s](o).success(function(t){t.isSuccess?e.go("activity.info",n):r.alert({title:t.msg})})["finally"](i.hide)}}]).controller("ActivityInfoCtrl",["$scope","$stateParams","$ionicLoading","Utils","IbPopup","Activity",function(t,e,n,i,r,o){t.activityId=e.id,n.show(),o.signUpList(e).success(function(e){e.isSuccess?t.infos=e.data:r.alert({title:e.msg})})["finally"](n.hide),t.removeItem=function(a){r.confirm({title:"确定要删除该报名信息？"}).then(function(s){s&&(n.show(),o.deleteSignUp({moduleid:e.id,formdataid:a.formdataid}).success(function(e){e.isSuccess?i.eliminate(t.infos,a):r.alert({title:e.msg})})["finally"](n.hide))})}}]).controller("ActivityArrangeCtrl",["$scope","$stateParams","$ionicLoading","IbPopup","Activity",function(t,e,n,i,r){n.show(),r.arrangeList(e).success(function(e){e.isSuccess?(t.fields=e.data.formdata,t.activity=e.data.activity):i.alert({title:e.msg})})["finally"](n.hide)}]),angular.module("activity.services",[]).factory("Activity",["$http","Utils","Settings",function(t,e,n){var i=n.hostUrl+"?r=activity",r={list:function(e){return t.get(i+"/activityapi/index",{params:e})},view:function(e){return t.get(i+"/activityapi/detail",{params:e})},formField:function(e){return t.get(i+"/signupapi/create",{params:e})},createSignUp:function(t){return e.postJsonData(i+"/signupapi/store",t)},updateSignUp:function(t){return e.postJsonData(i+"/signupapi/update",t)},deleteSignUp:function(e){return t.post(i+"/signupapi/del",e)},signUpList:function(e){return t.get(i+"/signupapi/detail",{params:e})},arrangeList:function(e){return t.get(i+"/arrangementapi/detail",{params:e})}};return r}]).factory("ActivityList",["Activity","Utils",function(t,e){return function(n){var i=this;this.loading=!1,this.hasMore=!0,this.page=1,this.list=[],this.load=function(){var r;return this.loading=!0,r=t.list(angular.extend({},n,{page:i.page})).success(function(t){t.isSuccess?(i.list=i.list.concat(t.data),i.hasMore=t.hasmore,i.page++,console.log(t)):e.promptNoPermission()}),r["finally"](function(){i.loading=!1}),r},this.reload=function(){return this.page=1,this.list.length=0,this.hasMore=!0,this.load()}}}]).filter("phoneCrawler",["REGEXP_ENUM",function(t){var e=/\b1\d{10}\b/g;return function(t){return t=t||"",t.replace(e,function(t){return'<a href="tel:'+t+'">'+t+"</a>"})}}]),angular.module("assignment",["ionic","assignment.controllers","assignment.services"]).run(["Apps",function(t){t.install({name:"assignment",title:"任务指派",route:"#/assignment",state:"assignment.index",icon:"img/modicon/assignment.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/assignment","/assignment/index"),t.state("assignment",{url:"/assignment","abstract":!0,template:'<ion-nav-view name="assignment"></ion-nav-view>',resolve:n.resolve}).state("assignment.index",{url:"/index",talkingDataLabel:"任务指派-首页",views:{assignment:{templateUrl:"templates/assignment/assignment-index.html",controller:"AssignmentIndexCtrl"}}}).state("assignment.unfinished",{url:"/unfinished?uid",views:{assignment:{templateUrl:"templates/assignment/assignment-unfinished.html",controller:"AssignmentUnfinishedCtrl"}}}).state("assignment.finished",{url:"/finished",views:{assignment:{templateUrl:"templates/assignment/assignment-finished.html",controller:"AssignmentFinishedCtrl"}}}).state("assignment.create",{url:"/create",talkingDataLabel:"任务指派-新建任务",views:{assignment:{templateUrl:"templates/assignment/assignment-create.html",controller:"AssignmentCreateCtrl"}}}).state("assignment.edit",{url:"/edit/:id",talkingDataLabel:"任务指派-编辑任务",views:{assignment:{templateUrl:"templates/assignment/assignment-edit.html",controller:"AssignmentEditCtrl"}}}).state("assignment.detail",{url:"/detail/:id",talkingDataLabel:"任务指派-查看任务",views:{assignment:{templateUrl:"templates/assignment/assignment-detail.html",controller:"AssignmentDetailCtrl"}}})}]),angular.module("assignment.controllers",[]).controller("AssignmentIndexCtrl",["$scope","$ionicModal","$ionicLoading","User","Assignment","Utils",function(t,e,n,i,r,o){n.show(),i.getAuthority().success(function(n){n.isSuccess&&(n.data.assignment?(r.getSubordinates({uid:i.uid}).success(function(t){}),e.fromTemplateUrl("templates/assignment/subordinate-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.modal=e}),t.subordinates=[],t.openSubordinateModal=function(e,n){return e.stopPropagation(),e.preventDefault(),!!n&&(r.getSubordinates({uid:n}).success(function(e){t.subordinates.push(e.users)}),void t.modal.show())},t.backSubordinateModal=function(){t.subordinates.pop()},t.closeSubordinateModal=function(){t.subordinates=[],t.modal.hide()},t.$on("$ionicView.leave",function(){t.subordinates=[],t.modal.hide()})):o.promptNoPermission())})["finally"](n.hide)}]).controller("AssignmentUnfinishedCtrl",["$scope","$state","$stateParams","$ionicActionSheet","$ionicLoading","$ionicModal","User","Utils","IbPopup","Assignment","AssignmentUnfinished",function(t,e,n,i,r,o,a,s,c,l,u){function d(t){var e=l.getRoleText(t),n={titleText:"任务操作"+(e?"（"+e+"）":""),buttons:[],buttonClicked:function(e,n){return n.handler.call(null,t)},cancelText:"取消"},i=l.getEnableOperation(t);return i.length&&angular.forEach(i,function(e){"remove"==e?(n.destructiveText=f[e].text,n.destructiveButtonClicked=function(){return f[e].handler(t)}):f[e]&&n.buttons.push(f[e])}),n}r.show(),n.uid?(t.userName="（"+a.getUser(n.uid).realname+"）",u.getSubList(n).success(function(e){t.data=e})["finally"](r.hide)):(u.get().success(function(e){t.data=e})["finally"](r.hide),t.myself=!0),t.isDateTimeLocalSupport=s.isDateTimeLocalSupport,t.isOverdue=function(t){return t&&t.endtime&&Date.now()>1e3*t.endtime},t.haveRemind=function(e){return e&&!t.isOverdue(e)&&e.remindtime>0},o.fromTemplateUrl("templates/assignment/delay-apply-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.delayModal=e}),o.fromTemplateUrl("templates/assignment/cancel-apply-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.cancelModal=e}),t.openDelayApplyModal=function(e){return t.delayApplySubmitting=!1,t.delayData={id:e.assignmentid,delayReason:"",isDesignee:a.uid==e.designeeuid,starttime:new Date(1e3*e.starttime),endtime:new Date(1e3*e.endtime)},t.delayModal.show(),!0},t.applyDelay=function(e){var n=e?u.delay:u.applyDelay;t.delayApplySubmitting=!0,n.call(u,angular.extend({},t.delayData,{starttime:t.delayData.starttime?l.formatDatetime(t.delayData.starttime):"",endtime:t.delayData.endtime?l.formatDatetime(t.delayData.endtime):""})).success(function(e){e.isSuccess&&t.delayModal.hide()})["finally"](function(){t.delayApplySubmitting=!1})},t.openCancelApplyModal=function(e){return t.cancelApplySubmitting=!1,t.cancelData={id:e.assignmentid,cancelReason:""},t.cancelModal.show(),!0},t.applyCancel=function(){t.cancelApplySubmitting=!0,u.applyCancel(t.cancelData).success(function(e){e.isSuccess&&t.cancelModal.hide()})["finally"](function(){t.cancelApplySubmitting=!1})},t.cancel=function(t){return r.show(),u.cancel({id:t.assignmentid}).success(function(e){e.isSuccess&&(t.status=4)})["finally"](r.hide),!0},t.edit=function(t){return e.go("assignment.edit",{id:t.assignmentid}),!0},t.remove=function(t){return c.confirm({title:"确定要删除该任务？"}).then(function(e){e&&(r.show(),l.remove({id:t.assignmentid}).success(function(e){e.isSuccess&&(t.isRemove=!0)})["finally"](r.hide))}),!0},t.urge=function(t){return r.show(),u.urge({id:t.assignmentid}).success(function(t){t.isSuccess&&c.tip(t.msg)})["finally"](r.hide),!0},t.restart=function(t){return r.show(),u.restart({id:t.assignmentid}).success(function(e){e.isSuccess&&(t.status=1)})["finally"](r.hide),!0},t.done=function(t){return r.show(),u.done({id:t.assignmentid}).success(function(e){e.isSuccess&&(t.status=2)})["finally"](r.hide),!0},o.fromTemplateUrl("templates/assignment/remind-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.remindModal=e}),t.openRemingModal=function(e){return t.remindSubmitting=!1,t.remindData={id:e.assignmentid,remindContent:""},e.remindtime>0&&u.getRemindData({id:e.assignmentid}).success(function(e){e.isSuccess&&(t.remindData.remindContent=e.data.content,t.remindData.remindTime=l.convertDateTime(e.data.reminddate+" "+e.data.remindtime))}),t.remindModal.show(),!0},t.remind=function(e){t.remindSubmitting=!0,u.remind(t.remindData).success(function(e){e.isSuccess&&t.remindModal.hide()})["finally"](function(){t.remindSubmitting=!1})};var f={edit:{text:"编辑",handler:t.edit},remove:{text:"删除",handler:t.remove},cancel:{text:"取消任务",handler:t.cancel},applyCancel:{text:"申请取消",handler:t.openCancelApplyModal},delay:{text:"延期任务",handler:t.openDelayApplyModal},applyDelay:{text:"申请延期",handler:t.openDelayApplyModal},remind:{text:"设置提醒",handler:t.openRemingModal},urge:{text:"催办",handler:t.urge},done:{text:"完成",handler:t.done},restart:{text:"重启任务",handler:t.restart}};t.showMenu=function(e){t.hideMenu=i.show(d(e))},t.$on("$ionicView.leave",function(){t.delayModal.hide(),t.cancelModal.hide(),t.remindModal.hide()}),t.$on("$destroy",function(){t.delayModal.remove(),t.cancelModal.remove(),t.remindModal.remove()})}]).controller("AssignmentFinishedCtrl",["$scope","$filter","$ionicLoading","$ionicActionSheet","User","AssignmentFinished","AssignmentUnfinished",function(t,e,n,i,r,o,a){t.prop={},t.init=function(){t.list.hasItems()||t.list.refresh()},t.refresh=function(){t.prop.keyword="",t.list.refresh()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.list=o,t.init(),t.isDesignee=function(t){return t.designeeuid==r.uid};var s=e("date");t.groupByFinishTime=function(t){var e=[];return angular.forEach(t,function(t,n){var i=s(1e3*t.finishtime,"yyyy-MM-dd EEEE");e.length&&i==e[e.length-1].finishDate?e[e.length-1].items.push(t):e.push({finishDate:i,items:[t]})}),e},t.$watchCollection("list.items",function(e){t.groupedItems=t.groupByFinishTime(e)}),t.restart=function(e){return n.show(),a.restart({id:e.assignmentid}).success(function(n){n.isSuccess&&t.list.remove(e.assignmentid)})["finally"](n.hide),!0},t.showMenu=function(e){var n={titleText:"任务操作",buttons:[{text:"重启任务",handler:t.restart}],buttonClicked:function(t,n){return n.handler.call(null,e)},cancelText:"取消"};t.hideMenu=i.show(n)},t.getStampPath=function(e){return Assignment.getStampPath(e,t.stamps)}}]).controller("AssignmentCreateCtrl",["$scope","$timeout","$state","$filter","$ionicLoading","Settings","Utils","User","Assignment","IbPopup",function(t,e,n,i,r,o,a,s,c,l){function u(){var e=new Date;t.form={chargeuid:s.uid,starttime:e,endtime:new Date(+e+2592e5)},d=!1}t.isDateTimeLocalSupport=a.isDateTimeLocalSupport;var d=!1;t.isDisabledSubmit=function(){return d||!(t.assignmentForm&&t.assignmentForm.$valid)},t.save=function(){var e=c.correctFormData(t.form);r.show(),d=!0,c.create(e).success(function(){u(),l.confirm({title:"新建任务成功",okText:"去看看"}).then(function(t){t&&n.go("assignment.unfinished")})}).error(o.requestError)["finally"](function(){r.hide(),d=!1})},u()}]).controller("AssignmentEditCtrl",["$scope","$stateParams","$timeout","$filter","$ionicLoading","$ionicHistory","Settings","Utils","User","IbPopup","Assignment",function(t,e,n,i,r,o,a,s,c,l,u){t.isDateTimeLocalSupport=s.isDateTimeLocalSupport;var d=!1;t.isDisabledSubmit=function(){return d||!(t.assignmentForm&&t.assignmentForm.$valid)},t.save=function(){var n=u.correctFormData(t.form);r.show(),d=!0,u.update(e.id,n).success(function(){o.goBack()}).error(a.requestError)["finally"](function(){r.hide(),d=!1})},r.show(),u.get(e).success(function(e){e.isSuccess?t.form={subject:e.data.subject,chargeuid:c.removePrefix(e.data.chargeuid),participantuid:c.removePrefix(e.data.participantuid),starttime:e.data.starttime?new Date(e.data.starttime):"",endtime:new Date(e.data.endtime),description:e.data.description}:l.alert({title:e.msg}).then(function(){o.goBack()})}).error(a.requestError)["finally"](r.hide)}]).controller("AssignmentDetailCtrl",["$scope","$stateParams","$ionicLoading","$ionicHistory","$ionicModal","Settings","User","IbPopup","Assignment","AssignmentUnfinished",function(t,e,n,i,r,o,a,s,c,l){function u(t,e,n){return t=angular.extend({buttons:[{text:"拒绝",onTap:n},{text:"同意",type:"button-positive",onTap:e}]},t),s.confirm(t)}function d(e){return u({title:"任务延期申请",templateUrl:"templates/assignment/deal-delay-apply.html",scope:t},function(){l.dealDelayApply({id:h.assignmentid,agree:1}).success(m)},function(){l.dealDelayApply({id:h.assignmentid,agree:0})})}function f(e){return u({title:"任务取消申请",templateUrl:"templates/assignment/deal-cancel-apply.html",scope:t},function(){l.dealCancelApply({id:h.assignmentid,agree:1}).success(m)},function(){l.dealCancelApply({id:h.assignmentid,agree:0})})}function p(){n.show(),c.getFullInfo(e).success(function(e){if(e.isSuccess){t.data=e.data,t.assignment=h=e.data.assignment,t.stamps=e.stamps,t.isDesignee=a.uid==h.designeeuid,t.isCharge=a.uid==h.chargeuid;var n=e.data.applyData;t.isDesignee&&n&&n.id&&(n.startTime?d(n):f(n))}else s.alert({title:e.msg}).then(function(){i.goBack()})}).error(o.requestError)["finally"](n.hide)}function m(t){t.isSuccess&&p()}var h={};t.submitting=!1,t.isOverdue=function(){return h&&h.endtime&&Date.now()>1e3*h.endtime},t.haveRemind=function(){return h&&h.remindtime>0},t.done=function(){t.submitting=!0,l.done({id:h.assignmentid}).success(m)["finally"](function(){t.submitting=!1})},t.restart=function(){t.submitting=!0,l.restart({id:h.assignmentid}).success(m)["finally"](function(){t.submitting=!1})},t.urge=function(){t.submitting=!0,l.urge({id:h.assignmentid}).success(function(t){t.isSuccess&&s.tip(t.msg)})["finally"](function(){t.submitting=!1})},p(),t.getStampPath=function(e){return c.getStampPath(e,t.stamps)},r.fromTemplateUrl("templates/assignment/stamp-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.stampModal=e}),t.selectStamp=function(e){c.stamp({id:t.assignment.assignmentid,stamp:e}).success(m),t.stampModal.hide()},t.$on("$ionicView.leave",function(){t.stampModal.hide()}),t.$on("$destroy",function(){t.stampModal.remove()})}]),angular.module("assignment.services",[]).factory("Assignment",["$rootScope","$http","$state","$filter","$ionicLoading","Settings","Utils","User",function(t,e,n,i,r,o,a,s){var c=o.rootUrl+"/assignment",l="yyyy-MM-dd HH:mm",u={designee:{0:["edit","remove","urge","cancel","delay","remind"],1:["edit","remove","done","cancel","delay","remind"],2:["edit","remove","stamp","restart"],3:["edit","remove","restart"],4:["edit","remove","restart"]},charge:{0:["done","remind"],1:["done","applyDelay","applyCancel","remind"],2:["restart"],3:["restart"],4:["restart"]}};return{getRole:function(t){return s.uid==t.designeeuid?"designee":s.uid==t.chargeuid?"charge":t.participantuid.split(",").indexOf(s.uid)!==-1?"participant":""},getRoleText:function(t){var e={charge:"负责人",designee:"指派人",participant:"参与人"};return e[this.getRole(t)]||""},getStampPath:function(t,e){var n="";return angular.forEach(e,function(e){return t==e.value&&(n=e.stampPath),!1}),n},getEnableOperation:function(t){var e=s.uid==t.designeeuid?u.designee:s.uid==t.chargeuid?u.charge:{};return e[t.status]||[]},convertDateTime:function(t){return t=angular.isDate(t)?t:new Date(t),a.isDateTimeLocalSupport?(t=new Date(+t-6e4*t.getTimezoneOffset()),t.toJSON().slice(0,16)):i("date")(t,l)},formatDatetime:function(t){return i("date")(t,l)},correctDateTime:function(t){var e=new Date(t);return a.isDateTimeLocalSupport&&(e=new Date(+e+6e4*e.getTimezoneOffset())),this.formatDatetime(e)},correctFormData:function(t){return t=angular.extend({},t),t.chargeuid=s.addPrefix(t.chargeuid),t.participantuid=s.addPrefix(t.participantuid)||"",t.starttime=this.formatDatetime(t.starttime),t.endtime=this.formatDatetime(t.endtime),t.description=t.description||"",t.attachmentid="",t},get:function(t){return e.get(c+"/edit",{params:t})},getFullInfo:function(t){return t=t||{},t.assignmentId=t.id,e.get(c+"/show",{params:t})},create:function(n){return n.formhash=s.formhash,e.post(c+"/add&addsubmit=1",n).success(function(e){t.$broadcast("assignment.create",n,e)})},update:function(n,i){return e.post(c+"/edit&id="+n,i).success(function(e){t.$broadcast("assignment.update",n,i,e)})},remove:function(t){return e.post(c+"/del",t)},getSubordinates:function(t){return e.get(o.rootUrl+"/assignmentunfinished/subList&op=getsubordinates",{params:t}).error(o.requestError)},stamp:function(t){return e.post(o.rootUrl+"/assignmentunfinished/ajaxEntrance&op=stamp",t).error(o.requestError);
}}}]).factory("AssignmentUnfinished",["$rootScope","$http","Settings","IbPopup",function(t,e,n,i){function r(t){t.isSuccess||i.tip(t.msg)}var o=n.rootUrl+"/assignmentunfinished",a={get:function(){return e.get(o).error(n.requestError)},getSubList:function(t){return e.get(o+"/subList",{params:t}).error(n.requestError)},urge:function(i){return e.post(o+"/ajaxEntrance&op=push",i).success(r).success(function(e){t.$broadcast("assignment.urge",i,e)}).error(n.requestError)},done:function(i){return e.post(o+"/ajaxEntrance&op=toFinished",i).success(r).success(function(e){t.$broadcast("assignment.done",i,e)}).error(n.requestError)},restart:function(i){return e.post(o+"/ajaxEntrance&op=restart",i).success(r).success(function(e){t.$broadcast("assignment.restart",i,e)}).error(n.requestError)},applyDelay:function(t){return e.post(o+"/ajaxEntrance&op=applyDelay",t).success(r).error(n.requestError)},applyCancel:function(t){return e.post(o+"/ajaxEntrance&op=applyCancel",t).success(r).error(n.requestError)},dealDelayApply:function(t){return e.post(o+"/ajaxEntrance&op=runApplyDelayResult",t).success(r).error(n.requestError)},dealCancelApply:function(t){return e.post(o+"/ajaxEntrance&op=runApplyCancelResult",t).success(r).error(n.requestError)},delay:function(t){return e.post(o+"/ajaxEntrance&op=delay",t).success(r).error(n.requestError)},cancel:function(t){return e.post(o+"/ajaxEntrance&op=cancel",t).success(r).error(n.requestError)},remind:function(t){return e.post(o+"/ajaxEntrance&op=remind&remindsubmit=1",t).success(r).error(n.requestError)},getRemindData:function(t){return e.get(o+"/ajaxEntrance&op=remind",{params:t}).success(r).error(n.requestError)}};return a}]).factory("AssignmentFinished",["$rootScope","Settings","IbList",function(t,e,n){var i=new n(e.rootUrl+"/assignmentfinished",{idAttr:"assignmentid"});return i.search=function(t){return""===t.trim()?this.fetch({offset:0},!0):this.fetch({offset:0,param:"search",keyword:t},!0)},i}]).filter("asmStatusText",function(){var t={0:"未读",1:"进行中",2:"已完成",3:"已评价",4:"已取消"};return function(e){return t[+e]||""}}),angular.module("cabinet",["ionic","cabinet.controllers","cabinet.services","cabinet.filters"]).run(["Apps",function(t){t.install({name:"cabinet",title:"文件柜",route:"#/cabinet",state:"cabinet.personal",icon:"img/modicon/cabinet.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/cabinet","/cabinet/personal"),t.state("cabinet",{url:"/cabinet","abstract":!0,templateUrl:"templates/cabinet/cabinet.html",resolve:n.resolve}).state("cabinet.personal",{url:"/personal?pid",talkingDataLabel:"文件柜-我的网盘",views:{"cabinet-personal":{templateUrl:"templates/cabinet/cabinet-personal.html",controller:"CbPersionalCtrl"}}}).state("cabinet.company",{url:"/company?pid",talkingDataLabel:"文件柜-公司网盘",views:{"cabinet-company":{templateUrl:"templates/cabinet/cabinet-company.html",controller:"CbCompanyCtrl"}}}).state("cabinet.received",{url:"/received",talkingDataLabel:"文件柜-收到的共享",views:{"cabinet-received":{templateUrl:"templates/cabinet/cabinet-received.html",controller:"CbReceivedCtrl"}}}).state("cabinet.user",{url:"/user?fromuid&pid",views:{"cabinet-received":{templateUrl:"templates/cabinet/cabinet-personal.html",controller:"CbReceiveUserCtrl"}}})}]),angular.module("cabinet.controllers",[]).controller("CbPersionalCtrl",["$scope","$stateParams","$ionicLoading","Settings","Cabinet","User","Utils",function(t,e,n,i,r,o,a){n.show(),o.getAuthority().success(function(n){n.isSuccess&&(n.data.file?(t.cb=new r(i.rootUrl+"/file"),t.cb.fetch(e).success(function(e){t.title=e.pDir.name})):a.promptNoPermission())})["finally"](n.hide)}]).controller("CbCompanyCtrl",["$scope","$state","$stateParams","Settings","Cabinet","ACCESS",function(t,e,n,i,r,o){t.cb=new r(i.rootUrl+"/companyfile"),t.cb.fetch(n).success(function(e){t.title=e.pDir.name}),t.cb.openFolder=function(t){e.go("cabinet.company",{pid:t.fid})};var a=t.cb.showMenu;t.cb.showMenu=function(e){a.call(t.cb,e,{remove:!e.access||e.access==o.WRITABLE})}}]).controller("CbReceivedCtrl",["$scope","CabinetReceived",function(t,e){t.users=[],e.fetch().success(function(e){t.users=e.data}),t.search=function(n){e.fetch({keyword:n,normal_search:1,search:1}).success(function(e){t.users=e.data})}}]).controller("CbReceiveUserCtrl",["$scope","$state","$stateParams","Settings","Cabinet",function(t,e,n,i,r){t.cb=new r(i.hostUrl+"?r=file/fromshare"),t.cb.fetch(n).success(function(e){1===e.breadCrumbs.length?t.title=e.breadCrumbs[0].realname:e.breadCrumbs.length>1&&(t.title=e.breadCrumbs[e.breadCrumbs.length-1].name)}),t.cb.openFolder=function(t){e.go("cabinet.user",{pid:t.fid})};var o=t.cb.showMenu;t.cb.showMenu=function(e){o.call(t.cb,e,{remove:!1})}}]),angular.module("cabinet.filters",[]),angular.module("cabinet.services",[]).constant("ACCESS",{WRITABLE:"2",READABLE:"1"}).constant("FILETYPE",{FOLDER:"1",FILE:"0"}).factory("Cabinet",["$http","$state","$filter","$stateParams","$ionicLoading","$ionicPopup","$ionicActionSheet","fullUrlFilter","Settings","ImgViewer","Downloader","FILETYPE",function(t,e,n,i,r,o,a,s,c,l,u,d){function f(t){this.moduleUrl=t,this.pid=0,this.files=[]}function p(t,e){angular.forEach(e,function(n,i){if(t.fid==n.fid)return e.splice(i,1),!1})}return f.prototype.fetch=function(e){var n=this;r.show(),e=e||{};var i=t.get(this.moduleUrl+"/getcate",{params:angular.extend({pid:this.pid},e)}).success(function(t){n.files=t.data,n.pid=e.pid||n.pid}).error(c.requestError).success(r.hide).error(r.hide);return i},f.prototype.search=function(t){return this.fetch(angular.extend({},i,{keyword:t,normal_search:1,search:1}))},f.prototype.open=function(t){t.type==d.FOLDER?this.openFolder(t):t.thumb?this.openImage(t):this.download(t)},f.prototype.openFolder=function(t){e.go("cabinet.personal",{pid:t.fid})},f.prototype.openImage=function(t){var e=[];angular.forEach(this.files,function(t){t.thumb&&e.push(s(t.fileurl))}),l.view(s(t.fileurl),e)},f.prototype.download=function(t){u.down(s(t.entireattachurl||t.officereadurl))},f.prototype.showMenu=function(t,e){var n=this,i=[],r=[];e=angular.extend({remove:!0,download:!0,share:!1},e),e.download&&(i.push({text:"下载"}),r.push(function(t){n.download(t)})),e.share&&(i.push({text:"共享"}),r.push(function(t){n.share(t)}));var o={titleText:"文件操作",buttons:i,buttonClicked:function(e){return r[e](t),!0},cancelText:"取消"};e.remove&&(o.destructiveText="删除",o.destructiveButtonClicked=function(){n.remove(t)}),this.hideMenu=a.show(o)},f.prototype.remove=function(e){var n=this;o.confirm({title:"提示",template:"确定删除该文件/文件夹吗？",okText:"确定",cancelText:"取消"}).then(function(i){if(i)return t.get(n.moduleUrl+"/del&op=recycle",{params:{fids:e.fid}}).error(c.requestError).success(function(t){t.isSuccess&&(p(e,n.files),n.hideMenu())})})},f}]).factory("CabinetReceived",["$http","$ionicLoading","Settings",function(t,e,n){function i(i){return e.show(),t.get(r,{params:i}).error(n.requestError).success(e.hide).error(e.hide)}var r=n.hostUrl+"?r=file/fromshare/getcate";return{fetch:i}}]),angular.module("calendar",["ionic","calendar.controllers","calendar.services","calendar.filters"]).run(["Apps",function(t){t.install({name:"calendar",title:"日程",route:"#/calendar",state:"calendar",icon:"img/modicon/calendar.png"})}]).constant("DATE_FORMAT","yyyy-MM-dd").constant("TIME_FORMAT","HH:mm").constant("DAY_MILLISECOND",864e5).config(["$stateProvider","UserProvider",function(t,e){t.state("calendar",{url:"/calendar",templateUrl:"templates/calendar/calendar.html",talkingDataLabel:"日程-首页",controller:"CalendarCtrl",resolve:e.resolve}).state("calendar-create",{url:"/create",templateUrl:"templates/calendar/detail.html",talkingDataLabel:"日程-创建",controller:"CalendarCreateCtrl",resolve:e.resolve}).state("calendar-detail",{url:"/calendar/:calendarId",templateUrl:"templates/calendar/detail.html",talkingDataLabel:"日程-查看",controller:"CalendarDetailCtrl",resolve:e.resolve})}]),angular.module("calendar.controllers",[]).controller("CalendarCtrl",["$scope","$ionicScrollDelegate","$ionicLoading","Calendar","CalendarUtil","User","Utils",function(t,e,n,i,r,o,a){n.show(),o.getAuthority().success(function(n){n.isSuccess&&(n.data.calendar?(t.title="我的日程",t.calendars=[],t.calendars.loaded=!1,i.fetch(r.getDateRange()).success(function(e){t.calendars=r.groupEvents(e.events),t.calendars.loaded=!0}),t.$on("$ionicView.beforeLeave",function(){e.scrollTop()})):a.promptNoPermission())})["finally"](n.hide)}]).controller("CalendarCreateCtrl",["$scope","$state","$ionicHistory","$ionicLoading","Calendar","CalendarUtil","DAY_MILLISECOND",function(t,e,n,i,r,o,a){function s(){t.isSubmiting=!1,i.hide()}function c(){t.isSubmiting=!0,i.show({delay:300})}t.title="新建日程";var l=o.getCurrentDateTime();t.calendar={isalldayevent:!1,editable:!0,category:0,startDate:l,endDate:new Date(+l+a),startTime:l,endTime:new Date(+l+a/12)},t.$watch("calendar.startDate",function(e){t.calendar.isalldayevent&&(t.calendar.endDate=new Date(+e+a))}),t.submit=function(){console.log(t.calendar),c(),r.create(r.formatSubmitData(t.calendar)).success(function(){n.clearCache().then(function(){e.go("calendar")})})["finally"](s)}}]).controller("CalendarDetailCtrl",["$scope","$state","$timeout","$stateParams","$ionicPopup","$ionicHistory","$ionicLoading","Calendar","CalendarUtil","IbPopup",function(t,e,n,i,r,o,a,s,c,l){function u(){t.isSubmiting=!1,a.hide()}function d(){t.isSubmiting=!0,a.show({delay:300})}t.title="编辑日程",s.get(i.calendarId).success(function(n){n&&"null"!=n?t.calendar=c.parseTime(n):r.alert({title:"提示",template:"找不到相关日程数据，将返回日程列表"}).then(function(){e.go("calendar")})}),t.submit=function(){d(),s.update(s.formatSubmitData(t.calendar)).success(function(){o.clearCache().then(function(){e.go("calendar")})})["finally"](u)},t.remove=function(){d(),s.removeOne(t.calendar.calendarid).success(function(){l.tip("删除成功!").then(function(){o.clearCache().then(function(){e.go("calendar")})})})["finally"](u)},t.finish=function(){if("0"==t.calendar.status){d();var e=c.parseTime(t.calendar);s.finish(s.formatSubmitData(e)).success(function(){o.clearCache(),t.calendar.status="1"})["finally"](u)}},t.unfinish=function(){if("1"==t.calendar.status){d();var e=c.parseTime(t.calendar);s.unfinish(s.formatSubmitData(e)).success(function(){o.clearCache(),t.calendar.status="0"})["finally"](u)}}}]),angular.module("calendar.filters",[]).filter("calendarTheme",function(){var t=["#3497DB","#A6C82F","#F4C73B","#EE8C0C","#E76F6F","#AD85CC","#98B2D1","#82939E"];return function(e){return e="-1"!=(e&&e)?e:0,t[e||0]}}).filter("dayFormToday",function(){return function(t){switch(t){case 0:return"今天";case 1:return"明天";case 2:return"后天";case-1:return"昨天";case-2:return"前天";default:return t>0?t+"天后":-t+"天前"}}}).filter("calendarDate",["$filter","DAY_MILLISECOND","DATE_FORMAT",function(t,e,n){function i(t,i){return t=t||new Date,i&&(t=+t+i*e),dateFilter(t,n)}return i}]).filter("calendarTime",["$filter","DAY_MILLISECOND","TIME_FORMAT",function(t,e,n){}]),angular.module("calendar.services",[]).factory("Calendar",["$http","$filter","$ionicLoading","$cacheFactory","Settings","CalendarUtil",function(t,e,n,i,r,o){function a(e){n.show();var i=t.get(m,{params:e,transformResponse:function(){var e=t.defaults.transformResponse[0].apply(null,arguments);return e.events=o.parseEvents(e.events),e}}).success(function(t){}).error(r.requestError).success(n.hide).error(n.hide);return i}function s(e,i){return n.show(),t.get(m+"/show",{params:{id:e},transformResponse:function(){var e=t.defaults.transformResponse[0].apply(null,arguments);return o.parseEvent(e)}}).error(r.requestError).success(n.hide).error(n.hide)}function c(t){1==t.isalldayevent?t.startTime=t.endTime="00:00":t.endDate=t.startDate;var e=o.formatDate(t.startDate)+" "+o.formatTime(t.startTime),n=o.formatDate(t.endDate)+" "+o.formatTime(t.endTime);return{calendarId:t.calendarid,CalendarTitle:t.subject,Subject:t.subject,Category:t.category,IsAllDayEvent:+t.isalldayevent,CalendarStartTime:e,CalendarStartTimeed:e,CalendarEndTime:n,CalendarEndTimeed:n}}function l(e){return t.post(m+"/add",e).error(r.requestError)}function u(e){return t.post(m+"/edit",e).error(r.requestError)}function d(e){return t.post(m+"/edit&op=finish",e)}function f(e){return t.post(m+"/edit&op=nofinish",e)}function p(e){return t.post(m+"/del",{calendarId:e,doption:"this"}).error(r.requestError)}var m=r.rootUrl+"/calendar",h=i("calendars");e("date");return{fetch:a,get:s,create:l,update:u,formatSubmitData:c,finish:d,unfinish:f,removeOne:p,cache:h}}]).factory("CalendarUtil",["$filter","DATE_FORMAT","TIME_FORMAT","DAY_MILLISECOND",function(t,e,n,i){function r(t){var e=m.exec(t);return e?+e[1]:0}function o(t){var e=[];return angular.forEach(t,function(t){e.push({calendarid:"1"==t.type?t.id.substr(11):t.id,instancetype:t.type,subject:t.title,isalldayevent:t.allDay,starttime:r(t.start),endtime:r(t.end),category:t.category,status:t.status,editable:t.editable})}),e}function a(t){return angular.extend(t,{starttime:t.starttime?1e3*+t.starttime:0,endtime:t.endtime?1e3*+t.endtime:0})}function s(t){var e=new Date,n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0),r=+t-+n;return Math.floor(r/i)}function c(t){if(!t||!t.length)return t;var n=[],i="";return t=t.sort(function(t,e){return e.starttime-t.starttime}),angular.forEach(t,function(t){var r=h(t.starttime,e);r!==i&&(n.push({isDateField:!0,dateField:r,startTime:t.starttime,dayFormToday:s(t.starttime)}),i=r),n.push(t)}),n}function l(t,n){return t?(n&&(t=+t+n*i),h(t,e)):""}function u(t,e){return t?(e&&(t=+t+e*i/1440),h(t,n)):""}function d(t){var e=new Date(t.starttime),n=new Date(t.endtime);return angular.extend({},t,{startDate:e,endDate:n,startTime:e,endTime:n})}function f(){var t=new Date,n=t.getFullYear(),r=t.getMonth(),o=new Date(n,r,1,0,0,0),a=new Date(new Date(10==r?n+1:n,10==r?0:r+2,1,0,0,0)-i);return{startDate:h(o,e),endDate:h(a,e)}}function p(){var t=new Date;return t.setSeconds(0),t.setMilliseconds(0),t}var m=/\/Date\((\d+)\)\//,h=t("date");return{parseEvents:o,groupEvents:c,formatDate:l,formatTime:u,parseTime:d,parseEvent:a,getDateRange:f,getCurrentDateTime:p}}]).directive("calenderColorpicker",["$ionicModal",function(t){var e='<ion-modal-view><ion-header-bar><button type="button" class="button button-icon icon" ng-click="hideColorPicker()">取消</button><h1 class="title">选择日程颜色</h1></ion-header-bar><ion-content><ion-list><ion-item ng-repeat="color in colors" ng-click="selectColor($index)" style="background-color: {{color}}">&nbsp;</ion-item></ion-list></ion-content></ion-modal-view>';return{restrict:"E",replace:!0,require:"?ngModel",scope:!0,template:'<div class="calendar-colorpicker-toggle"><input type="hidden"></div>',compile:function(n,i){var r=n.find("input");return angular.forEach({name:i.name,"ng-value":i.ngValue,"ng-model":i.ngModel,"ng-disabled":i.ngDisabled,"ng-change":i.ngChange},function(t,e){angular.isDefined(t)&&r.attr(e,t)}),function(n,i,o){var a=t.fromTemplate(e,{scope:n,animation:"slide-in-up"}),s=angular.element(r).controller("ngModel");i.on("click",function(){a.show()}),n.colors=["#3497DB","#A6C82F","#F4C73B","#EE8C0C","#E76F6F","#AD85CC","#98B2D1","#82939E"],n.colorpickerModal=a,n.showColorPicker=function(){n.colorpickerModal.show()},n.hideColorPicker=function(){n.colorpickerModal.hide()},n.$on("$destroy",function(){n.colorpickerModal.remove()}),n.selectColor=function(t){s.$setViewValue(t),n.hideColorPicker()}}}}}]).directive("currentDate",["$ionicPosition","$ionicScrollDelegate",function(t,e){return{restrict:"A",compile:function(n,i){return function(n,i,r){e.scrollTo(0,t.position(i).top||0)}}}}]),angular.module("contacts",["ionic","contacts.controllers","contact.services"]).run(["Apps",function(t){t.install({name:"contacts",title:"通讯录",route:"#/contacts",state:"contacts.list",icon:"img/modicon/contacts.png"})}]).config(["$stateProvider","$urlRouterProvider",function(t,e){e.when("/contacts","/contacts/list/"),t.state("contacts",{url:"/contacts","abstract":!0,template:'<ion-nav-view name="contacts"></ion-nav-view>',resolve:{user:["User",function(t){if(!t.isLogin)return t.login()}]}}).state("contacts.list",{url:"/list/:deptid",talkingDataLabel:"通讯录-首页",views:{contacts:{templateUrl:"templates/contacts/contacts.html",controller:"ContactsCtrl"}}}).state("contacts.detail",{url:"/detail/:id",talkingDataLabel:"通讯录-查看页",views:{contacts:{templateUrl:"templates/contacts/contacts-detail.html",controller:"ContactsDetailCtrl"}}}).state("contacts.group",{url:"/group/:id",talkingDataLabel:"通讯录-分组查看页",views:{contacts:{templateUrl:"templates/contacts/contact-group-detail.html",controller:"ContactsGroupDetailCtrl"}}})}]),angular.module("contacts.controllers",[]).controller("ContactsCtrl",["$scope","$ionicLoading","$stateParams","$ionicHistory","$ionicScrollDelegate","$ionicModal","$state","$q","IbPopup","SearchModal","Contact",function(t,e,n,i,r,o,a,s,c,l,u){function d(n){e.show(),u.getDeptList(n).success(function(e){if(e.isSuccess){t.deptInfo=e.data,t.categories=e.data.depts,t.currentCategory=t.deptInfo;var n=e.data.deptid;"0"==n?t.currentCategory.title="通讯录":t.categorys=t.deptInfo.crumb}else{if(m&&0===m.$$state.status)return;m=c.alert({title:e.msg}).then(function(){i.goBack()})}})["finally"](e.hide)}function f(n){e.show(),u.getUserList(n).success(function(e){if(e.isSuccess)t.users=e.data;else{if(m&&0===m.$$state.status)return;m=c.alert({title:e.msg})}})["finally"](e.hide)}function p(e){var n=e.detail.scrollTop;t.$applyAsync(function(){t.showsearchbar=!(n>44)})}var m,h=angular.element(document.querySelector("ion-content")),g=n.deptid||0;d({deptid:g}),f({deptid:g}),t.enterCategory=function(t){a.go("contacts.list",t)},t.toCategory=function(e){var n=e-t.categorys.length;i.goBack(n)},t.search=new l({scope:t,searchFunc:function(e){return u.search({search:e.key,deptid:t.deptInfo.deptid})}}),t.showsearchbar=!0,t.$on("$ionicView.enter",function(){h.on("scroll",p)}),t.$on("$ionicView.leave",function(){h.off("scroll",p)});var v=r.$getByHandle("contact-breadcrumb-scroll");t.$watchCollection("histories",function(){v.scrollBottom(!0)})}]).controller("ContactsDetailCtrl",["$scope","$stateParams","$ionicLoading","$state","IbPopup","Contact",function(t,e,n,i,r,o){n.show(),t.user=[],o.getUserInfo(e.id).success(function(e){e.isSuccess?t.user=e.data:r.alert({title:e.msg})})["finally"](n.hide)}]).controller("ContactsGroupDetailCtrl",["$scope","$stateParams","$ionicLoading","IbPopup","Contact",function(t,e,n,i,r){var o=e.id;"0"!==o?(n.show(),t.dept=[],r.getDeptInfo(o).success(function(e){e.isSuccess?t.dept=e.data:i.alert({title:e.msg})})["finally"](n.hide)):(n.show(),t.corp=[],r.getCorpInfo().success(function(e){e.isSuccess?t.corp=e.data:i.alert({title:e.msg})})["finally"](n.hide))}]),angular.module("contact.services",[]).factory("Contact",["$http","$ionicLoading","Settings",function(t,e,n){var i=n.hostUrl+"?r=contact/api";return{getDeptList:function(e){return t.get(i+"/deptlist",{params:e})},getUserList:function(e){return t.get(i+"/userlist",{params:e})},search:function(e){return t.get(i+"/search",{params:e})},getUserInfo:function(e){return t.get(i+"/user",{params:{userid:e}})},getCorpInfo:function(){return t.get(i+"/corp")},getDeptInfo:function(e){return t.get(i+"/dept",{params:{deptid:e}})}}}]),angular.module("crm.controllers",[]).controller("CRMIndexCtrl",["$scope","$state","$ionicLoading","$ionicModal","User","Utils","IbPopup","CRM","CRM_REPORT_TIMETYPES",function(t,e,n,i,r,o,a,s,c){t.CRM_REPORT_TIMETYPES=c,t.reload=function(){return t.now=new Date,n.show(),r.getAuthority().success(function(e){if(e.isSuccess)if(e.data.crm){t.target={},t.stage={},t.todayReport={},i.fromTemplateUrl("templates/crm/new-modal.html",{scope:t,animation:"fade-in"}).then(function(e){e.hideDelay=1,t.newModal=e});var n=1;s.getReport({time:n}).success(function(e){e.isSuccess&&(t.todayReport=e.data)}),t.setReportTimeType=function(e){t.reportTimeType=e,s.getReport({time:e}).success(function(e){e.isSuccess&&(t.report=e.data)}).success(o.serverWarning)},t.setReportTimeType(c[0].type);var a=t.now.getFullYear(),l=t.now.getMonth();angular.forEach([{key:"newClientCount",type:1},{key:"newOppCount",type:2},{key:"newOppIncome",type:6}],function(e){s.getTarget({uid:r.addPrefix(r.uid),year:a,type:e.type}).success(function(n){n.isSuccess&&n.data&&n.data.month&&n.data.month.length&&(t.target[e.key]=n.data.month[l])})}),s.getOppSurvey().success(function(e){e.isSuccess&&(t.oppSurver=e.data)})}else o.promptNoPermission()}).success(o.serverWarning)["finally"](function(){n.hide(),t.$broadcast("scroll.refreshComplete")})},t.showTargetSetupTip=function(){a.alert({title:"提示",content:'<p class="text-center" style="color:#666;">业绩目标需在PC端进行设置<br>首页&gt;业绩目标&gt;设置业绩目标</p>'})},t.reload()}]).controller("CRMContactCtrl",["$scope","dateFilter","groupByFilter","orderByFilter","Utils","SearchModal","CRMContact",function(t,e,n,i,r,o,a){function s(t){return t.map(function(t){return t.letter=t.firstCase.charAt(0).toUpperCase(),t.formattedDate=e(1e3*t.createtime,"yyyy-MM-dd"),t.company=t.company||"暂无",t})}t.tabs=[{text:"全部联系人",value:"all"},{text:"我的联系人",value:"my"},{text:"下属联系人",value:"sub"},{text:"共享联系人",value:"share"}],t.onTab=function(e){t.contactList.queryParams.range=e.value,t.confirmFilters()},t.orderType="letter",t.orderDesc=!1,a.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data)}),t.contactList={queryParams:{limit:1e4,order:{name:1}},load:function(){var e=this;this.loading=!0,a.list(e.queryParams).success(function(t){t.isSuccess&&(e.list=s(t.data.list),e.total=t.data.total)}).success(r.serverWarning)["finally"](function(){e.loading=!1,t.$broadcast("scroll.refreshComplete")})},reset:function(){this.list=[],this.total=0,this.loading=!1,this.hasMore=!0},reload:function(){this.reset(),this.load()}},t.search=new o({scope:t,templateUrl:"templates/crm/contact-search-modal.html",searchFunc:function(t){return a.list({keyword:t.key}).success(function(t){t.data.list=s(t.data.list)})}}),t.confirmFilters=function(){t.contactList.reload()}}]).controller("CRMContactFormCtrl",["$scope","$state","$ionicHistory","$ionicScrollDelegate","$ionicModal","Utils","IbPopup","CRMContact","CRMUtils","CRM_CONTACT_EXTEND",function(t,e,n,i,r,o,a,s,c,l){t.form={"extends":[]},t.stateName=e.current.name,t.isContactInfoShowed=!1,s.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data,c.initTagsToForm(t.form,t.tagGroups))}),t.selectClient=function(){c.openClientModal({cid:t.form.client?t.form.client.cid:"",callback:function(e){t.form.client=e}})},t.showContactInfo=function(){t.isContactInfoShowed=!0,i.resize()},t.addContactWay=function(e){t.form["extends"].push({key:e,value:""})},t.removeContactWay=function(e){t.form["extends"].splice(e,1)},r.fromTemplateUrl("templates/crm/contact-way.html",{scope:t}).then(function(e){e.scope.contactWays=l,t.contactWayModal=e,t.$on("$ionicView.leave",e.hide.bind(e)),t.$on("$destroyed",e.remove.bind(e))}),t.onSubmitSuccess=function(i){n.clearCache(["crm.contact"]),a.tip("crm.addContact"===t.stateName?"新增成功":"编辑成功","success").then(function(){t.contactForm.$setPristine(),e.go("crm.contactView",{contactid:i},{location:"replace"})})},t.submit=angular.noop,o.checkFormDirtyBeforeLeave(t,"contactForm")}]).controller("CRMAddContactCtrl",["$scope","$ionicHistory","$stateParams","$controller","$ionicLoading","Utils","CRMContact","CRMUtils",function(t,e,n,i,r,o,a,s){i("CRMContactFormCtrl",{$scope:t}),n.client&&(t.form.client=n.client),t.form.gender="0",t.form["extends"]=[{key:"mobile",value:""},{key:"email",value:""}],t.submit=function(){r.show(),a.create(s.buildContactFormData(t.form)).success(function(e){e.isSuccess&&t.onSubmitSuccess(e.data.contactid)}).success(s.formValidateError)["finally"](r.hide)}}]).controller("CRMEditContactCtrl",["$scope","$controller","$stateParams","$ionicLoading","Utils","CRMContact","CRMUtils",function(t,e,n,i,r,o,a){e("CRMContactFormCtrl",{$scope:t}),i.show(),o.view(n).success(function(e){e.isSuccess&&(t.form=e.data,t.form.birthday="0"==e.data.birthday?"":new Date(1e3*e.data.birthday),a.setTagsToForm(t.form,e.data.tags))}).success(r.serverWarning)["finally"](i.hide),t.submit=function(){i.show(),o.update(a.buildContactFormData(t.form)).success(function(e){e.isSuccess&&t.onSubmitSuccess(n.contactid)}).success(a.formValidateError)["finally"](i.hide)},t.removeContact=function(){a.confirmRemoveContact(n)}}]).controller("CRMContactViewCtrl",["$scope","$state","$stateParams","$ionicLoading","$ionicActionSheet","$ionicHistory","Utils","CRMContact","CRMUtils",function(t,e,n,i,r,o,a,s,c){i.show(),s.view(n).success(function(e){e.isSuccess&&(t.contact=e.data)}).success(a.serverWarning)["finally"](i.hide)}]).controller("CRMClientCtrl",["$scope","$ionicScrollDelegate","$stateParams","$controller","SearchModal","Utils","CRMClient",function(t,e,n,i,r,o,a){t.filterGroups=[{groupName:"创建时间",groupKey:"clientList.queryParams.createtime",items:[{text:"不限",value:"0"},{text:"今天",value:"1"},{text:"昨天",value:"2"},{text:"本周",value:"3"},{text:"上周",value:"4"},{text:"本月",value:"5"},{text:"上月",value:"6"}],selected:0},{groupName:"跟进时间",groupKey:"clientList.queryParams.lasteventtime",items:[{text:"不限",value:"0"},{text:"今天",value:"1"},{text:"昨天",value:"2"},{text:"本周",value:"3"},{text:"上周",value:"4"},{text:"本月",value:"5"},{text:"上月",value:"6"}],selected:0}],t.selectFilterItem=function(e,n){t.$eval(n.groupKey+'="'+e.value+'"'),t.clientList.reload()},t.clientList={list:[],queryParams:{range:"all",tags:{},createtime:"0",lasteventtime:"0"},hasMore:!0,load:function(){var n=this;n.loading=!0,n.queryParams.offset=n.list.length,a.list(n.queryParams).success(function(t){t.isSuccess&&(o.concatTo(n.list,t.data.list),n.total=t.data.total,n.hasMore=n.total>n.list.length,e.resize())}).success(o.serverWarning)["finally"](function(){n.loading=!1,t.$broadcast("scroll.refreshComplete")})},reset:function(){this.list=[],this.total=0,this.loading=!1,this.hasMore=!0},reload:function(){this.reset(),this.load()}},t.search=new r({scope:t,templateUrl:"templates/crm/client-search-modal.html",searchFunc:function(t){return a.list({keyword:t.key})}}),t.tabs=[{text:"全部客户",value:"all"},{text:"我的客户",value:"my"},{text:"下属客户",value:"sub"},{text:"久未联系",value:"estranged"},{text:"共享客户",value:"share"}],t.onTab=function(e){t.clientList.queryParams.range=e.value,t.confirmFilters()},t.confirmFilters=function(){t.clientList.reload()}}]).controller("CRMClientFormCtrl",["$scope","$state","$window","$ionicLoading","$ionicHistory","mapFilter","Utils","IbPopup","CRMContact","CRMClient","CRMUtils","DefaultBack",function(t,e,n,i,r,o,a,s,c,l,u,d){function f(){return t.form.contacts&&t.form.contacts.length?o(t.form.contacts,"contactid"):[]}t.form={},t.stateName=e.current.name,t.$on("$ionicView.enter",function(){var e=JSON.parse(n.sessionStorage.getItem("crm.addcontact"));e&&(n.sessionStorage.removeItem("crm.addcontact"),t.form.contacts=t.form.contacts||[],t.form.contacts.push(e))}),t.attachContact=function(){u.openContactModal({params:{type:"client"},selected:f(),callback:function(e){t.form.contacts=e}})},t.detachContact=function(e){a.eliminate(t.form.contacts,e)},t.submitAttachContact=function(t){return c.related({type:"client",cid:t,contactid:f()})},t.submitPromise=function(e){return i.show(),e.success(function(e){e.isSuccess&&(r.clearCache(["crm.client"]),t.submitAttachContact(e.data.cid),t.clientForm.$setPristine())}).success(u.formValidateError).success(i.hide).error(i.hide)},l.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data,u.initTagsToForm(t.form,t.tagGroups))}),a.checkFormDirtyBeforeLeave(t,"clientForm")}]).controller("CRMAddClientCtrl",["$scope","$state","$stateParams","$controller","$ionicScrollDelegate","IbPopup","CRMClient","$http","Settings",function(t,e,n,i,r,o,a,s,c){i("CRMClientFormCtrl",{$scope:t}),t.isClientInfoShowed=!1,t.addMoreInfo=function(){t.isClientInfoShowed=!0,r.resize()},t.form.likefullnames=[],t.likeFullNamesShowValue=!1,t.checkLikeFullName=function(e){clearTimeout(this.timer),this.timer=setTimeout(function(){s.post(c.hostUrl+"?r=crm/api/getlikeclient",{fullname:e}).success(function(e){t.form.likefullnames=e.data,t.likeFullNamesShow()})},200)},t.likeFullNamesNotShow=function(){t.likeFullNamesShowValue=!1},t.likeFullNamesShow=function(){0!=t.form.likefullnames.length?t.likeFullNamesShowValue=!0:t.likeFullNamesShowValue=!1},t.submit=function(){t.submitPromise(a.create(t.form)).success(function(t){t.isSuccess&&o.tip("新增成功","success").then(function(){e.go("crm.clientView",t.data,{location:"replace"})})})}}]).controller("CRMEditClientCtrl",["$scope","$window","$controller","$ionicLoading","$stateParams","Utils","IbPopup","CRMClient","CRMUtils",function(t,e,n,i,r,o,a,s,c){n("CRMClientFormCtrl",{$scope:t}),t.isClientInfoShowed=!0,i.show(),s.view(r).success(function(e){e.isSuccess&&(t.form=e.data,c.setTagsToForm(t.form,e.data.tags))}).success(o.serverWarning)["finally"](i.hide),t.removeClient=function(){c.confirmRemoveClient(r)},t.submit=function(){t.submitPromise(s.update(t.form)).success(function(t){t.isSuccess&&a.tip("编辑成功","success").then(function(){e.history.back()})})}}]).controller("CRMClientViewCtrl",["$scope","$state","$stateParams","$ionicLoading","$ionicActionSheet","$ionicHistory","mapFilter","Utils","CRMClient","CRMEvent","CRMOpportunity","CRMUtils",function(t,e,n,i,r,o,a,s,c,l,u,d){function f(){t.eventListLoaded||(i.show(),l.list({cid:n.cid,limit:1e4}).success(function(e){e.isSuccess&&(t.eventList=e.data.list,t.eventListLoaded=!0)}).success(s.serverWarning)["finally"](i.hide))}function p(){t.oppListLoaded||(i.show(),u.list({cid:n.cid,limit:1e4}).success(function(e){e.isSuccess&&(t.oppList=e.data.list,t.oppListLoaded=!0)}).success(s.serverWarning)["finally"](i.hide))}i.show(),c.view(n).success(function(e){e.isSuccess&&(t.client=e.data,d.setTagsToForm(t.client,e.data.tags))}).success(s.serverWarning)["finally"](i.hide),c.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data)}),t.activeTab="survey",t.setClientTab=function(e){t.activeTab=e||"survey","event"==e?f():"opportunity"==e&&p()},t.openAttachModal=function(){t.__attachOpts={params:{client:t.client}},d.openAttachModal(t)},t.selectContact=function(){d.selectContactToClient(n.cid,t.client.contacts?a(t.client.contacts,"contactid"):[],function(t){t.isSuccess&&o.clearCache([e.current.name]).then(e.reload)})}}]).controller("CRMOpportunityCtrl",["$scope","$ionicScrollDelegate","SearchModal","$stateParams","Utils","CRMOpportunity",function(t,e,n,i,r,o){if(t.filterGroups=[{groupName:"商机状态",groupKey:"oppList.queryParams.status",items:[{text:"不限",value:""},{text:"进行中",value:"0"},{text:"已成交",value:"1"},{text:"已失败",value:"2"}],selected:0},{groupName:"创建时间",groupKey:"oppList.queryParams.createtime",items:[{text:"不限",value:"0"},{text:"今天",value:"1"},{text:"昨天",value:"2"},{text:"本周",value:"3"},{text:"上周",value:"4"},{text:"本月",value:"5"},{text:"上月",value:"6"}],selected:0},{groupName:"更新时间",groupKey:"oppList.queryParams.updatetime",items:[{text:"不限",value:"0"},{text:"今天",value:"1"},{text:"昨天",value:"2"},{text:"本周",value:"3"},{text:"上周",value:"4"},{text:"本月",value:"5"},{text:"上月",value:"6"}],selected:0}],t.selectFilterItem=function(e,n){t.$eval(n.groupKey+'="'+e.value+'"'),t.oppList.reload()},t.tabs=[{text:"全部商机",value:"all"},{text:"我的商机",value:"my"},{text:"下属商机",value:"sub"},{text:"共享商机",value:"share"}],t.search=new n({scope:t,templateUrl:"templates/crm/opportunity-search-modal.html",searchFunc:function(t){return o.list({keyword:t.key})}}),t.oppList={list:[],queryParams:{tags:{},range:"all",createtime:"0",updatetime:"0",status:""},hasMore:!0,load:function(){var n=this;n.loading=!0,n.queryParams.offset=n.list.length,o.list(n.queryParams).success(function(t){t.isSuccess&&(r.concatTo(n.list,t.data.list),n.total=t.data.total,n.hasMore=n.total>n.list.length,i.status&&(n.list=n.list.filter(function(t){return t.status===i.status})),e.resize())}).success(r.serverWarning)["finally"](function(){n.loading=!1,t.$broadcast("scroll.refreshComplete")})},reset:function(){this.list=[],this.total=0,this.loading=!1,this.hasMore=!0},reload:function(){this.reset(),this.load()}},i.tag){var a=i.tag,s=t.oppList.queryParams;
s.range="my",s.tags[a.groupid]=[a.tagid]}t.onTab=function(e){t.oppList.queryParams.range=e.value,t.confirmFilters()},t.confirmFilters=function(){t.oppList.reload()}}]).controller("CRMOpportunityViewCtrl",["$scope","$state","$stateParams","$ionicActionSheet","$ionicLoading","$ionicHistory","mapFilter","dateFilter","Utils","CRMOpportunity","CRMEvent","CRMUtils",function(t,e,n,i,r,o,a,s,c,l,u,d){function f(){t.eventListLoaded||(r.show(),u.list({oid:n.oid,limit:1e4}).success(function(e){e.isSuccess&&(t.eventList=e.data.list,t.eventListLoaded=!0)}).success(c.serverWarning)["finally"](r.hide))}t.activeTab="survey",r.show(),l.view(n).success(function(e){e.isSuccess&&(t.opp=e.data,t.opp.cid=e.data.client&&e.data.client.cid?e.data.client.cid:"",t.opp.contactid=e.data.contacts?a(e.data.contacts,"contactid"):[],d.setTagsToForm(t.opp,e.data.tags))}).success(c.serverWarning)["finally"](r.hide),t.openAttachModal=function(){t.__attachOpts={newOpp:!1,newContact:!1,attachContact:!!t.opp.cid,params:{client:t.opp.client,opportunity:t.opp}},d.openAttachModal(t)},t.selectContact=function(){d.openContactModal({selected:t.opp.contactid,params:{type:"opp",cid:t.opp.cid||""},callback:function(e){r.show(),t.opp.contacts=e,t.opp.contactid=a(e,"contactid"),l.update(t.opp)["finally"](r.hide)}})},t.setActiveTab=function(e){t.activeTab=e,"event"===e&&f()},l.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data)})}]).controller("CRMOpportunityFormCtrl",["$scope","$state","$ionicLoading","$ionicHistory","mapFilter","Utils","IbPopup","CRMOpportunity","CRMUtils","DefaultBack",function(t,e,n,i,r,o,a,s,c,l){t.form={dealchance:0,createtime:new Date},t.isOppFormMoreShowed=!1,t.showOppFormMore=function(){t.isOppFormMoreShowed=!0},t.stateName=e.current.name,t.attachContact=function(){c.openContactModal({params:{type:"opp",cid:t.form.cid},selected:t.form.contactid||[],client:t.client,callback:function(e){t.contacts=e,t.form.contactid=r(e,"contactid")}})},t.detachContact=function(e){o.toggle(t.contacts,e),t.form.contactid=r(t.contacts,"contactid")},t.attachClient=function(){c.openClientModal({cid:t.form.cid||"",callback:function(e){t.client=e,t.form.cid=e.cid,t.contacts=[],t.form.contactid=[]}})},t.submitPromise=function(e){return n.show(),e.success(function(e){e.isSuccess&&(i.clearCache(["crm.opportunity"]),t.oppForm.$setPristine())}).success(c.formValidateError).success(n.hide).error(n.hide)},s.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data,c.initTagsToForm(t.form,t.tagGroups))}),o.checkFormDirtyBeforeLeave(t,"oppForm")}]).controller("CRMAddOpportunityCtrl",["$scope","$state","$stateParams","$controller","IbPopup","CRMOpportunity","CRMUtils",function(t,e,n,i,r,o,a){i("CRMOpportunityFormCtrl",{$scope:t}),n.client&&(t.client=n.client,t.form.cid=n.client.cid),t.submit=function(){t.submitPromise(o.create(a.buildOpportunityFormData(t.form))).success(function(t){t.isSuccess&&r.tip("新增成功","success").then(function(){e.go("crm.opportunityView",t.data,{location:"replace"})})})}}]).controller("CRMEditOpportunityCtrl",["$scope","$window","$controller","$stateParams","$ionicLoading","Utils","mapFilter","currencyToNumberFilter","IbPopup","CRMOpportunity","CRMUtils",function(t,e,n,i,r,o,a,s,c,l,u){n("CRMOpportunityFormCtrl",{$scope:t}),r.show(),l.view(i).success(function(e){e.isSuccess&&(t.form=e.data,t.form.createtime=new Date(1e3*e.data.createtime),t.form.expectendtime=e.data.expectendtime&&0!=e.data.expectendtime?new Date(1e3*e.data.expectendtime):"",t.form.expectincome=t.form.expectincome?s(t.form.expectincome):"",t.form.dealchance=+e.data.dealchance,t.form.cid=e.data.client&&e.data.client.cid?e.data.client.cid:"",t.form.contactid=e.data.contacts?a(e.data.contacts,"contactid"):[],t.contacts=e.data.contacts,t.client=e.data.client,u.setTagsToForm(t.form,e.data.tags))}).success(o.serverWarning)["finally"](r.hide),t.submit=function(){t.submitPromise(l.update(u.buildOpportunityFormData(t.form))).success(function(t){t.isSuccess&&c.tip("编辑成功","success").then(function(){e.history.back()})})},t.removeOpp=function(){u.confirmRemoveOpportunity(i)}}]).controller("CRMEventCtrl",["$scope","$ionicScrollDelegate","SearchModal","Utils","CRMEvent",function(t,e,n,i,r){t.filterGroups=[{groupName:"来源",groupKey:"eventList.queryParams.source",items:[{text:"不限",value:""},{text:"客户",value:"client"},{text:"机会",value:"opportunity"},{text:"合同",value:"contract"}],selected:0},{groupName:"跟进时间",groupKey:"eventList.queryParams.eventtime",items:[{text:"不限",value:"0"},{text:"今天",value:"1"},{text:"昨天",value:"2"},{text:"本周",value:"3"},{text:"上周",value:"4"},{text:"本月",value:"5"},{text:"上月",value:"6"}],selected:0}],t.selectFilterItem=function(e,n){t.$eval(n.groupKey+'="'+e.value+'"'),t.eventList.reload()},t.tabs=[{text:"全部跟进",value:"all"},{text:"我的跟进",value:"my"},{text:"下属跟进",value:"sub"}],t.onTab=function(e){t.eventList.queryParams.range=e.value,t.confirmFilters()},t.eventList={list:[],queryParams:{},hasMore:!0,load:function(){var n=this;n.loading=!0,n.queryParams.offset=n.list.length,r.list(n.queryParams).success(function(t){t.isSuccess&&(i.concatTo(n.list,t.data.list),n.total=t.data.total,n.hasMore=n.total>n.list.length,e.resize())}).success(i.serverWarning)["finally"](function(){n.loading=!1,t.$broadcast("scroll.refreshComplete")})},reset:function(){this.list=[],this.total=0,this.loading=!1,this.hasMore=!0},reload:function(){this.reset(),this.load()}},t.search=new n({scope:t,templateUrl:"templates/crm/event-search-modal.html",searchFunc:function(t){return r.list({keyword:t.key})}}),t.confirmFilters=function(){t.eventList.reload()},r.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data)})}]).controller("CRMEventFormCtrl",["$scope","$state","$ionicLoading","$ionicHistory","mapFilter","IbPopup","Utils","CRMEvent","CRMUtils","DefaultBack",function(t,e,n,i,r,o,a,s,c,l){t.form={},t.stateName=e.current.name,t.selectClient=function(){c.openClientModal({cid:t.form.client?t.form.client.cid:"",callback:function(e){e!==t.form.client&&(t.form.client=e,t.form.cid=e.cid,t.form.opportunity=null,t.form.oid="",t.form.contacts=[],t.form.contactid=[])}})},t.selectOpportunity=function(){c.openOpportunityModal({selected:t.form.oid||"",params:{cid:t.form.cid||""},callback:function(e){e!==t.form.opportunity&&(t.form.opportunity=e,t.form.oid=e.oid,t.form.contacts=[],t.form.contactid=[])}})},t.attachContact=function(){c.openContactModal({selected:t.form.contactid,params:{type:"event",cid:t.form.cid||"",oid:t.form.oid||""},callback:function(e){t.form.contacts=e,t.form.contactid=r(e,"contactid")}})},t.detachContact=function(e){a.eliminate(t.form.contacts,e),t.form.contactid=r(t.form.contacts,"contactid")},t.submitPromise=function(e){return n.show(),e.success(function(e){e.isSuccess&&(i.clearCache(["crm.event"]),t.eventForm.$setPristine())}).success(c.formValidateError).success(n.hide).error(n.hide)},s.tagList().success(function(e){e.isSuccess&&(t.tagGroups=e.data,c.initTagsToForm(t.form,t.tagGroups))}),a.checkFormDirtyBeforeLeave(t,"eventForm")}]).controller("CRMAddEventCtrl",["$scope","$state","$stateParams","$controller","IbPopup","CRMEvent",function(t,e,n,i,r,o){i("CRMEventFormCtrl",{$scope:t}),n.client&&(t.form.client=n.client,t.form.cid=n.client.cid),n.opportunity&&(t.form.opportunity=n.opportunity,t.form.oid=n.opportunity.oid),t.submit=function(){t.submitPromise(o.create(t.form)).success(function(t){t.isSuccess&&r.tip("新增成功","success").then(function(){e.go("crm.eventView",t.data,{location:"replace"})})})}}]).controller("CRMEditEventCtrl",["$scope","$window","$controller","$stateParams","$ionicLoading","mapFilter","Utils","IbPopup","CRMEvent","CRMUtils",function(t,e,n,i,r,o,a,s,c,l){n("CRMEventFormCtrl",{$scope:t}),r.show(),c.view(i).success(function(e){e.isSuccess&&(t.form=e.data,t.form.cid=e.data.client?e.data.client.cid:"",t.form.oid=e.data.opportunity?e.data.opportunity.oid:"",t.form.contactid=e.data.contacts?o(e.data.contacts,"contactid"):[],l.setTagsToForm(t.form,e.data.tags))}).success(a.serverWarning)["finally"](r.hide),t.submit=function(){t.form.aid=[],t.submitPromise(c.update(t.form)).success(function(t){t.isSuccess&&s.tip("编辑成功","success").then(function(){e.history.back()})})},t.removeEvent=function(){l.confirmRemoveEvent(i)}}]).controller("CRMEventViewCtrl",["$scope","$state","$stateParams","$ionicLoading","$ionicActionSheet","Utils","CRMEvent","CRMUtils",function(t,e,n,i,r,o,a,s){i.show(),a.view(n).success(function(e){e.isSuccess&&(t.ev=e.data)}).success(o.serverWarning)["finally"](i.hide)}]),angular.module("crm",["ionic","crm.controllers","crm.services"]).run(["Apps",function(t){t.install({name:"crm",title:"CRM",route:"#/crm",state:"crm.index",icon:"img/modicon/crm.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider","ResolversProvider",function(t,e,n,i){e.when("/crm","/crm/index"),t.state("crm",{url:"/crm","abstract":!0,template:'<ion-nav-view name="crm"></ion-nav-view>',resolve:n.resolve}).state("crm.index",{url:"/index",talkingDataLabel:"CRM-门户",views:{crm:{templateUrl:"templates/crm/index.html",controller:"CRMIndexCtrl"}}}).state("crm.contact",{url:"/contact",talkingDataLabel:"CRM-联系人-首页",views:{crm:{templateUrl:"templates/crm/contact.html",controller:"CRMContactCtrl"}},defaultBack:{title:"CRM",state:"crm.index"}}).state("crm.addContact",{url:"/addcontact",talkingDataLabel:"CRM-联系人-添加",params:{client:null},cache:!1,views:{crm:{templateUrl:"templates/crm/contact-form.html",controller:"CRMAddContactCtrl"}},resolve:i.get(["qqmap"]),defaultBack:{title:"联系人",state:"crm.contact"}}).state("crm.editContact",{url:"/editcontact/:contactid",talkingDataLabel:"CRM-联系人-编辑",cache:!1,views:{crm:{templateUrl:"templates/crm/contact-form.html",controller:"CRMEditContactCtrl"}},resolve:i.get(["qqmap"]),defaultBack:{title:"联系人",state:"crm.contact"}}).state("crm.contactView",{url:"/contactview/:contactid",talkingDataLabel:"CRM-联系人-详情",cache:!1,views:{crm:{templateUrl:"templates/crm/contact-view.html",controller:"CRMContactViewCtrl"}}}).state("crm.client",{url:"/client",talkingDataLabel:"CRM-客户-主页",views:{crm:{templateUrl:"templates/crm/client.html",controller:"CRMClientCtrl"}},defaultBack:{title:"CRM",state:"crm.index"}}).state("crm.addClient",{url:"/addclient",talkingDataLabel:"CRM-客户-添加",params:{contact:null},cache:!1,views:{crm:{templateUrl:"templates/crm/client-form.html",controller:"CRMAddClientCtrl"}},resolve:i.get(["qqmap"]),defaultBack:{title:"客户",state:"crm.client"}}).state("crm.editClient",{url:"/editclient/:cid",talkingDataLabel:"CRM-客户-编辑",cache:!1,views:{crm:{templateUrl:"templates/crm/client-form.html",controller:"CRMEditClientCtrl"}},resolve:i.get(["qqmap"]),defaultBack:{title:"客户",state:"crm.client"}}).state("crm.clientView",{url:"/clientview/:cid",talkingDataLabel:"CRM-客户-查看",cache:!1,views:{crm:{templateUrl:"templates/crm/client-view.html",controller:"CRMClientViewCtrl"}}}).state("crm.opportunity",{url:"/opportunity",params:{tag:null,status:null},talkingDataLabel:"CRM-商机-首页",views:{crm:{templateUrl:"templates/crm/opportunity.html",controller:"CRMOpportunityCtrl"}},defaultBack:{title:"CRM",state:"crm.index"}}).state("crm.opportunityView",{url:"/opportunityview/:oid",talkingDataLabel:"CRM-商机-详情页",cache:!1,views:{crm:{templateUrl:"templates/crm/opportunity-view.html",controller:"CRMOpportunityViewCtrl"}}}).state("crm.addOpportunity",{url:"/addopportunity",talkingDataLabel:"CRM-商机-添加页",params:{client:null},cache:!1,views:{crm:{templateUrl:"templates/crm/opportunity-form.html",controller:"CRMAddOpportunityCtrl"}},defaultBack:{title:"商机",state:"crm.opportunity"}}).state("crm.editOpportunity",{url:"/editopportunity/:oid",talkingDataLabel:"CRM-商机-编辑页",cache:!1,views:{crm:{templateUrl:"templates/crm/opportunity-form.html",controller:"CRMEditOpportunityCtrl"}},defaultBack:{title:"商机",state:"crm.opportunity"}}).state("crm.event",{url:"/event",talkingDataLabel:"CRM-事件首页",views:{crm:{templateUrl:"templates/crm/event.html",controller:"CRMEventCtrl"}},defaultBack:{title:"CRM",state:"crm.index"}}).state("crm.addEvent",{url:"/addevent",talkingDataLabel:"CRM-事件-添加页",cache:!1,params:{client:null,opportunity:null,contact:null},views:{crm:{templateUrl:"templates/crm/event-form.html",controller:"CRMAddEventCtrl"}},defaultBack:{title:"事件",state:"crm.event"}}).state("crm.editEvent",{url:"/editevent/:eventid",talkingDataLabel:"CRM-事件-编辑页",cache:!1,views:{crm:{templateUrl:"templates/crm/event-form.html",controller:"CRMEditEventCtrl"}},defaultBack:{title:"事件",state:"crm.event"}}).state("crm.eventView",{url:"/eventview/:eventid",talkingDataLabel:"CRM-事件-详情页",cache:!1,views:{crm:{templateUrl:"templates/crm/event-view.html",controller:"CRMEventViewCtrl"}}})}]),angular.module("crm.services",[]).constant("CRM_REPORT_TIMETYPES",[{text:"本月",type:5},{text:"上月",type:6},{text:"本周",type:3},{text:"上周",type:4}]).constant("CRM_CONTACT_EXTEND",{phone:"电话",email:"邮箱",mobile:"手机",address:"地址",weibo:"微博",qq:"QQ",weixin:"微信"}).factory("CRM",["$http","Settings","Utils",function(t,e,n){return{tagList:function(t){return n.postJsonData(e.hostUrl+"?r=crm/api/taglist",t)},getReport:function(n){return t.post(e.hostUrl+"?r=crm/api/getsalereport",n)},getTarget:function(n){return t.post(e.hostUrl+"?r=crm/target/gettarget",n)},getOppSurvey:function(n){return t.post(e.hostUrl+"?r=crm/api/getoppsurvey",n)}}}]).factory("CRMContact",["$http","Utils","Settings","CRM",function(t,e,n,i){var r={avatar:function(t){var i=new FormData;return i.append("Filedata",t),e.postFormData(n.hostUrl+"?r=crm/api/contactavatar",i)},list:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactlist",t)},create:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactadd",t)},update:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactedit",t)},view:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactdetail",t)},remove:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactremove",t)},tagList:function(){return i.tagList({module:"contact"})},select:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactselect",t)},related:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/contactrelated",t)}};return r}]).factory("CRMClient",["$http","Utils","Settings","CRM",function(t,e,n,i){var r={tagList:function(){return i.tagList({module:"client"})},list:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/clientlist",t)},create:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/clientadd",t)},update:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/clientedit",t)},view:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/clientdetail",t)},remove:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/clientremove",t)},select:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/clientselect",t)}};return r}]).factory("CRMOpportunity",["$http","Utils","Settings","CRM",function(t,e,n,i){var r={tagList:function(){return i.tagList({module:"opportunity"})},list:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/opplist",t)},create:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/oppadd",t)},update:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/oppedit",t)},view:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/oppdetail",t)},remove:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/oppremove",t)},select:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/oppselect",t)}};return r}]).factory("CRMEvent",["$http","Utils","Settings","CRM",function(t,e,n,i){var r={tagList:function(){return i.tagList({module:"event"})},list:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/eventlist",t)},create:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/eventadd",t)},update:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/eventedit",t)},view:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/eventdetail",t)},remove:function(t){return e.postJsonData(n.hostUrl+"?r=crm/api/eventremove",t)}};return r}]).factory("CRMUtils",["$rootScope","$window","$ionicHistory","$ionicLoading","$ionicModal","$ionicViewSwitcher","dateFilter","mapFilter","Utils","IbPopup","CRMContact","CRMClient","CRMOpportunity","CRMEvent",function(t,e,n,i,r,o,a,s,c,l,u,d,f,p){return{buildContactFormData:function(t){return angular.extend({},t,{birthday:a(t.birthday,"yyyy-MM-dd"),cid:t.client.cid,client:null})},wrapRemovePromise:function(t,r){i.show(),t.success(function(t){t.isSuccess?n.clearCache([r]).then(function(){o.nextDirection("back"),e.history.go(-2)}):l.alert({title:t.msg})})["finally"](i.hide)},confirmRemoveContact:function(t){var e=this;l.confirm({title:"确定要删除当前联系人？"}).then(function(n){n&&e.wrapRemovePromise(u.remove(t),"crm.contact")})},confirmRemoveClient:function(t){var e=this;return l.confirm({title:"确定要删除当前客户？"}).then(function(n){n&&e.wrapRemovePromise(d.remove(t),"crm.client")})},confirmRemoveOpportunity:function(t){var e=this;return l.confirm({title:"确定要删除当前商机？"}).then(function(n){n&&e.wrapRemovePromise(f.remove(t),"crm.opportunity")})},confirmRemoveEvent:function(t){var e=this;return l.confirm({title:"确定要删除当前事件？"}).then(function(n){n&&e.wrapRemovePromise(p.remove(t),"crm.event")})},buildOpportunityFormData:function(t){return angular.extend({},t,{createtime:a(t.createtime,"yyyy-MM-dd HH:mm:ss"),expectendtime:a(t.expectendtime,"yyyy-MM-dd HH:mm:ss")})},openClientModal:function(e){function n(){d.select().success(function(t){t.isSuccess&&(i.clientScope.clients=t.data,i.clientScope.clients.forEach(function(t){t.firstLetter=t.firstCase.charAt(0).toUpperCase()}))})}var i=this,o=this.clientScope;return e=e||{},o?(o.cid=e.cid,o.opts=e,n(),this.clientScope.modal.show()):(o=this.clientScope=t.$new(!0),o.opts=e,void r.fromTemplateUrl("templates/crm/select-client.html",{scope:o}).then(function(e){n(),e.show(),i.clientScope.cid=o.opts.cid,i.clientScope.select=function(t){o.opts.callback&&o.opts.callback(t),e.hide()},i.clientScope.modal=e,i.clientScope.$on("$destroy",e.remove.bind(e)),t.$on("$stateChangeSuccess",e.hide.bind(e))}))},openOpportunityModal:function(e){function n(){f.select(e.params).success(function(t){t.isSuccess&&(i.opps=t.data)})}var i=this.oppScope;return e=e||{},i?(i.selected=e.selected,i.opts=e,n(),i.modal.show()):(i=this.oppScope=t.$new(!0),i.opts=e,void r.fromTemplateUrl("templates/crm/select-opportunity.html",{scope:i}).then(function(e){n(),e.show(),i.selected=i.opts.selected,i.select=function(t){i.opts.callback&&i.opts.callback(t),e.hide()},i.modal=e,i.$on("$destroy",e.remove.bind(e)),t.$on("$stateChangeSuccess",e.hide.bind(e))}))},openContactModal:function(e){function n(){u.select(i.opts.params).success(function(t){t.isSuccess&&(i.contacts=t.data.list,i.restoreSelected(i.opts.selected))})}var i=this.contactScope;return e=e||{},i?(i.opts=e,n(),i.modal.show()):(i=this.contactScope=t.$new(!0),i.opts=e,i.getSelected=function(){return this.contacts&&this.contacts.length?this.contacts.filter(function(t){return t.checked}):[]},i.restoreSelected=function(t){i.contacts&&i.contacts.length&&(t&&t.length?i.contacts.forEach(function(e){t.indexOf(e.contactid)!==-1&&(e.checked=!0)}):i.contacts.forEach(function(t){delete t.checked}))},i.save=function(){i.opts.callback&&i.opts.callback(i.getSelected()),i.modal.hide()},void r.fromTemplateUrl("templates/crm/select-contact.html",{scope:i}).then(function(e){i.modal=e,i.$on("$destroy",e.remove.bind(e)),t.$on("$stateChangeSuccess",e.hide.bind(e)),n(),e.show()}))},openAttachModal:function(t){return t.__attachOpts=t.__attachOpts||{},t.__attachOpts=angular.extend({newEvent:!0,newOpp:!0,newContact:!0,attachContact:!0},t.__attachOpts),t.clientAttachModal?t.clientAttachModal.show():void r.fromTemplateUrl("templates/crm/attach-modal.html",{scope:t,animation:"fade-in"}).then(function(e){e.hideDelay=1,e.show(),t.clientAttachModal=e,t.$on("$ionicView.leave",e.hide.bind(e)),t.$on("$destroy",e.remove.bind(e))})},selectContactToClient:function(t,e,n){this.openContactModal({selected:e,params:{type:"client"},callback:function(e){i.show(),u.related({type:"client",cid:t,contactid:s(e,"contactid")}).success(n).success(c.serverWarning)["finally"](i.hide)}})},initTagsToForm:function(t,e){t.tags=t.tags||{},angular.forEach(e,function(e){t.tags[e.groupid]||(t.tags[e.groupid]=e.taglist[0].tagid)})},setTagsToForm:function(t,e){return t&&e&&e.length&&(t.tags={},angular.forEach(e,function(e){t.tags[e.groupid]=e.tag.tagid})),t},formValidateError:function(t){t.isSuccess||(t.data&&t.data.error?l.alert({title:s(t.data.error).join("<br>")}):l.alert({title:t.msg}))}}}]).filter("groupAndOrder",["groupByFilter",function(t){return function(e,n,i){var r=[];if(e&&e.length){var o=t(e,n);r=Object.keys(o),r.sort(function(t,e){return(i?e>t:t>e)?1:-1}),r.grouped=o}return r}}]).filter("mapMultiply",function(){return function(t,e){return e=e||10,t.map(function(t){return t*e})}}).directive("crmContactItem",function(){return{restrict:"E",scope:{mode:"@",onRemove:"&",contact:"="},templateUrl:"templates/crm/contact-item.html",replace:!0,link:angular.noop}}).directive("crmEventItem",function(){return{restrict:"E",replace:!0,scope:{ev:"="},templateUrl:"templates/crm/event-item.html",transclude:!0,link:angular.noop}}).directive("crmOppItem",function(){return{restrict:"E",replace:!0,scope:{opp:"="},templateUrl:"templates/crm/opportunity-item.html",transclude:!0,link:angular.noop}}).directive("clock",["$timeout",function(t){return{restrict:"A",link:function(t,e,n){var i,r=e[0],o=n.$attr;t.$watch("percent",function(t){t&&(i="plus"===o.plus?0!==t?1.8*t:0:0===t?-45:1.8*t-45,["transform","OTransform","msTransform","MozTransform","webkitTransform"].forEach(function(t){r.style[t]="rotate("+i+"deg)"}))})}}}]).directive("searchTabBar",["SearchModal",function(t){return{templateUrl:"templates/crm/search-tab-bar.html",scope:{tabs:"=searchTabBar",searchModal:"=",onTab:"&"},compile:function(t,e){return t.addClass("search-tab-bar"),function(t,e,n){t.tabTo=function(e){t.activeIndex=e,t.onTab({$tab:t.tabs[e]})},t.tabTo(0)}}}}]).directive("crmFilter",["$compile","$ionicTemplateLoader","Utils",function(t,e,n){return{scope:{filterGroups:"=",onSelect:"="},replace:!0,templateUrl:"templates/crm/crm-filter-menu.html",compile:function(t){return function(t,e,n,i){t.filterShown=!1,t.selectFilterItem=function(e,n){n.selected=n.items.indexOf(e),t.onSelect(e,n)}}}}}]).directive("crmUser",function(){return{template:'<span class="crm-user"> <img avatar="{{ uid | avatar | defaultAvatar }}"> <span>{{ uid | userInfo:\'realname\' }}</span> </span>',replace:!0,scope:{uid:"@"},link:angular.noop}}).directive("crmTagsSection",function(){return{template:'<span class="crm-tags-section"> <i class="crm-icon-tag"></i> <span ng-repeat="tag in tags">{{ tag.tag.name }}{{ $last ? \'\' : \'；\' }}</span> </span>',replace:!0,scope:{tags:"="},link:angular.noop}}).directive("crmEmptyTip",function(){return{template:'<div class="list-empty-tip"> <i class="news-icon-empty"></i> <p class="margin-top coyness">{{ text }}</p> </div>',replace:!0,link:function(t,e,n){t.text=n.text||"这里空空如也"}}}).directive("processbar",function(){return{template:'<div class="processbar"> <div class="processbar-fill" style="width: {{ percent || 0 }}%; background-color: {{ color || \'red\' }}"></div></div>',replace:!0,scope:{value:"@",color:"@"},link:function(t){t.$watch("value",function(e){e=isNaN(+e)?0:+e,t.percent=Math.min(100,Math.max(e,0))})}}}).directive("ngCurrency",["$filter","$locale",function(t,e){return{require:"ngModel",link:function(n,i,r,o){function a(){if(w){var t;if(o.$options&&"blur"===o.$options.updateOn){t=o.$viewValue;for(var e=o.$parsers.length-1;e>=0;e--)t=o.$parsers[e](t)}else t=o.$$rawModelValue;for(var e=o.$formatters.length-1;e>=0;e--)t=o.$formatters[e](t);o.$viewValue=t,o.$render()}}function s(){if(o.$validate(),w){var t=c(o.$$rawModelValue);t!==o.$$rawModelValue&&(o.$setViewValue(t.toFixed(y)),o.$commitViewValue(),a())}}function c(t){return p&&(void 0!==h&&t>h?t=h:void 0!==m&&t<m&&(t=m)),t}function l(t){return RegExp("\\d|\\-|\\"+t,"g")}function u(t){return RegExp("\\-{0,1}((\\"+t+")|([0-9]{1,}\\"+t+"?))&?[0-9]{0,"+y+"}","g")}function d(n){n=String(n);var i=e.NUMBER_FORMATS.DECIMAL_SEP,r=null;n.indexOf(e.NUMBER_FORMATS.DECIMAL_SEP)===-1&&n.indexOf(".")!==-1&&y>0&&(i=".");var o=t("currency")("-1",f(),y),a=RegExp("[0-9."+e.NUMBER_FORMATS.DECIMAL_SEP+e.NUMBER_FORMATS.GROUP_SEP+"]+"),s=o.replace(a.exec(o),""),c=n.replace(a.exec(n),"");return s===c&&(n="-"+a.exec(n)),RegExp("^-[\\s]*$","g").test(n)&&(n="-0"),l(i).test(n)&&(r=n.match(l(i)).join("").match(u(i)),r=r?r[0].replace(i,"."):null),r}function f(){return void 0===g?e.NUMBER_FORMATS.CURRENCY_SYM:g}var p,m,h,g,v,w=!0,y=2;r.$observe("ngCurrency",function(t){w="false"!==t,w?a():(o.$viewValue=o.$$rawModelValue,o.$render())}),r.$observe("hardCap",function(t){p="true"===t,s()}),r.$observe("min",function(t){m=t?Number(t):void 0,s()}),r.$observe("max",function(t){h=t?Number(t):void 0,s()}),r.$observe("currencySymbol",function(t){g=t,a()}),r.$observe("ngRequired",function(t){v=t,s()}),r.$observe("fraction",function(t){y=t||2,a(),s()}),o.$parsers.push(function(t){return w&&[void 0,null,""].indexOf(t)===-1?(t=d(t),t=c(Number(t))):t}),o.$formatters.push(function(e){return w&&[void 0,null,""].indexOf(e)===-1?t("currency")(e,f(),y):e}),o.$validators.min=function(t){return!(v||[void 0,null,""].indexOf(t)===-1&&!isNaN(t))||(!w||[void 0,null].indexOf(m)!==-1||isNaN(m)||t>=m)},o.$validators.max=function(t){return!(v||[void 0,null,""].indexOf(t)===-1&&!isNaN(t))||(!w||[void 0,null].indexOf(h)!==-1||isNaN(h)||t<=h)},o.$validators.fraction=function(t){return!w||!t||!isNaN(t)},n.$on("currencyRedraw",function(){s(),a()}),i.bind("focus",function(){if(w){var n=new RegExp("\\"+e.NUMBER_FORMATS.GROUP_SEP,"g"),r=[void 0,null,""].indexOf(o.$$rawModelValue)===-1?t("number")(o.$$rawModelValue,y).replace(n,""):o.$$rawModelValue;o.$viewValue!==r&&(o.$viewValue=r,o.$render(),i.triggerHandler("focus"))}}),i.bind("blur",a)}}}]).filter("crmFilterSelectedText",function(){return function(t){var e=t.filter(function(t){return 0!==t.selected});return e.map(function(t){var e=t.items[t.selected].text;return"创建时间"===t.groupName?e+="创建":"跟进时间"===t.groupName&&(e+="跟进"),e}).join(" ● ")}}).filter("crmContactExtendText",["CRM_CONTACT_EXTEND",function(t){return function(e){return t[e]||""}}]),angular.module("diary.controllers",[]).controller("DiaryIndexCtrl",["$scope","$ionicModal","$ionicLoading","$state","User","Utils","Diary",function(t,e,n,i,r,o,a){n.show(),r.getAuthority().success(function(i){i.isSuccess&&(i.data.diary?t.openSettingModel=function(){e.fromTemplateUrl("templates/diary/diary-setting.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.settingModel=e,t.settingModel.show(),t.formData={defaultShareList:"",direct:0,attentionList:""},a.setting().success(function(e){e.isSuccess&&(t.dashboardConfig=e.dashboardConfig,angular.extend(t.formData,e.data,{direct:+e.data.direct}))}),t.submit=function(){n.show(),a.savesetting({defaultShareList:r.addPrefix(t.formData.defaultShareList),direct:t.formData.direct,attentionList:r.addPrefix(t.formData.attentionList)}).success(function(e){e.isSuccess===!0&&t.settingModel.hide()})["finally"](n.hide)}})}:o.promptNoPermission())})["finally"](n.hide)}]).controller("DiaryPersionalCtrl",["$scope","$ionicListDelegate","$ionicScrollDelegate","$ionicLoading","dateFilter","Utils","IbPopup","Diary",function(t,e,n,i,r,o,a,s){t.list=[],t.loadMore=function(){return s.mine({page:t.pages?t.pages.page+2:1}).success(function(e){e.isSuccess&&(n.resize(),t.list=t.list.concat(e.data),t.pages=e.pages)})},t.loadMore(),t.refresh=function(){t.list.length=0,delete t.pages,t.loadMore()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.groupByYearMonth=function(t){return r(1e3*t.diarytime,"yyyy年M月")},t.remove=function(n){a.confirm({title:"确认删除日志？"}).then(function(r){r&&(e.closeOptionButtons(),i.show(),s.remove(n.diaryid).success(function(e){e.isSuccess?o.eliminate(t.list,n):a.alert({title:e.msg})})["finally"](i.hide))})}}]).controller("DiaryReviewCtrl",["$scope","$state","$stateParams","$filter","$ionicHistory","$ionicScrollDelegate","User","dateFilter","Diary",function(t,e,n,i,r,o,a,s,c){t.list=[],t.loadMore=function(){return c.allsubs({page:t.pages?t.pages.page+2:1}).success(function(e){if(e.isSuccess){if(o.resize(),!e.diary||!e.diary.length)return;angular.forEach(e.diary,function(t){t.isfavor=e.attentionList.indexOf(t.uid)!==-1}),t.list=t.list.concat(e.diary),t.pages=e.pages}})},t.loadMore(),t.refresh=function(){t.list.length=0,delete t.pages,t.loadMore()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.groupByTime=function(t){return s(1e3*t.diarytime,"EEEE MM-dd")},t.isToday=function(t){return t==s(new Date,"EEEE MM-dd")}}]).controller("DiaryFollowCtrl",["$scope","$state","$stateParams","$filter","$ionicHistory","$ionicScrollDelegate","User","dateFilter","Diary",function(t,e,n,i,r,o,a,s,c){t.list=[],t.loadMore=function(){return c.other({page:t.pages?t.pages.page+2:1}).success(function(e){e.isSuccess&&(o.resize(),t.list=t.list.concat(e.data),t.pages=e.pages)})},t.loadMore(),t.refresh=function(){t.list.length=0,delete t.pages,t.loadMore()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.groupByTime=function(t){return s(1e3*t.diarytime,"EEEE MM-dd")},t.isToday=function(t){return t==s(new Date,"EEEE MM-dd")}}]).controller("DiaryDetailCtrl",["$scope","$rootScope","$state","$stateParams","$ionicLoading","$ionicActionSheet","$ionicModal","$ionicScrollDelegate","Utils","User","IbPopup","Diary","Settings","userInfoFilter",function(t,e,n,i,r,o,a,s,c,l,u,d,f,p){function m(e){r.show(),d.show(e).success(function(e){t.diary=e.diary;var n=/<img[^>]+src=['"](\/data\/ueditor\/image[^'"]+)['"]+/g;e.diary.content=e.diary.content.replace(n,function(t,e){return t.replace(e,f.hostUrl+e)}),t.today=t.diary.diarytime,t.nextDay=t.diary.nextDiarytime,t.planned=e.data.originalPlanList,t.unplanned=e.data.outsidePlanList,t.plans=e.data.tomorrowPlanList,t.originalPlan=e.data.originalPlanList,t.next=e.prevAndNextPK.nextPK,t.prev=e.prevAndNextPK.prevPK,t.attach=e.attach,t.readers=t.diary.readeruid?t.diary.readeruid.split(","):[],t.editable=t.diary.uid==l.uid,t.isShare=e.isShare,t.isSup=e.isSup,t.dashboardConfig=e.dashboardConfig,t.comment={},t.comment.stamps=e.allStamps,t.commentList=e.list.map(function(t){return angular.extend({},t,{realname:t.user_info.realname,avatar:t.user_info.avatar_middle})}),t.stampUrl=e.stampUrl})["finally"](r.hide)}t.toDiary=function(t){m(t),s.scrollTop()},t.showMore=function(){t.hideMore=o.show({buttons:[{text:"编辑"}],buttonClicked:function(){return n.go("diary.edit",{id:t.diary.diaryid}),!0},destructiveText:"删除",cancelText:"取消",destructiveButtonClicked:function(){return u.confirm({title:"确认删除日志？"}).then(function(e){e&&(r.show(),d.remove(t.diary.diaryid).success(function(t){t.isSuccess?c.clearStateCacheAndGo("diary.personal"):u.alert({title:t.msg})})["finally"](r.hide))}),!0}})},t.showCommentModal=function(e,n){a.fromTemplateUrl("templates/diary/diary-comment.html",{scope:t,animation:"slide-in-up"}).then(function(i){t.commentModel=i,t.commentModel.show(),"reply"===e&&(t.comment.content=n.touid?"回复 @"+p(n.uid,"realname")+" : ":""),i.scope.commentType=e}),t.comment.submitting=!1,t.comment.submit=function(){var i=this,o={content:this.content,type:e};return i.stamp&&(o.stamp=i.stamp.id),"comment"===e?o.rowid=t.diary.diaryid:"reply"===e&&(o.tocid=n.cid,o.rowid="0"===n.tocid?n.cid:n.rowid),i.submitting=!0,d.addComment(o).success(function(e){i.content="",i.stamp&&(t.stampUrl=i.stamp.stamp),t.commentModel.hide(),r.show(),d.get(t.diary.diaryid).success(function(e){t.commentList=e.list.map(function(t){return angular.extend({},t,{realname:t.user_info.realname,avatar:t.user_info.avatar_middle})})})["finally"](r.hide)})["finally"](function(){i.submitting=!1})}},m(i.id)}]).controller("DiaryFormCtrl",["$scope","$ionicLoading","$ionicModal","IbPopup","Diary","DiaryUtils","SCHEDULE",function(t,e,n,i,r,o,a){t.formData={originalPlan:[],planOutside:[],plan:[],uploadImagesPreviews:[],attachmentid:"",diaryContent:"",todayDate:"",plantime:""},r.setting().success(function(e){
e.isSuccess&&(t.formData.shareuid=e.data.defaultShareList)}),t.isSubmitting=!1,t.SCHEDULE=a,t.addUnplanned=function(){t.formData.planOutside.push({content:"",schedule:"0"})},t.removeUnplanned=function(e){t.formData.planOutside.splice(e,1)},t.addPlan=function(){t.formData.plan.push({content:""})},t.removePlan=function(e){t.formData.plan.splice(e,1)},t.allowSubmit=function(){var e=t.formData;return(e.planOutside[0]&&e.planOutside[0].content||t.originalPlanList&&t.originalPlanList.length)&&e.plan[0]&&e.plan[0].content&&e.diaryContent},t.planfromschedule=function(n){e.show(),r.planfromschedule(n).success(function(e){e.data.length>0?t.formData.planOutside=t.formData.planOutside.concat(e.data.map(function(t){return{content:t.subject,schedule:"0"}})):i.alert({title:"抱歉，你今天没有日程计划！"})})["finally"](e.hide)},t.selectedStartDate=function(){o.selectedStartDate(t)},t.selectedEndDate=function(){o.selectedEndDate(t)},t.setRemind=function(e){o.setRemind(t,e)},t.delRemind=function(t){o.delRemind(t)},t.openSharingModel=function(){n.fromTemplateUrl("templates/diary/diary-sharing.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.sharingModel=e,t.sharingModel.show()})}}]).controller("DiaryCreateCtrl",["$scope","$controller","$state","$ionicLoading","$ionicHistory","dateFilter","IbPopup","Utils","Diary","DiaryUtils","SCHEDULE",function(t,e,n,i,r,o,a,s,c,l,u){e("DiaryFormCtrl",{$scope:t}),t.submit=function(){var e="";0!=t.formData.plan.length&&t.formData.plan[0].content||(e="至少填写一条工作计划"),t.formData.diaryContent||(e="请填写工作总结");var n=t.formData.planOutside.length,i=t.formData.originalPlan;n<=0&&angular.equals({},i)?e="至少填写一条工作记录":!angular.equals({},i)||""!=t.formData.planOutside[0].content&&void 0!=t.formData.planOutside[0].content||(e="至少填写一条工作记录"),e?a.alert({title:e}):c.create(l.handleFormData(t.formData)).success(function(){s.clearStateCacheAndGo("diary.personal")})["finally"](function(){t.isSubmitting=!1})},t.$watch("formData.todayDate",function(e,r){e&&(t.formData.plantime=o(+new Date(e)+864e5,"yyyy-MM-dd"),i.show(),c.add(e).success(function(e){e.isSuccess?(t.isInstallCalendar=e.isInstallCalendar,t.workStart=e.workStart,t.dashboardConfig=e.dashboardConfig,t.originalPlanList=e.data.originalPlanList,t.formData.originalPlan={},angular.forEach(e.data.originalPlanList,function(e){t.formData.originalPlan[e.recordid]=e.schedule}),t.formData.plan=[{}],t.formData.planOutside=[{schedule:"10"}]):a.alert({title:e.msg}).then(function(){n.go("diary.index")})})["finally"](i.hide))}),t.formData.todayDate=o(new Date,"yyyy-MM-dd")}]).controller("DiaryEditCtrl",["$scope","$controller","$state","$stateParams","$ionicLoading","$ionicHistory","Utils","User","IbPopup","Diary","DiaryUtils","SCHEDULE",function(t,e,n,i,r,o,a,s,c,l,u,d){e("DiaryFormCtrl",{$scope:t}),t.selectedStartDate=t.selectedEndDate=angular.noop,t.submit=function(){var e="";0!=t.formData.plan.length&&t.formData.plan[0].content||(e="至少填写一条工作计划"),t.formData.diaryContent||(e="请填写工作总结");var n=t.formData.planOutside.length,i=t.formData.originalPlan;n<=0&&angular.equals({},i)?e="至少填写一条工作记录":angular.equals({},i)&&""==t.formData.planOutside[0].content&&(e="至少填写一条工作记录"),e?c.alert({title:e}):l.update(u.handleFormData(t.formData)).success(function(){a.clearStateCacheAndGo("diary.personal")})["finally"](function(){t.isSubmitting=!1})},r.show(),l.edit(i.id).success(function(e){if(e.isSuccess){t.isInstallCalendar=e.isInstallCalendar,t.workStart=e.workStart,t.dashboardConfig=e.dashboardConfig,t.originalPlanList=e.data.originalPlanList,t.formData.originalPlan={},angular.forEach(e.data.originalPlanList,function(e){t.formData.originalPlan[e.recordid]=e.schedule}),t.formData.planOutside=e.data.outsidePlanList,t.formData.plan=e.data.tomorrowPlanList,t.formData.id=e.diary.diaryid,t.formData.diaryContent=e.diary.content,t.formData.shareuid=s.removePrefix(e.diary.shareuid);var n=e.diary.diarytime,i=e.diary.nextDiarytime;t.formData.todayDate=n.year+"-"+n.month+"-"+n.day,t.todayWeekday=n.weekday,t.formData.plantime=i.year+"-"+i.month+"-"+i.day,t.tomorrowWeekday=i.weekday}else c.alert({title:e.msg}).then(function(){o.goBack()})})["finally"](r.hide)}]).controller("DiaryUnderingCtrl",["$scope","$stateParams","$ionicHistory","$ionicScrollDelegate","$state","userInfoFilter","dateFilter","Diary",function(t,e,n,i,r,o,a,s){t.list=[],t.title=o(e.id,"realname"),t.loadMore=function(){return s.personal({uid:e.id,page:t.pages?t.pages.page+2:1}).success(function(e){e.isSuccess&&(i.resize(),t.list=t.list.concat(e.diary),t.pages=e.pages,t.isattention=e.isattention,t.dashboardConfig=e.dashboardConfig)})},t.loadMore(),t.refresh=function(){t.list.length=0,delete t.pages,t.loadMore()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.groupByMonth=function(t){return a(1e3*t.diarytime,"M月")},t.attention=function(){s.attention(e.id).success(function(){t.isattention=1})},t.unattention=function(){s.unattention(e.id).success(function(){t.isattention=0})}}]),angular.module("diary",["ionic","diary.controllers","diary.services","diary.filters"]).run(["Apps",function(t){t.install({name:"diary",title:"工作日志",route:"#/diary",state:"diary.index",icon:"img/modicon/diary.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/diary","/diary/index"),t.state("diary",{url:"/diary","abstract":!0,template:'<ion-nav-view name="diary"></ion-nav-view>',resolve:n.resolve}).state("diary.index",{url:"/index",talkingDataLabel:"工作日志-主页",views:{diary:{templateUrl:"templates/diary/diary-index.html",controller:"DiaryIndexCtrl"}}}).state("diary.personal",{url:"/personal",talkingDataLabel:"工作日志-我的日志",views:{diary:{templateUrl:"templates/diary/diary-personal.html",controller:"DiaryPersionalCtrl"}}}).state("diary.create",{url:"/create",talkingDataLabel:"工作日志-写日志",cache:!1,views:{diary:{templateUrl:"templates/diary/diary-create.html",controller:"DiaryCreateCtrl"}}}).state("diary.edit",{url:"/edit/:id",talkingDataLabel:"工作日志-编辑日志",cache:!1,views:{diary:{templateUrl:"templates/diary/diary-edit.html",controller:"DiaryEditCtrl"}}}).state("diary.detail",{url:"/detail/:id",talkingDataLabel:"工作日志-查看日志",cache:!1,views:{diary:{templateUrl:"templates/diary/diary-detail.html",controller:"DiaryDetailCtrl"}}}).state("diary.review",{url:"/review?date",talkingDataLabel:"工作日志-点评下属",views:{diary:{templateUrl:"templates/diary/diary-review.html",controller:"DiaryReviewCtrl"}}}).state("diary.follow",{url:"/follow?date",talkingDataLabel:"工作日志-交流日志",views:{diary:{templateUrl:"templates/diary/diary-follow.html",controller:"DiaryFollowCtrl"}}}).state("diary.underling",{url:"/underling/:id",talkingDataLabel:"工作日志-下属日志",views:{diary:{templateUrl:"templates/diary/diary-underling.html",controller:"DiaryUnderingCtrl"}}})}]),angular.module("diary.filters",[]).filter("diaryPercentage",function(){return function(t){return 10*t+"%"}}).filter("numToHHmm",function(){function t(t){return t>=10?""+t:"0"+t}function e(e){var n=Math.floor(+e),i=Math.floor(+e%1*60);return t(n)+":"+t(i)}return e}).filter("diaryTimeRemind",["numToHHmmFilter",function(t){return function(e){if(""!==e){var n=e.split(",");return t(n[0])+"-"+t(n[1])}}}]),angular.module("diary.services",[]).constant("SCHEDULE",[{value:"0",percent:"0%"},{value:"1",percent:"10%"},{value:"2",percent:"20%"},{value:"3",percent:"30%"},{value:"4",percent:"40%"},{value:"5",percent:"50%"},{value:"6",percent:"60%"},{value:"7",percent:"70%"},{value:"8",percent:"80%"},{value:"9",percent:"90%"},{value:"10",percent:"100%"}]).factory("Diary",["$http","Settings",function(t,e){function n(e){return t.post(a+"/save",e)}function i(e){return t.post(a+"/del",{diaryids:e})}function r(e){return t.get(a+"/show",{params:{id:e}})}function o(e){return t.post(a+"/update",e)}var a=e.rootUrl+"/diary";return{create:n,get:r,update:o,remove:i,addComment:function(e){return e=angular.extend({from:1},e),t.post(a+"/addComment",e)},mine:function(e){return t.get(a,{params:e})},allsubs:function(e){return t.get(a+"/allsubs",{params:e})},other:function(e){return t.get(a+"/other",{params:e})},show:function(e){return t.get(a+"/show",{params:{id:e}})},add:function(e){return t.get(a+"/add"+(e?"&diaryDate="+e:""))},edit:function(e){return t.get(a+"/edit&diaryid="+e)},personal:function(e){return t.get(a+"/personal",{params:e})},attention:function(e){return t.get(a+"/attention",{params:{auid:e}})},unattention:function(e){return t.get(a+"/unattention",{params:{auid:e}})},planfromschedule:function(e){return t.get(a+"/planfromschedule",{params:{todayDate:e}})},setting:function(){return t.get(a+"/setting")},savesetting:function(e){return t.post(a+"/savesetting",e)}}}]).factory("DiaryUtils",["$filter","$ionicPopup","$timeout","$state","dateFilter","IbPopup","User",function(t,e,n,i,r,o,a){return{handleFormData:function(e){return angular.extend({},e,{plantime:t("date")(e.plantime,"yyyy-MM-dd"),shareuid:a.addPrefix(e.shareuid)})},setRemind:function(t,i){function r(n){e.show({template:'<select class="col" ng-model="remindConf.continueTime" ng-options="(\'持续 \' + item + \' 小时\') for item in remindConf.getContinueTimes() track by item"></select>',title:"持续时间",scope:t,buttons:[{text:"取消"},{text:"确认",type:"button-positive",onTap:function(e){e&&(n.timeremind=t.remindConf.start+","+(t.remindConf.start+ +t.remindConf.continueTime))}}]})}t.remindConf={start:t.workStart.start,continueTime:.5,getStartHours:function(){for(var e=[],n=t.workStart.start;n<t.workStart.end;n+=.5)e.push(n);return e},getContinueTimes:function(){for(var e=[],n=.5;n<=t.workStart.end-this.start;n+=.5)e.push(n);return e}},e.show({template:'<select class="col" ng-model="remindConf.start" ng-options="(item|numToHHmm) for item in remindConf.getStartHours() track by item"></select>',title:"开始时间",scope:t,buttons:[{text:"取消"},{text:"确认",type:"button-positive",onTap:function(t){t&&n(function(){r(i)},0)}}]})},delRemind:function(t){t.timeremind=""},selectedStartDate:function(t){e.show({template:'<div class="diary-select"><input type="date" class="diary-item" ng-model="formData.startDate"  data-tap-disabled ="true" required ></div>',title:"选择日期",scope:t,buttons:[{text:"取消"},{text:"确认",type:"button-positive",onTap:function(e){var i=t.formData.startDate,a=new Date;if(i)return n(function(){i>a?o.alert({title:"抱歉，选中的日期没有日志且没有新建权限！"}):(t.formData.originalPlan="",t.formData.todayDate=r(i,"yyyy-MM-dd"),t.todayWeekday=r(i,"EEEE"))},0),!0}}]})},selectedEndDate:function(t){e.show({template:'<div class="diary-select"><input type="date" class="diary-item" ng-model="formData.endDate"  data-tap-disabled ="true" required ></div><div>{{date}}<div>',title:"选择日期",scope:t,buttons:[{text:"取消"},{text:"确认",type:"button-positive",onTap:function(e){var n=Date.parse(new Date(t.formData.endDate));n&&(t.formData.plantime=r(n,"yyyy-MM-dd"),t.tomorrowWeekday=r(n,"EEEE"))}}]})}}}]),angular.module("docs.controllers",[]).controller("DocsPublishedCtrl",["$scope","$state","Settings","DocsPublished",function(t,e,n,i){t.list=i,t.title="已发布",t.$root.hideTabs=!1,t.checkNoData=function(){return!t.list.docs.length&&!t.list.hasMore},t.open=function(t){e.go("docs.detail",{id:t.docid})},t.list.hasDocs()&&!t.list.params.search||t.list.fetch({catid:0,page:1,search:""},!0)}]).controller("DocsUnsignedCtrl",["$scope","$state","Settings","DocsUnsigned",function(t,e,n,i){t.list=i,t.title="未签收",t.$root.hideTabs=!1,t.checkNoData=function(){return!t.list.docs.length&&!t.list.hasMore},t.open=function(t){e.go("docs.unsignedDetail",{id:t.docid})},t.list.hasDocs()&&!t.list.params.search||t.list.fetch({catid:0,page:1,search:""},!0)}]).controller("DocsSignedCtrl",["$scope","$state","Settings","DocsSigned",function(t,e,n,i){t.list=i,t.title="已签收",t.$root.hideTabs=!1,t.checkNoData=function(){return!t.list.docs.length&&!t.list.hasMore},t.open=function(t){e.go("docs.signedDetail",{id:t.docid})},t.list.hasDocs()&&!t.list.params.search||t.list.fetch({catid:0,page:1,search:""},!0)}]).controller("DocsCategoryCtrl",["$scope","$state","$stateParams","DocsPublished",function(t,e,n,i){t.list=i,t.categorys=[],t.title="按分类",t.rootDir=!(n.cid&&0!=n.cid),t.checkNoData=function(){return!t.list.news.length&&!t.list.hasMore},t.list.fetch({catid:n.cid,page:1},!0).success(function(e){t.categorys=e.category})}]).controller("DocsDetailCtrl",["$scope","$sce","$filter","$stateParams","Docs",function(t,e,n,i,r){t.docs={},t.signing=!1,t.sign=function(e){t.signing=!0,r.sign(e).success(function(){t.signing=!1,t.docs.issign="1"}).error(function(){t.signing=!1})},r.get(i.id).success(function(i){t.docs=i.data,t.attach=i.attach,t.docs.content&&(t.docs.content=e.trustAsHtml(n("editorContent")(t.docs.content)))})}]),angular.module("docs",["ionic","docs.controllers","docs.services"]).run(["Apps",function(t){t.install({name:"docs",title:"公文",route:"#/docs",state:"docs.published",icon:"img/modicon/docs.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/docs","/docs/published"),t.state("docs",{url:"/docs","abstract":!0,templateUrl:"templates/docs/docs.html",resolve:n.resolve}).state("docs.published",{url:"/published",talkingDataLabel:"公文-已发布",views:{"docs-published":{templateUrl:"templates/docs/docs-list.html",controller:"DocsPublishedCtrl"}}}).state("docs.unsigned",{url:"/unsigned",talkingDataLabel:"公文-未签收",views:{"docs-unsigned":{templateUrl:"templates/docs/docs-list.html",controller:"DocsUnsignedCtrl"}}}).state("docs.signed",{url:"/signed",talkingDataLabel:"公文-已签收",views:{"docs-signed":{templateUrl:"templates/docs/docs-list.html",controller:"DocsSignedCtrl"}}}).state("docs.category",{url:"/category?cid",talkingDataLabel:"公文-按分类",views:{"docs-category":{templateUrl:"templates/docs/docs-category.html",controller:"DocsCategoryCtrl"}}}).state("docs.detail",{url:"/detail/:id",talkingDataLabel:"公文-查看公文",views:{"docs-published":{templateUrl:"templates/docs/docs-detail.html",controller:"DocsDetailCtrl"}}}).state("docs.unsignedDetail",{url:"/unsignedDetail/:id",talkingDataLabel:"公文-查看公文",views:{"docs-unsigned":{templateUrl:"templates/docs/docs-detail.html",controller:"DocsDetailCtrl"}}}).state("docs.signedDetail",{url:"/signedDetail/:id",talkingDataLabel:"公文-查看公文",views:{"docs-signed":{templateUrl:"templates/docs/docs-detail.html",controller:"DocsDetailCtrl"}}}).state("docs.categoryDetail",{url:"/categoryDetail/:id",talkingDataLabel:"公文-查看公文",views:{"docs-category":{templateUrl:"templates/docs/docs-detail.html",controller:"DocsDetailCtrl"}}})}]),angular.module("news.filters",[]),angular.module("docs.services",[]).factory("Docs",["$http","$ionicLoading","Settings",function(t,e,n){var i=n.rootUrl+"/docs";return{get:function(n){return e.show(),t.get(i+"/show",{params:{id:n}}).success(e.hide).error(e.hide)},sign:function(e){return t.get(i+"/sign",{params:{docid:e}})}}}]).factory("DocsList",["$http","$ionicLoading","Settings","Utils",function(t,e,n,i){function r(t,e){this.url=t,this.options=e,this.hasMore=!0,this.docs=[],this.params={}}n.rootUrl+"/docs";return angular.extend(r.prototype,{fetch:function(n,i,r){var o=this;return i&&(this.docs=[],this.hasMore=!0),r===!1?this.params=n:angular.extend(this.params,n),e.show(),t.get(this.url,{params:this.params}).success(function(t){t.pages.page<t.pages.pageCount&&(o.docs=o.docs.concat(t.datas)),o.hasMore=t.pages.page<t.pages.pageCount-1}).success(e.hide).error(e.hide)},search:function(t){return this.fetch({page:1,search:t},!0)},loadMore:function(){return this.fetch({page:this.params.page+1})},hasDocs:function(){return!!this.docs.length}}),r}]).factory("DocsPublished",["DocsList","Settings",function(t,e){var n=new t(e.rootUrl+"/docs");return n}]).factory("DocsUnsigned",["DocsList","Settings",function(t,e){var n=new t(e.rootUrl+"/docs&type=nosign");return n}]).factory("DocsSigned",["DocsList","Settings",function(t,e){var n=new t(e.rootUrl+"/docs&type=sign");return n}]),angular.module("email.controllers",[]).controller("EmailIndexCtrl",["$ionicLoading","User","Utils",function(t,e,n){t.show(),e.getAuthority().success(function(t){t.isSuccess&&(t.data.email||n.promptNoPermission())})["finally"](t.hide)}]).controller("EmailListCtrl",["$scope","$rootScope","$state","$ionicLoading","$ionicActionSheet","Email",function(t,e,n,i,r,o){t.prop={},t.init=function(){t.list.hasMails()||t.list.refresh()},t.refresh=function(){t.prop.keyword="",t.list.refresh()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.remove=function(t){o.remove(t.emailid)},t.reply=function(t){return n.go("email.create",{id:t.emailid,type:"reply"}),!0},t.forward=function(t){return n.go("email.create",{id:t.emailid,type:"forward"}),!0},t.actionButtons=[{text:"转发",handler:function(e){return t.forward(e)}},{text:"回复",handler:function(e){return t.reply(e)}}],t.showMenu=function(e){t.hideMenu=r.show({titleText:"邮件操作",buttons:t.actionButtons,buttonClicked:function(t,n){return n.handler.call(null,e)},destructiveText:"删除",destructiveButtonClicked:function(){return t.remove(e),!0},cancelText:"取消"})},t.sref="email.detail({ id: mail.emailid })"}]).controller("EmailInboxCtrl",["$scope","$controller","Settings","EmailList","EmailInbox",function(t,e,n,i,r){e("EmailListCtrl",{$scope:t}),t.list=r,t.title="收件箱",t.init()}]).controller("EmailTodoCtrl",["$scope","$controller","EmailTodo",function(t,e,n){e("EmailListCtrl",{$scope:t}),t.list=n,t.title="待办邮件",t.init()}]).controller("EmailOutboxCtrl",["$scope","$rootScope","$controller","EmailOutbox","Email",function(t,e,n,i,r){n("EmailListCtrl",{$scope:t}),t.list=i,t.title="已发送",t.init(),t.sref="email.outboxDetail({ id: mail.emailid })",t.remove=function(t){r.removeCompletelyConfirm(function(){r.removeOutbox(t.emailid)})}}]).controller("EmailTrashCtrl",["$scope","$rootScope","$state","$controller","$ionicHistory","EmailTrash","Email",function(t,e,n,i,r,o,a){i("EmailListCtrl",{$scope:t}),t.list=o,t.title="已删除",t.init(),t.sref="email.trashDetail({ id: mail.emailid })",t.actionButtons[1]={text:"还原",handler:function(e){return t.recovery(e)}},t.remove=function(t){a.removeCompletelyConfirm(function(){a.removeCompletely(t.emailid)})},t.recovery=function(t){return a.recovery(t.emailid),r.clearCache(["email.inbox","email.todo","email.trash"]),!0}}]).controller("EmailDetailCtrl",["$scope","$rootScope","$state","$stateParams","$sce","$filter","$ionicHistory","$ionicLoading","Email","EmailUtils",function(t,e,n,i,r,o,a,s,c,l){s.show(),c.get(i.id).success(function(e){t.mail=e,t.mail.content&&(t.mail.content=r.trustAsHtml(o("editorContent")(t.mail.content)))})["finally"](s.hide),t.remove=function(){c.remove(t.mail.emailid).success(function(t){t.isSuccess&&l.goBackOrHome()})},t.toggleMark=function(){var e="1"!=t.mail.ismark;c.mark(t.mail.emailid,e).success(function(n){t.mail.ismark=+e+"",a.clearCache(["email.inbox","email.outbox","email.todo","email.trash"])})},t.reply=function(){n.go("email.create",{id:t.mail.emailid,type:"reply"})},t.replyAll=function(){n.go("email.create",{id:t.mail.emailid,type:"replyAll"})}}]).controller("EmailTrashDetailCtrl",["$scope","$controller","Email","EmailUtils",function(t,e,n,i){e("EmailDetailCtrl",{$scope:t}),t.remove=function(){n.removeCompletelyConfirm(function(){$ionicLoading.show(),n.removeCompletely(t.mail.emailid).success(function(t){t.isSuccess&&i.goBackOrHome()})["finally"]($ionicLoading.hide)})}}]).controller("EmailOutboxDetailCtrl",["$scope","$ionicLoading","$rootScope","$controller","$state","Email","EmailUtils",function(t,e,n,i,r,o,a){i("EmailDetailCtrl",{$scope:t}),t.remove=function(){o.removeCompletelyConfirm(function(){e.show(),o.removeOutbox(t.mail.emailid).success(function(t){t.isSuccess&&a.goBackOrHome()})["finally"](e.hide)})}}]).controller("EmailCreateCtrl",["$scope","$rootScope","$sce","$filter","$timeout","$state","$stateParams","$ionicLoading","$ionicHistory","Email","EmailUtils",function(t,e,n,i,r,o,a,s,c,l,u){function d(e){t.source=e,"reply"==a.type?(t.form.toids=e.fromid,t.form.subject="回复："+e.subject):"replyAll"==a.type?(t.form.toids=u.concatToids(e.fromid,e.toids,e.copytoids),t.form.subject="回复："+e.subject):"forward"==a.type&&(t.form.subject="转发："+e.subject,t.form.attachmentid=e.attachmentid),e.content&&(t.source.content=n.trustAsHtml(i("editorContent")(e.content)))}t.form={toids:"",ccids:"",mcids:"",subject:"",content:""},t.isSubmitting=!1,a.id&&a.type&&(s.show(),l.get(a.id).success(d)["finally"](s.hide)),t.showOther=function(){t.isShowOther=!0},t.isDisabledSubmit=function(){return t.isSubmitting||!t.emailForm.$valid},t.submit=function(){t.isSubmitting=!0,s.show();var e=angular.extend({},t.form,{content:t.source?t.form.content+document.getElementById("email_info").innerHTML+t.source.content:t.form.content});l.create(e).success(function(){c.clearCache(["email.inbox","email.outbox"]),u.showSendedPopup(t)})["finally"](s.hide)}}]),angular.module("email",["ionic","email.controllers","email.services"]).run(["Apps",function(t){t.install({name:"email",title:"邮件中心",route:"#/email",state:"email.index",icon:"img/modicon/email.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/email","/email/index"),t.state("email",{url:"/email","abstract":!0,template:'<ion-nav-view name="email"></ion-nav-view>',resolve:n.resolve}),t.state("email.index",{url:"/index",talkingDataLabel:"邮件-首页",views:{email:{templateUrl:"templates/email/email-index.html",controller:"EmailIndexCtrl"}}}).state("email.inbox",{url:"/inbox",talkingDataLabel:"邮件-收件箱",views:{email:{templateUrl:"templates/email/email-inbox.html",controller:"EmailInboxCtrl"}}}).state("email.todo",{url:"/todo",talkingDataLabel:"邮件-待办",views:{email:{templateUrl:"templates/email/email-inbox.html",controller:"EmailTodoCtrl"}}}).state("email.outbox",{url:"/outbox",talkingDataLabel:"邮件-已发送",views:{email:{templateUrl:"templates/email/email-outbox.html",controller:"EmailOutboxCtrl"}}}).state("email.trash",{url:"/trash",talkingDataLabel:"邮件-已删除",views:{email:{templateUrl:"templates/email/email-inbox.html",controller:"EmailTrashCtrl"}}}).state("email.detail",{url:"/detail/:id",talkingDataLabel:"邮件-查看邮件",views:{email:{templateUrl:"templates/email/email-detail.html",controller:"EmailDetailCtrl"}}}).state("email.outboxDetail",{url:"/outboxDetail/:id",talkingDataLabel:"邮件-查看邮件",views:{email:{templateUrl:"templates/email/email-detail.html",controller:"EmailOutboxDetailCtrl"}}}).state("email.trashDetail",{url:"/trashDetail/:id",talkingDataLabel:"邮件-查看邮件",views:{email:{templateUrl:"templates/email/email-detail.html",controller:"EmailTrashDetailCtrl"}}}).state("email.create",{url:"/create?id&type",talkingDataLabel:"邮件-写邮件",views:{email:{templateUrl:"templates/email/email-create.html",controller:"EmailCreateCtrl"}}})}]),angular.module("email.services",[]).factory("EmailUtils",["$state","$ionicPopup","$ionicHistory",function(t,e,n){return{showSendedPopup:function(i){return e.show({title:"邮件发送成功",scope:i,buttons:[{text:"返回主页",onTap:function(){n.nextViewOptions({disableBack:!0}),t.go("email.index")}},{text:"再写一封",type:"button-positive",onTap:function(e){t.reload()}}]})},concatToids:function(){var t=[];return angular.forEach(arguments,function(e){var n=angular.isArray(e)?e:angular.isString(e)&&e?e.split(","):[];return!n.length||void angular.forEach(n,function(e){t.indexOf(e)==-1&&t.push(e)})}),t.length?t.join(","):""},goBackOrHome:function(){n.backView()?n.goBack():t.go("email.index")}}}]).factory("Email",["$rootScope","$http","$state","$ionicLoading","IbPopup","Settings",function(t,e,n,i,r,o){function a(n){return e.post(m+"/edit",n).success(function(e){t.$broadcast("email.create",e)}).error(o.requestError)}function s(n){return i.show(),e.post(m+"/del",{emailid:n}).success(function(e){e.isSuccess?t.$broadcast("email.remove",n):r.alert({template:e.errorMsg})}).error(o.requestError).success(i.hide).error(i.hide)}function c(n){return e.post(m+"/delete",{emailid:n}).success(function(e){e.isSuccess?t.$broadcast("email.removeTrash",n):r.alert({template:e.errorMsg})}).error(o.requestError)}function l(n){return e.post(m+"/delete",{emailid:n}).success(function(e){e.isSuccess?t.$broadcast("email.removeOutbox",n):r.alert({template:e.errorMsg})}).error(o.requestError)}function u(t){return r.confirm({title:"确定彻底删除该邮件吗？"}).then(function(e){e&&angular.isFunction(t)&&t()})}function d(t){return e.get(m+"/show",{params:{id:t}}).error(o.requestError)}function f(n,i){return e.get(m+"/mark",{params:{emailid:n,ismark:!!i}}).success(function(){t.$broadcast("email.mark",n,!!i)}).error(o.requestError)}function p(n){return e.get(m+"/recovery",{params:{emailid:n}}).success(function(e){e.isSuccess&&t.$broadcast("email.recovery",n)}).error(o.requestError)}var m=o.rootUrl+"/mail";return{create:a,get:d,remove:s,removeCompletely:c,removeOutbox:l,removeCompletelyConfirm:u,mark:f,recovery:p}}]).factory("EmailList",["$http","$ionicLoading","Settings",function(t,e,n){function i(t,e){this.url=t,this.options=e,this.hasMore=!0,this.mails=[],this.params={}}n.rootUrl+"/mail";return angular.extend(i.prototype,{fetch:function(n,i,r){var o=this;return i&&this.reset(),r===!1?this.params=n:angular.extend(this.params,n),e.show(),t.get(this.url,{params:this.params}).success(function(t){o.mails=o.mails.concat(t.data),o.hasMore=!!t.lastid}).success(e.hide).error(e.hide)},get:function(t){var e=null;return angular.forEach(this.mails,function(n){if(n.emailid==t)return e=n,!1}),e},getLastId:function(){return this.mails.length?this.mails[this.mails.length-1].emailid||"":""},view:function(t){var e=this.get(t);e&&(e.isread="1")},search:function(t){return this.fetch({lastid:"",search:t},!0)},loadMore:function(){return this.fetch({lastid:this.getLastId()})},hasMails:function(){return!!this.mails.length},checkNoData:function(){return!this.mails.length&&!this.hasMore},remove:function(t){var e=this;this.mails.length&&angular.forEach(this.mails,function(n,i){if(n.emailid==t)return e.mails.splice(i,1),!1})},reset:function(){this.mails=[],this.hasMore=!0,this.params={}},refresh:function(){return this.fetch({},!0)},mark:function(t,e){var n=this.get(t);n&&(n.ismark=e?"1":"0")}}),i}]).factory("EmailInbox",["$rootScope","Settings","EmailList",function(t,e,n){var i=new n(e.rootUrl+"/mail&type=inbox");return t.$on("email.create",function(t){i.reset()}),t.$on("email.recovery",function(){i.reset()}),t.$on("email.remove",function(t,e){i.remove(e)}),t.$on("email.mark",function(t,e,n){i.mark(e,n)}),i}]).factory("EmailTodo",["$rootScope","Settings","EmailList",function(t,e,n){var i=new n(e.rootUrl+"/mail&type=todo");return t.$on("email.recovery",function(){i.reset()}),t.$on("email.remove",function(t,e){i.remove(e)}),t.$on("email.mark",function(t,e,n){i.mark(e,n)}),i}]).factory("EmailOutbox",["$rootScope","Settings","EmailList",function(t,e,n){var i=new n(e.rootUrl+"/mail&type=send");return t.$on("email.create",function(t){i.reset()}),t.$on("email.removeOutbox",function(t,e){i.remove(e)}),t.$on("email.mark",function(t,e,n){i.mark(e,n)}),i}]).factory("EmailTrash",["$rootScope","Settings","EmailList",function(t,e,n){var i=new n(e.rootUrl+"/mail&type=del");return t.$on("email.removeTrash",function(t,e){i.remove(e)}),t.$on("email.recovery",function(t,e){i.remove(e)}),t.$on("email.mark",function(t,e,n){i.mark(e,n)}),t.$on("email.remove",function(){i.reset()}),i}]),angular.module("news.controllers",[]).controller("NewsIndexCtrl",["$scope","NewsIndex","News",function(t,e,n){t.list=e,t.title="已发布",t.refresh=function(){t.list.fetch({catid:0,page:0,search:""},!0)["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.open=function(t){n.open(t,"news.detail")},t.list.hasNews()&&!t.list.params.search||t.list.fetch({catid:0,page:0,search:""},!0)}]).controller("NewsUnreadCtrl",["$scope","$ionicHistory","$state","IbPopup","NewsUnread","News",function(t,e,n,i,r,o){t.list=r,t.title="未读",t.refresh=function(){t.list.fetch({catid:0,page:0,search:""},!0)["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.open=function(t){o.open(t,"news.detail")},t.markRead=function(){i.confirm({title:"确定要将此分类新闻全部标记成已读？"}).then(function(e){e&&o.readall().success(t.refresh)})},t.list.hasNews()&&!t.list.params.search||t.refresh()}]).controller("NewsUnapprovalCtrl",["$scope","News",function(t,e){function n(n){return e.list({type:"notallow",page:n}).success(function(e){t.news=e.data,t.pages=e.pages})}n(),t.loadMore=function(){n(t.pages.page+1)},t.refresh=function(){n()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.open=function(t){e.open(t,"news.approval")}}]).controller("NewsCategoryCtrl",["$scope","$ionicScrollDelegate","News",function(t,e,n){n.category().success(function(i){function r(e){return n.list({catid:e}).success(function(e){t.list=e.data})}function o(t){var e=[];return angular.forEach(a,function(n){n.pid===t.catid&&e.push(n)}),e}var a=i.data;t.histories=[],t.open=function(t){n.open(t,"news.detail")},t.enterCategory=function(e){t.list=[],t.currentCategory&&t.histories.push(t.currentCategory),"0"!==e.catid&&r(e.catid),t.currentCategory=e,t.categories=o(e)},t.back=function(){t.currentCategory=t.histories.pop(),r(t.currentCategory.catid),t.categories=o(t.currentCategory)},t.toCategory=function(e){t.currentCategory=e,t.histories.splice(t.histories.indexOf(e)),r(t.currentCategory.catid),t.categories=o(t.currentCategory)},t.enterCategory({catid:"0",name:" "});var s=e.$getByHandle("news-breadcrumb-scroll");t.$watchCollection("histories",function(){s.scrollBottom(!0)})})}]).controller("NewsDetailCtrl",["$scope","$sce","$filter","$stateParams","$ionicActionSheet","$ionicModal","$ionicLoading","$ionicHistory","$ionicPopup","$state","dateFilter","userInfoFilter","IbPopup","Utils","News","NewsIndex",function(t,e,n,i,r,o,a,s,c,l,u,d,f,p,m,h){function g(t){return{articleid:t,isDesc:1,limit:9999}}t.news={},m.get(i.id).success(function(e){t.news=e.data}),m.getComments(g(i.id)).success(function(e){t.commentList=e.data}),t.showMore=function(){t.form={},r.show({buttons:[{text:"0"==t.news.istop?"置顶":"取消置顶"},{text:"移动"}],buttonClicked:function(e){if(0===e){var n={articleids:i.id,topEndTime:""};"0"==t.news.istop?c.show({template:' <input type="date" data-tap-disabled="true" ng-model="form.topEndTime">',title:"过期时间",scope:t,buttons:[{text:"取消"},{text:"确认",type:"button-positive",onTap:function(e){t.form.topEndTime&&(n.topEndTime=u(t.form.topEndTime,"yyyy-MM-dd"),a.show(),m.top(n).success(function(e){t.news.istop="1",h.reset(),s.clearCache(["news.published"])})["finally"](a.hide))}}]}):(a.show(),m.top(n).success(function(){t.news.istop="0"})["finally"](a.hide))}return 1===e&&o.fromTemplateUrl("templates/news/news-move.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.moveModel=e,t.moveModel.show(),t.catid="",m.category().success(function(e){function n(t,e){for(var i,r=[],o=0;o<t.length;o++)t[o].checked=!1,t[o].showChildrenList=!0,t[o].pid==e&&(i=n(t,t[o].catid),i.length>0&&(t[o].childrenList=i),r.push(t[o]));return r}t.categoryList=e.data;var i=0;t.categorys=n(t.categoryList,i),t.selectCategory=function(e){e.checked===!0?(t.catid=e.catid,angular.forEach(t.categoryList,function(t){t.checked=!1}),e.checked=!0):t.catid=""},t.submit=function(){var e={articleids:t.news.articleid,catid:t.catid};a.show(),m.move(e).success(function(e){t.moveModel.hide(),a.hide(),p.clearStateCacheAndGo("news.published")})}})}),!0},destructiveText:"删除",cancelText:"取消",destructiveButtonClicked:function(){var e={articleids:t.news.articleid};m["delete"](e).success(function(t){p.clearStateCacheAndGo("news.published")})}})},t.openComment=function(e,n){o.fromTemplateUrl("templates/news/news-comment.html",{scope:t,animation:"slide-in-up"}).then(function(i){t.comment={},t.commentModal=i,t.commentModal.show(),"reply"===e&&(t.comment.content=n.touid?"回复 @"+d(n.uid,"realname")+" : ":""),t.submit=function(){var i={type:e,content:t.comment.content};"comment"===e?i.rowid=t.news.articleid:(i.tocid=n.cid,"0"===n.tocid?i.rowid=n.cid:i.rowid=n.rowid),m.addComment(i).success(function(e){t.commentModal.hide(),a.show(),m.getComments(g(t.news.articleid)).success(function(e){a.hide(),t.commentList=e.data})})}})},t.openCommentDetail=function(){o.fromTemplateUrl("templates/news/news-comment-detail.html",{scope:t,animation:"slide-in-up"
}).then(function(e){t.commentTetailModal=e,t.commentTetailModal.show(),m.getComments(g(t.news.articleid)).success(function(e){a.show(),e.isSuccess&&(t.commentList=e.data)})["finally"](a.hide)})},t.openReaderDetail=function(){o.fromTemplateUrl("templates/news/news-reader-detail.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.readerTetailModal=e,t.readerTetailModal.show();var n={articleid:t.news.articleid};m.getReaders(n).success(function(e){t.readers=e.data})})}}]).controller("NewsApprovalCtrl",["$scope","$stateParams","$sce","$filter","$ionicActionSheet","$ionicHistory","$ionicLoading","$ionicPopup","$state","IbPopup","News",function(t,e,n,i,r,o,a,s,c,l,u){u.get(e.id).success(function(e){t.news=e.data}),t.checkNews=function(){t.form={},r.show({buttons:[{text:"通过"}],buttonClicked:function(e){if(0===e)return a.show(),u.verify({articleids:t.news.articleid}).success(function(t){a.hide(),t.isSuccess===!1?alert(t.msg):(l.alert({title:"审核通过"}),o.clearCache([o.currentView().stateId]).then(function(){c.reload()}))}),!0},destructiveText:"退回",cancelText:"取消",destructiveButtonClicked:function(){return s.show({template:'<input ng-model="form.reason">',title:"退回",scope:t,buttons:[{text:"取消"},{text:"确认",type:"button-positive",onTap:function(e){var n={articleids:t.news.articleid,reason:t.form.reason};u.back(n).success(function(t){o.clearCache([o.currentView().stateId]).then(function(){c.reload()})})}}]}),!0}})}}]),angular.module("news.filters",[]),angular.module("news",["ionic","news.controllers","news.services"]).run(["Apps",function(t){t.install({name:"news",title:"新闻",route:"#/news",state:"news.published",icon:"img/modicon/news.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/news","/news/published"),t.state("news",{url:"/news","abstract":!0,template:'<ion-nav-view name="news"></ion-nav-view>',resolve:n.resolve}).state("news.published",{url:"/published",talkingDataLabel:"新闻-已发布",cache:!1,views:{news:{templateUrl:"templates/news/news-index.html",controller:"NewsIndexCtrl"}}}).state("news.unread",{url:"/unread",talkingDataLabel:"新闻-未读",cache:!1,views:{news:{templateUrl:"templates/news/news-unread.html",controller:"NewsUnreadCtrl"}}}).state("news.unapproval",{url:"/unapproval",talkingDataLabel:"新闻-未审核",cache:!1,views:{news:{templateUrl:"templates/news/news-unapproval.html",controller:"NewsUnapprovalCtrl"}}}).state("news.category",{url:"/category?cid",talkingDataLabel:"新闻-按分类",cache:!1,views:{news:{templateUrl:"templates/news/news-category.html",controller:"NewsCategoryCtrl"}}}).state("news.detail",{url:"/detail/:id",talkingDataLabel:"新闻-查看新闻",views:{news:{templateUrl:"templates/news/news-detail.html",controller:"NewsDetailCtrl"}}}).state("news.unreadDetail",{url:"/unreadDetail/:id",talkingDataLabel:"新闻-查看新闻",views:{news:{templateUrl:"templates/news/news-detail.html",controller:"NewsDetailCtrl"}}}).state("news.readDetail",{url:"/readDetail/:id",talkingDataLabel:"新闻-查看新闻",views:{news:{templateUrl:"templates/news/news-detail.html",controller:"NewsDetailCtrl"}}}).state("news.categoryDetail",{url:"/categoryDetail/:id",talkingDataLabel:"新闻-查看新闻",views:{news:{templateUrl:"templates/news/news-detail.html",controller:"NewsDetailCtrl"}}}).state("news.approval",{url:"/approval/:id",talkingDataLabel:"新闻-审核新闻",views:{news:{templateUrl:"templates/news/news-approval.html",controller:"NewsApprovalCtrl"}}})}]),angular.module("news.services",[]).factory("News",["$http","$state","$ionicLoading","Settings",function(t,e,n,i){var r=i.rootUrl+"/news";return{get:function(e){return n.show(),t.get(r+"/show",{params:{articleid:e}}).success(n.hide).error(n.hide)},list:function(e){return t.get(r+"/index",{params:e})},read:function(e){return t.get(r+"/read",{params:{articleid:e}})},open:function(t,n){"2"==t.type?window.open(t.url,"_blank","location=yes"):e.go(n,{id:t.articleid}),t.readstatus||this.read(t.articleid).success(function(e){e.isSuccess&&(t.readstatus=!0)})},category:function(){return t.get(r+"/category")},readall:function(){return t.post(r+"/readall")},top:function(e){return t.post(r+"/top",e)},"delete":function(e){return t.post(r+"/del",e)},getReaders:function(e){return t.post(r+"/getReaders",e)},verify:function(e){return t.post(r+"/verify",e)},back:function(e){return t.post(r+"/back",e)},addComment:function(e){return t.post(r+"/addComment",e)},getComments:function(e){return t.get(r+"/getComments",{params:e})},move:function(e){return t.post(r+"/move",e)}}}]).factory("NewsList",["$http","$ionicLoading","Settings","Utils",function(t,e,n,i){function r(t,e){this.url=t,this.options=e,this.hasMore=!0,this.news=[],this.params={}}n.rootUrl+"/news";return angular.extend(r.prototype,{fetch:function(e,n,r){var o=this;return n&&(this.news=[],this.hasMore=!0),r===!1?this.params=e:angular.extend(this.params,e),t.get(this.url,{params:this.params}).success(function(t){t.isSuccess?(t.pages.page<t.pages.pageCount&&(o.news=o.news.concat(t.data)),o.hasMore=t.pages.page<t.pages.pageCount-1):i.promptNoPermission()})},search:function(t){return this.fetch({page:1,search:t},!0)},loadMore:function(){return this.fetch({page:this.params.page+1})},hasNews:function(){return!!this.news.length},reset:function(){this.news.length=0,this.hasMore=!0}}),r}]).factory("NewsIndex",["NewsList","Settings",function(t,e){var n=e.rootUrl+"/news",i=new t(n+"/index");return i}]).factory("NewsUnread",["NewsList","Settings",function(t,e){var n=new t(e.rootUrl+"/news&type=new");return n}]),angular.module("report.controllers",[]).controller("ReportIndexCtrl",["$scope","$ionicModal","$ionicLoading","$localstorage","$state","$timeout","uniqueFilter","mapFilter","Utils","IbPopup","Report",function(t,e,n,i,r,o,a,s,c,l,u){function d(t,e){var n=s(e,"tid");return t.filter(function(t){return n.indexOf(t.tid)===-1})}function f(t,e){var n=d(t,e);return n.length?e.concat(n):e}function p(){u.getUnreadCount().success(function(e){e.isSuccess&&(t.unreadCount=e.data.unread)})}function m(){n.show(),u.getUserTemplate().success(function(e){e.isSuccess?(t.loading=!1,v?t.templates=f(e.data,v):t.templates=e.data,t.isSet=e.isSet):c.promptNoPermission()})["finally"](n.hide)}function h(t,e){t.$on("$ionicView.leave",e.hide.bind(e)),t.$on("$destroy",e.remove.bind(e))}var g="report.settings",v=i.getObject(g);t.order=!1,t.loading=!0,t.openManageModel=function(){e.fromTemplateUrl("templates/report/report-manage-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.manageModel=e,t.manageModel.show(),t.settingTpls=t.templates,t.openOrderList=function(){t.settingTpls=t.templates,t.moveTpl=function(e,n,r){t.settingTpls.splice(n,1),t.settingTpls.splice(r,0,e),i.setObject(g,t.settingTpls)},t.orderFinish=function(){t.manageModel.hide(),t.templates=t.settingTpls}},h(t,e)})},t.openSettingModel=function(i){e.fromTemplateUrl("templates/report/report-setting-modal.html",{scope:t,animation:"slide-in-up"}).then(function(o){function a(e){l.alert({title:e}).then(function(e){e&&(t.settingModel.hide(),r.go("report.index"))})}t.settingModel=o,t.settingModel.show(),t.collection=[],t.manageTypes=[],t.uptype={},t.formData={};u.getcharge().success(function(e){e.isSuccess&&(t.managers=e.data)}),t.outRemoveTypeMode=function(){t.removeTypeMode=!1},t.removeTypeMode=!1,t.toRemoveTypeMode=function(e){t.removeTypeMode=!0,e.stopPropagation()},t.openSelectManagerModal=function(){e.fromTemplateUrl("templates/report/report-select-manager-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.chargeModel=e,t.chargeModel.show();var n;t.manageTypes.length>0&&(n=[].concat(t.manageTypes.map(function(t){return t.uptype})),angular.forEach(t.managers,function(e){for(var i=0;i<n.length;i++)e.uptype==n[i]&&(t.uptype[e.uptype]=!0)})),t.addManager=function(){t.chargeModel.hide(),t.manageTypes=[],angular.forEach(t.managers,function(e){t.uptype[e.uptype]&&(t.manageTypes.push(e),t.manageTypeids=[].concat(t.manageTypes.map(function(t){return t.uptype})).join(","))})},h(t,e)})},t.removeType=function(e,n){var i=t.manageTypes.indexOf(n);t.manageTypes.splice(i,1),t.manageTypeids=[].concat(t.manageTypes.map(function(t){return t.uptype})).join(","),t.manageTypes.length||(t.removeTypeMode=!1),e.stopPropagation()},n.show(),u.settemplate({tid:i}).success(function(e){e.isSuccess&&(t.formData.defaultShareList=e.data.uid,t.manageTypes=e.data.uptype,t.formData.defaultReceiveList=e.data.upuid)})["finally"](n.hide),t.setTemplate=function(){var e={tid:i,uid:t.formData.defaultShareList||"",uptype:t.manageTypeids||"",upuid:t.formData.defaultReceiveList||""};n.show(),u.settemplate(e).success(function(e){e.isSuccess?l.alert({title:"设置成功"}).then(function(){t.openManageModel()}):a("设置失败")})["finally"](n.hide)},h(t,o)})},t.openAddModal=function(){e.fromTemplateUrl("templates/report/report-add-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.addModel=e,t.addModel.show(),n.show(),u.getShopList().success(function(e){e.isSuccess&&(t.templateData=e.data,t.isAdd=e.isAdd,t.addTemplate=function(e){n.show(),u.addTemplate(e).success(function(e){e.isSuccess&&(t.addModel.hide(),o(m),r.go("report.index"))})["finally"](n.hide)})})["finally"](n.hide),h(t,e)})},t.$on("$ionicView.enter",function(){p(),m()})}]).controller("ReportFormCtrl",["$scope","$q","$stateParams","$ionicLoading","$ionicHistory","$state","Utils","External","CommonApi","IbPopup","mapFilter","fileSizeFilter","dateFilter","ReportUtils","Report",function(t,e,n,i,r,o,a,s,c,l,u,d,f,p,m){function h(t){return t=angular.merge({},t),angular.forEach(t.fields,function(t){t.content||(t.content=""),3==t.fieldtype?t.content=""+t.content:4==t.fieldtype?t.content=f(t.content,"yyyy-MM-dd HH:mm")||"":5==t.fieldtype?t.content=f(t.content,"HH:mm")||"":6==t.fieldtype?t.content=f(t.content,"yyyy-MM-dd")||"":7==t.fieldtype&&(t.fieldvalue=t.fieldvalue.join(","))}),t}var g=n.tid,v=n.repid,w=g?{tid:g}:{repid:v};i.show(),m.getTemplateData(w).success(function(e){if(i.show(),e.isSuccess){t.formData={subject:"",toid:"",attachmentid:"",remark:"",place:"",status:1,fields:[]};var n=e.data.template;t.subject=e.data.template.subject,t.formData.tid=n.tid||"",t.formData.fields=e.data.templateField||"",t.formData.toid=n.defaultuid||"",t.formData.remark=n.remark||"",t.accessories=n.attach||[],v&&(t.formData.repid=n.repid||"",angular.forEach(t.formData.fields,function(t){"4"==t.fieldtype||"6"==t.fieldtype?t.content=new Date(t.content):"5"==t.fieldtype?t.content=new Date("1970-01-01 "+t.content):"3"==t.fieldtype&&(isNaN(Number(+t.content))?t.content=0:t.content=+t.content)})),t.submit=function(){t.formData.attachmentid=t.accessories.map(function(t){return t.aid}).join(",");var e=h(t.formData);i.show(),m.saveReport(e).success(function(t){t.isSuccess?g?o.go("report.send"):o.go("report.view",{repid:v}):alert(t.msg)})["finally"](i.hide)},t.saveDraft=function(){t.reportForm.$dirty?l.confirm({title:"你还未发布汇报，是否保存"}).then(function(e){if(e){t.formData.status=0;var n=h(t.formData);i.show(),m.saveReport(n).success(function(t){t.isSuccess&&r.goBack()})["finally"](i.hide)}else r.goBack()}):r.goBack()}}})["finally"](i.hide),t.addImage=function(n){t.uploading=!0,angular.forEach(n.target.files,function(n){var i={name:n.name,size:d(n.size),type:n.type.split("/")[1],uploading:!0,cancel:null};i.cancel=e.defer(),i.index=t.accessories.length,t.accessories.push(i),t.$applyAsync();var r=new FormData;r.append("Filedata[]",n),c.uploadAttach(r,{timeout:i.cancel.promise}).then(function(e){var n=e.data;if(n.isSuccess){var r=n.data[0];i.aid=r.aid}else t.accessories.splice(i.index,1)})["catch"](function(e){t.accessories.splice(i.index,1)})["finally"](function(){i.uploading=!1;var e=t.accessories.filter(function(t){return t.uploading});e.length||(t.uploading=!1)})})},t.removeImage=function(e){l.confirm({title:"确定要删除该图片吗？"}).then(function(n){n&&t.accessories.splice(e,1)})}}]).controller("ReportReceiveCtrl",["$scope","$rootScope","$ionicScrollDelegate","$ionicLoading","dateFilter","IbPopup","SearchModal","ReportUtils","Report",function(t,e,n,i,r,o,a,s,c){t.activeTab="unread",t.loading=!0;var l={limit:10,offset:0,type:"unread"};t.groupByTime=function(t){return r(1e3*t.addtime,"EEEE")},t.readReport=function(t){t.isreview="1"},t.setTab=function(e){n.$getByHandle("reportReceiveListScroll").scrollTop(),t.list=[],t.loading=!0,t.activeTab=e||"unread",l.offset=0,l.type="unread"===e?"unread":"receive",s.getList(t,l)},t.addRead=function(){i.show(),c.allRead().success(function(e){e.isSuccess&&(l.type="receive",t.activeTab="all",s.getList(t,l),o.alert({title:"全部标记已读"}))})["finally"](i.hide)},t.loadMore=function(){var e=t.activeTab;l.offset=t.list.length,l.type="unread"===e?"unread":"receive",i.show(),c.getList(l).success(function(e){e.isSuccess&&(t.list=t.list.concat(e.data.list))})["finally"](i.hide)},t.search=new a({scope:t,searchFunc:function(t){return c.getList({type:"receive",limit:99,offset:0,keyword:{subject:t.key}})}}),t.refresh=function(){l.offset=0,s.getList(t,l)},s.getList(t,l)}]).controller("ReportSendCtrl",["$scope","$rootScope","$ionicLoading","dateFilter","SearchModal","ReportUtils","Report",function(t,e,n,i,r,o,a){t.loading=!0;var s={limit:10,offset:0,type:"send"};t.groupByTime=function(t){return i(1e3*t.addtime,"EEEE")},t.loadMore=function(){s.offset=t.list.length,n.show(),a.getList(s).success(function(e){e.isSuccess&&(t.list=t.list.concat(e.data.list))})["finally"](n.hide)},t.search=new r({scope:t,searchFunc:function(t){return a.getList({type:"send",limit:99,offset:0,keyword:{subject:t.key}})}}),t.refresh=function(){s.offset=0,o.getList(t,s)},o.getList(t,s)}]).controller("ReportViewCtrl",["$scope","$rootScope","$stateParams","$ionicModal","$ionicLoading","$ionicActionSheet","$state","$ionicHistory","IbPopup","uniqueFilter","userInfoFilter","Report",function(t,e,n,i,r,o,a,s,c,l,u,d){t.currentUserUid=e.user.uid,r.show(),d.showReport(n.repid).success(function(e){function l(){r.show(),d.getComments(f).success(function(e){r.hide(),t.commentList=e.data.lists})}if(e.isSuccess){t.report=e.data,t.report.readers=e.data.reader;var f={type:"comment",rowid:t.report.repid,offset:0,limit:999};t.openComment=function(e,o){i.fromTemplateUrl("templates/report/report-comment.html",{scope:t,animation:"slide-in-up"}).then(function(i){t.comment={},t.commentModal=i,t.comment.isStampsBoxShow=!1,t.commentModal.show(),d.getStamp().success(function(e){e.isSuccess&&(t.report.stamps=e.data)}),"reply"===e&&(t.comment.content=o.touid?"回复 @"+u(o.uid,"realname")+" : ":""),t.submit=function(){var i={type:e,content:t.comment.content,moduleuid:t.user.uid};"comment"===e?i.rowid=t.report.repid:(i.tocid=o.cid,"0"===o.tocid?i.rowid=o.cid:i.rowid=o.rowid),d.addComment(i).success(function(e){if(t.comment.stamp){var i={repid:n.repid,stampid:t.comment.stamp.stampid};d.setStamp(i)}d.showReport(n.repid).success(function(e){e.isSuccess&&(t.report.stamp=e.data.stamp)}),t.commentModal.hide(),r.show(),l()})}})},t.openCommentDetail=function(){i.fromTemplateUrl("templates/report/report-comment-detail.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.commentTetailModal=e,t.commentTetailModal.show(),l()})},t.openReaderDetail=function(){i.fromTemplateUrl("templates/report/report-reader-detail.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.readerTetailModal=e,t.readerTetailModal.show()})},t.operateMore=function(){o.show({buttons:[{text:"编辑"}],destructiveText:"删除",cancelText:"取消",buttonClicked:function(e){0===e&&a.go("report.form",{repid:t.report.repid})},destructiveButtonClicked:function(){c.confirm({title:"确认删除汇报？"}).then(function(e){e&&(r.show(),d.delReport(t.report.repid).success(function(t){t.isSuccess&&s.goBack()})["finally"](r.hide))})}})},l()}})["finally"](r.hide)}]),angular.module("report",["ionic","report.controllers","report.services"]).run(["Apps",function(t){t.install({name:"report",title:"汇报",route:"#/report",state:"report.index",icon:"img/modicon/report.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider","ResolversProvider",function(t,e,n,i){e.when("/report","/report/index"),t.state("report",{url:"/report","abstract":!0,template:'<ion-nav-view name="report"></ion-nav-view>',resolve:n.resolve}).state("report.index",{url:"/index",talkingDataLabel:"汇报-首页",views:{report:{templateUrl:"templates/report/report-index.html",controller:"ReportIndexCtrl"}}}).state("report.form",{url:"/form/:repid?tid",talkingDataLabel:"汇报-表单（创建、编辑）",resolve:i.get(["qqmap"]),views:{report:{templateUrl:"templates/report/report-form.html",controller:"ReportFormCtrl"}}}).state("report.receive",{url:"/receive",cache:!1,talkingDataLabel:"汇报列表-我收到的",views:{report:{templateUrl:"templates/report/report-receive.html",controller:"ReportReceiveCtrl"}}}).state("report.send",{url:"/send",cache:!1,talkingDataLabel:"汇报列表-我发出的",views:{report:{templateUrl:"templates/report/report-send.html",controller:"ReportSendCtrl"}}}).state("report.view",{url:"/view/:repid",cache:!1,talkingDataLabel:"汇报-详情",views:{report:{templateUrl:"templates/report/report-view.html",controller:"ReportViewCtrl"}}})}]),angular.module("report.services",[]).factory("Report",["$http","Settings","Utils",function(t,e,n){var i=e.hostUrl+"?r=report/api";return{getUserTemplate:function(){return t.get(i+"/usertemplate")},getShopList:function(){return n.postJsonData(i+"/shoplist")},getSortTemplate:function(){return n.postJsonData(i+"/sorttemplate")},addTemplate:function(t){return n.postJsonData(i+"/addTemplate",{tid:t})},getManagerTemplate:function(){return n.postJsonData(i+"/managertemplate")},getcharge:function(){return n.postJsonData(i+"/getcharge")},getList:function(t){return n.postJsonData(i+"/getlist",t)},settemplate:function(t){return n.postJsonData(i+"/settemplate",t)},getTemplateData:function(e){return t.get(i+"/formreport",{params:e})},saveReport:function(t){return n.postJsonData(i+"/savereport",t)},showReport:function(e){return t.get(i+"/showreport",{params:{repid:e}})},delReport:function(t){return n.postJsonData(i+"/delreport",{repids:t})},allRead:function(t){return n.postJsonData(i+"/allread",{repids:0})},addComment:function(t){return n.postJsonData(i+"/addcomment",t)},getComments:function(t){return n.postJsonData(i+"/getcommentlist",t)},getReaders:function(t){return n.postJsonData(i+"/getreader",{repid:t})},getStamp:function(e){return t.get(i+"/getstamp")},setStamp:function(t){return n.postJsonData(i+"/setstamp",t)},getUnreadCount:function(){return t.get(i+"/getcount")}}}]).factory("ReportUtils",["$state","External","IbPopup","dateFilter","CommonApi","Report",function(t,e,n,i,r,o){return{getList:function(t,e){o.getList(e).success(function(e){e.isSuccess&&(t.loading=!1,t.list=e.data.list,t.list.hasMore=e.data.hasMore)})["finally"](function(){t.$broadcast("scroll.refreshComplete")})}}}]),angular.module("thread.controllers",[]).controller("ThreadIndexCtrl",["$scope","$ionicLoading","User","Thread","ThreadUtils","ThreadProgress","User","Utils",function(t,e,n,i,r,o,n,a){e.show(),n.getAuthority().success(function(e){e.isSuccess&&(e.data.thread?(t.isAttention=function(t){return t.isAttention},t.getDayLeft=r.getDayLeft,t.isInCharge=function(t){return t.chargeuid==n.uid},t.init=function(){t.list.hasItems()||t.list.refresh()},t.refresh=function(){t.refreshing=!0,t.list.refresh()["finally"](function(){t.$broadcast("scroll.refreshComplete"),t.refreshing=!1})},t.list=o,t.init()):a.promptNoPermission())})["finally"](e.hide)}]).controller("ThreadFinishedCtrl",["$scope","User","Thread","ThreadFinished",function(t,e,n,i){t.init=function(){t.list.hasItems()||t.list.refresh()},t.refresh=function(){t.refreshing=!0,t.list.refresh()["finally"](function(){t.$broadcast("scroll.refreshComplete"),t.refreshing=!1})},t.list=i,t.init(),t.isInCharge=function(t){return t.chargeuid==e.uid}}]).controller("ThreadViewCtrl",["$scope","$stateParams","$ionicSlideBoxDelegate","Thread","ThreadUtils",function(t,e,n,i,r){function o(t){for(var e=0;e<t.length;e++)if(t[e].isCharge){t.unshift(t.splice(e,1)[0]);break}return t}function a(){this.loaded=!1,this.loading=!1,this.more=!0,this.list=[],this.load=function(t){var e=this;this.loaded||(this.loading=!0,i.view(t).success(function(t){e.list=t.datas,e.loaded=!0})["finally"](function(){e.loading=!1}))}}t.thread={starttime:0,endtime:0},i.view(e).success(function(e){t.thread=e.datas.thread,t.dayLeft=r.getDayLeft(t.thread.endtime)}),t.slideChanged=function(t){n.update()},t.$watch("thread.description",t.slideChanged.bind(t)),t.members=[],i.view({id:e.id,tab:"team"}).success(function(e){t.members=o(e.datas.members)}),t.tab="assignment",t.assignment=new a,t.feed=new a,t.email=new a,t.flow=new a,t.file=new a,t.$watch("tab",function(n){t[n].load({id:e.id,tab:n})}),t.setTab=function(e){t.tab=e}}]),angular.module("thread.services",[]).factory("ThreadUtils",function(){return{getDayLeft:function(t){return t=+t,t?Math.ceil((t-Date.now()/1e3)/86400):0}}}).factory("Thread",["$http","Settings",function(t,e){return{list:function(n){return t.get(e.rootUrl+"/thread/index",{params:n})},view:function(n){return t.get(e.rootUrl+"/threaddetail/detail",{params:n})}}}]).factory("ThreadProgress",["Settings","IbList",function(t,e){var n=new e(t.rootUrl+"/thread/index&status=0",{idAttr:"threadid"});return n.showLoading=n.hideLoading=angular.noop,n}]).factory("ThreadFinished",["Settings","IbList",function(t,e){var n=new e(t.rootUrl+"/thread/index&status=1",{idAttr:"threadid"});return n.showLoading=n.hideLoading=angular.noop,n}]),angular.module("thread",["ionic","thread.services","thread.controllers"]).run(["Apps",function(t){t.install({name:"thread",title:"主线",route:"#/thread/index",state:"thread.index",icon:"img/modicon/thread.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/thread","/thread/index"),t.state("thread",{url:"/thread","abstract":!0,template:'<ion-nav-view name="thread"></ion-nav-view>',resolve:n.resolve}),t.state("thread.index",{url:"/index",talkingDataLabel:"主线-首页",views:{thread:{templateUrl:"templates/thread/index.html",controller:"ThreadIndexCtrl"}}}).state("thread.finished",{url:"/finished",talkingDataLabel:"主线-已结束",views:{thread:{templateUrl:"templates/thread/finished.html",controller:"ThreadFinishedCtrl"}}}).state("thread.view",{url:"/view/:id",talkingDataLabel:"主线-查看主线",views:{thread:{templateUrl:"templates/thread/view.html",controller:"ThreadViewCtrl"}}})}]),angular.module("vote.controllers",[]).controller("VoteIndexCtrl",["$scope","$state","VoteUtils","Vote",function(t,e,n,i){t.statusTab="underway",t.activeTab="nonparticipator",t.stateName=e.current.name,t.loading=!0;var r={};t.setParticipationTab=function(e){t.list=[],t.loading=!0,t.activeTab=e||"nonparticipator",r.type="nonparticipator"===t.activeTab?1:2,n.voteList(t,r)},t.setStatusTab=function(e){t.statusTab=e||"underway",r.type="underway"!==t.statusTab?5:4,n.voteList(t,r)},"vote.mine"===t.stateName?(t.statusTab="underway",r.type=4):(t.activeTab="nonparticipator",r.type=1),t.refresh=function(){"vote.index"===t.stateName?r.type="nonparticipator"===t.activeTab?1:2:r.type="underway"===t.statusTab?4:5,n.voteList(t,r)},n.voteList(t,r)}]).controller("VoteViewCtrl",["$scope","$timeout","$ionicModal","$ionicLoading","$stateParams","IbPopup","VoteUtils","Vote",function(t,e,n,i,r,o,a,s){t.isOpenMore=!1,t.openMore=function(){t.isOpenMore=!0},t.openCrewModal=function(){n.fromTemplateUrl("templates/vote/vote-crew-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.crewModal=e,t.crewModal.show(),s.showvoteusers(r.id).success(function(e){i.show(),e.isSuccess&&(t.voteUsers=e.data.users.joined)})["finally"](i.hide)})},a.showVote(t,r.id);var c={};t.checkMaxSelected=function(e,n,i){var r=t.form.topics[e],o=0;if(angular.forEach(r,function(t,e){t&&o++}),o>n){var a=c[e];r[a]=!1}c[e]=i},t.form={voteid:""},t.validForm=function(){var e=a.mainConvert(t.form.topics);return e.length===t.topics.length},t.submit=function(){s.vote({vote:{voteid:r.id,topics:a.arrayToObject(a.mainConvert(t.form.topics))}}).success(function(e){e.isSuccess?a.showVote(t,r.id):o.alert({title:e.msg})})}}]),angular.module("vote.services",[]).factory("Vote",["$http","Settings",function(t,e){var n=e.hostUrl+"?r=vote";return{voteList:function(e){return t.get(n+"/default/fetchindexlist",{params:e})},showVote:function(e){return t.get(n+"/default/showvote",{params:{voteid:e}})},vote:function(e){return t.post(n+"/default/vote",e)},showvoteusers:function(e){return t.get(n+"/default/showvoteusers",{params:{voteid:e}})}}}]).factory("VoteUtils",["$ionicLoading","Utils","Vote",function(t,e,n){return{voteList:function(i,r){t.show(),n.voteList(r).success(function(t){t.isSuccess?(i.loading=!1,i.list=t.data):e.promptNoPermission()})["finally"](function(){t.hide(),i.$broadcast("scroll.refreshComplete")})},showVote:function(e,i){t.show(),n.showVote(i).success(function(t){t.isSuccess&&(e.vote=t.data.vote,e.topics=t.data.topics)})["finally"](t.hide)},convertSubItem:function(t){var e=[];for(var n in t)t[n]&&e.push(n);return e},mainConvert:function(t){var e=[],n=this;return angular.forEach(t,function(t,i){var r="number"==typeof t?[t]:"object"==typeof t?n.convertSubItem(t):[];r.length&&e.push({topicid:i,itemids:r})}),e},arrayToObject:function(t){var e={};return angular.forEach(t,function(t,n){e[n]=t}),e}}}]),angular.module("vote",["ionic","vote.controllers","vote.services"]).run(["Apps",function(t){t.install({name:"vote",title:"投票",route:"#/vote",state:"vote.index",icon:"img/modicon/vote.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){e.when("/vote","/vote/index"),t.state("vote",{url:"/vote","abstract":!0,template:'<ion-nav-view name="vote"></ion-nav-view>',resolve:n.resolve}).state("vote.index",{url:"/index",cache:!1,talkingDataLabel:"投票-主页",views:{vote:{templateUrl:"templates/vote/vote-index.html",controller:"VoteIndexCtrl"}}}).state("vote.mine",{url:"/mine",cache:!1,talkingDataLabel:"投票-我的",views:{vote:{templateUrl:"templates/vote/vote-index.html",controller:"VoteIndexCtrl"}}}).state("vote.view",{url:"/view/:id",talkingDataLabel:"投票-详情页",cache:!1,views:{vote:{templateUrl:"templates/vote/vote-view.html",controller:"VoteViewCtrl"}}})}]),angular.module("workflow.controllers",[]).controller("FlowIndexCtrl",["$scope","$ionicLoading","User","Utils",function(t,e,n,i){e.show(),n.getAuthority().success(function(t){t.isSuccess&&(t.data.workflow||i.promptNoPermission())})["finally"](e.hide)}]).controller("FlowListCtrl",["$scope","$state","$ionicScrollDelegate","$ionicActionSheet",function(t,e,n,i){t.prop={},t.init=function(){t.list.hasItems()||t.list.refresh()},t.refresh=function(){t.prop.keyword="",t.list.refresh()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.sref="workflow.detail({ key: flow.key })",t.actionButtons=[],t.showMenu=function(e){var n={titleText:"工作流操作",buttons:t.actionButtons,buttonClicked:function(t,n){return n.handler.call(null,e)},cancelText:"取消"};angular.isFunction(t.remove)&&(n.destructiveText="删除",n.destructiveButtonClicked=function(){return t.remove(e)}),t.hideMenu=i.show(n)}}]).controller("FlowTodoCtrl",["$scope","$controller","$state","$ionicActionSheet","IbPopup","Flow","FlowTodo",function(t,e,n,i,r,o,a){e("FlowListCtrl",{$scope:t}),t.list=a,t.title="待办工作",t.init(),t.sref="workflow.handle({ key: flow.key })";var s=t.showMenu;t.showMenu=function(e){t.actionButtons=[],t.remove=!!e.del&&function(t){return o.confirmRemove(t),!0},s(e)}}]).controller("FlowTransCtrl",["$scope","$controller","Flow","FlowTrans",function(t,e,n,i){e("FlowListCtrl",{$scope:t}),t.list=i,t.title="已办结",t.init(),t.takeback=function(t){return n.confirmTakeback(t),!0};var r=t.showMenu;t.showMenu=function(e){t.actionButtons=[],e.rollback&&t.actionButtons.push({text:"收回",handler:function(e){return t.takeback(e)}}),r(e)}}]).controller("FlowDoneCtrl",["$scope","$controller","Flow","FlowDone",function(t,e,n,i){e("FlowListCtrl",{$scope:t}),t.list=i,t.title="已完成",t.init();var r=t.showMenu;t.showMenu=function(e){t.actionButtons=[],t.remove=!!e.del&&function(t){return n.confirmRemove(t),!0},r(e)}}]).controller("FlowFollowCtrl",["$scope","$controller","FlowFollow",function(t,e,n){e("FlowListCtrl",{$scope:t}),t.list=n,t.title="我的关注",t.init(),t.showMenu=angular.noop}]).controller("FlowCreateCtrl",["$scope","$rootScope","$state","$ionicModal","$ionicLoading","$ionicHistory","IbPopup","Flow",function(t,e,n,i,r,o,a,s){t.processes=[],t.categories=[],t.create=function(t){return r.show(),s.create(t.flowid).success(function(t){t.isSuccess?o.clearCache(["workflow.todo"]).then(function(){n.go("workflow.handle",{key:t.key})}):a.alert({title:t.msg})})["finally"](r.hide)};var c,l=e.$new(!0);l.processes=[],l.close=function(){c&&c.hide()},l.create=t.create,i.fromTemplateUrl("./templates/workflow/workflow-cate-modal.html",{scope:l,animation:"slide-in-up"}).then(function(t){c=t}),t.openCate=function(t){l.category=t,c.show()},t.$on("$ionicView.leave",function(){c&&c.hide()}),t.$on("$destroy",function(){c&&c.remove()}),t.loading=!0,s.getProcess().success(function(e){t.processes=e.common,t.categories=e.cate})["finally"](function(){t.loading=!1})}]).controller("FlowHandleCtrl",["$scope","$state","$stateParams","$timeout","$window","$ionicLoading","$ionicPopup","$ionicHistory","$ionicModal","$q","$filter","IbPopup","Settings","User","Flow","FlowUtils","icFactory","FlowUpload","FileUtils","IbPopup",function(t,e,n,i,r,o,a,s,c,l,u,d,f,p,m,h,g,v,w,d){function y(t){return!!t.title.trim()||(d.alert({title:"请输入标题"}),!1)}function $(){x.attachmentid=t.imageAttach.concat(t.fileAttach).map(function(t){return t.aid}).join(",");var e=g.serialize(angular.extend({},x),k.enableArr);if(y(e))return o.show(),m.saveFlow(e).success(o.hide).error(o.hide)}function b(e){o.show(),m.rollback(t.key,e).success(function(t){t.isSuccess?d.alert({title:"成功退回"}).then(function(){s.clearCache(["workflow.todo","workflow.trans"]).then(function(){s.goBack()})}):d.alert({title:t.msg}).then(function(){s.goBack()})})["finally"](o.hide)}function C(e){t.flow.backlist&&t.flow.backlist.length&&(t.rollbackData.stepId=t.flow.backlist[0].id,t.rollbackModal?t.rollbackModal.show():c.fromTemplateUrl("templates/workflow/backstep-modal.html",{scope:t,animation:"slide-in-up"}).then(function(n){n.show(),t.rollbackModal=n,t.rollbackModal.save=function(){b({remind:e,formhash:p.formhash,id:t.rollbackData.stepId}),n.hide()},t.$on("$destroy",function(){n.remove(),delete t.rollbackModal}),t.$on("$ionicView.leave",function(){n.hide()})}))}function D(e){angular.forEach(e,function(e){var n=e.filename.split(".").pop().toLowerCase();v.safeImgTypes.indexOf(n)!==-1?(e.url=u("fullUrl")(e.officereadurl),t.imageAttach.push(e)):t.fileAttach.push(e)})}function S(t){var e=[];return angular.forEach(t,function(t){e.push(t)}),e}var k=t.flow={},x=t.form={};t.key=n.key,t.formhash=p.formhash,t.isReadonly=function(t){return!!k.readonly&&k.readonly.split(",").indexOf(t["data-id"])!==-1},t.viewSource=function(){r.open(f.hostUrl+"?r=workflow/form/index&key="+t.key,"_blank","location=yes")},t.save=function(){$().success(function(){d.tip("保存成功")})},t.handover=function(){$().success(function(){var n="2"==t.flow.flow.type?"workflow.handoverFree":"workflow.handover";e.go(n,{key:t.key,topflag:t.flow.rp.topflag})})},t.rollbackData={},t.rollback=function(){a.show({template:'<input type="text" ng-model="rollbackData.remind">',title:"请输入回退原因",scope:t,buttons:[{text:"取消"},{text:"确定",type:"button-positive",onTap:function(e){return t.rollbackData.remind?t.rollbackData.remind:void e.preventDefault()}}]}).then(function(e){e&&("1"==t.flow.process.allowback?b({remind:e,formhash:p.formhash}):"2"==t.flow.process.allowback&&C(e))})},t.sign=function(){d.confirm({title:"确定该工作已经办结吗？"}).then(function(e){e&&(o.show(),m.signFlow(t.key,{topflag:k.rp.topflag,opflag:k.rp.opflag,content:t.form.content}).success(function(){s.clearCache(["workflow.todo","workflow.trans"]).then(function(){h.goBackOrHome()})})["finally"](o.hide))})},t.end=function(){d.confirm({title:"确认要结束该工作流程吗？"}).then(function(e){e&&(o.show(),m.signFlow(t.key,{topflag:k.rp.topflag,opflag:k.rp.opflag}).success(function(){s.clearCache(["workflow.todo","workflow.trans"]).then(function(){
h.goBackOrHome()})})["finally"](o.hide))})},t.imageAttach=[],t.fileAttach=[],t.addImage=function(e){var n=20,i=e.target.files;v.isSafeFile(v.safeImgTypes,i)&&v.isSafeSize(n,i)?v.upload(t,i,t.imageAttach,t.flow.process.processid):d.alert({title:"仅支持不超过"+n+"M的以下类型文件："+v.safeImgTypes.join(",")})},t.removeImage=function(e){t.imageAttach.splice(e,1)},t.isIos=ionic.Platform.isIOS(),t.checkIos=function(){if(t.isIos)return d.alert({title:"抱歉，暂不支持苹果系统及部分安卓系统上传附件"})},t.addFile=function(e){var n=e.target.files,i=20;return v.hasEmptyFile(n)?d.alert({title:"上传的文件中不能包含空文件"}):void(v.isSafeFile(v.safeFileTypes,n)&&v.isSafeSize(i,n)?v.upload(t,n,t.fileAttach,t.flow.process.processid):d.alert({title:"仅支持不超过"+i+"M的以下类型文件："+v.safeFileTypes.join(",")}))},t.removeFile=function(e){t.fileAttach.splice(e,1)},t.downloadFile=function(t){return t.entireattachurl?w.download(u("fullUrl")(t.entireattachurl)):void(t.url&&w.workflowDownload(t.url))},o.show(),m.getFlow(n.key).success(function(e){"undefined"==typeof e.isSuccess||e.isSuccess?(k=t.flow=e,!t.flow.feedback||t.flow.feedback instanceof Array||(t.flow.feedback=S(t.flow.feedback)),x.key=t.key,x.title=k.run.name,x.hidden=k.hidden,x.readonly=k.readonly,x.attachmentid=k.run.attachmentid,x.fbattachmentid="",x.topflag=k.rp.topflag,x.saveflag="",x.formhash=t.formhash,x.enablefiled=k.enablefiled+"",t.ics=[].concat(k.enableArr,k.valueArr),e.attachData&&D(e.attachData)):d.alert({title:e.msg}).then(function(){s.goBack()})})["finally"](o.hide)}]).controller("FlowHandoverCtrl",["$scope","$state","$stateParams","$timeout","$ionicLoading","IbPopup","Flow","FlowUtils",function(t,e,n,i,r,o,a,s){var c=t.data={},l=t.form={prcs_user_op:[],prcs_user:[],topflag:[],prcs_choose:{},remind:{1:!0,2:!1,3:!1}};t.save=function(){if(c.notAllFinished){var t="经办人 "+c.notAllFinished+" 未办理完毕";if("1"==c.process.turnpriv){if(!window.confirm(t+", 是否确认转交？"))return!1}else if("0"==c.process.turnpriv)return alert(t),!1}var e={runid:c.runid,flowid:c.flowid,processid:c.processid,flowprocess:c.flowprocess,processto:c.process.processto,prcsback:c.prcsback,message:l.message,remind:{},prcs_choose:[]};angular.forEach(l.prcs_choose,function(t,n){t.checked&&(e["prcs_user_op"+n]=l.prcs_user_op[n]||"",e["prcs_user"+n]=l.prcs_user[n]||"",e["topflag"+n]=l.topflag[n]||"0",t.isover||e.prcs_choose.push(t.value))}),angular.forEach(l.remind,function(t,n){t&&(e.remind[n]=t)}),e.prcs_choose.length||(e.prcs_user_op=e.prcs_user_op0,e.prcs_user=e.prcs_user0,delete e.prcs_user_op0,delete e.prcs_user0,delete e.topflag0),e.topflag=n.topflag,r.show(),a.handover(e).success(s.onHandoverSuccess)["finally"](r.hide)},t.initStep=function(e,n){l.prcs_choose[e]={checked:n.checked,value:e,isover:n.isover},0===e&&n.isover===!0&&t.selectStep(e,n)},t.selectStep=function(e,n){return 1==n.isover?(l.remind[1]=!1,l.remind[2]=!0,t.form.message="【"+t.data.run.name+"】流程已办理完毕，请在“流程结束”分类下查看该流程。谢谢。"):(l.remind[1]=!0,l.remind[2]=!1,t.form.message="办理工作【"+t.data.run.name+"】，谢谢"),0==t.data.process.syncdeal&&(l.prcs_choose[e].checked&&angular.forEach(l.prcs_choose,function(t){t.checked=!1}),void(l.prcs_choose[e].checked=!0))},t.notChildFlow=function(t){return t.process&&t.process.childflow&&"0"==t.process.childflow},t.validate=function(){var t=!0,e=l.prcs_choose,n=[];for(var i in e)e.hasOwnProperty(i)&&e[i].checked&&n.push(i);for(var r=0;r<n.length;r++){var i=n[r];if(e[i].isover){if(t=!0,c.prcsback&&(t=!!l.prcs_user_op[i],!t))break}else if(t="0"==l.topflag[i]?!!l.prcs_user_op[i]:!!l.prcs_user[i],!t)break}return t},r.show(),a.getNext(n).success(function(e){"string"==typeof e?o.alert({title:e}):(c=t.data=e,t.form.message="请您及时办理工作【"+t.data.run.name+"】，谢谢")})["finally"](r.hide)}]).controller("FlowHandoverFreeCtrl",["$scope","$state","$stateParams","$timeout","$ionicLoading","$ionicModal","$ionicScrollDelegate","IbPopup","User","Flow","FlowUtils",function(t,e,n,i,r,o,a,s,c,l,u){function d(t){return!("0"==t.topflag&&!t.prcsUserOp)&&!("0"!=t.topflag&&!t.prcsUser)}var f=t.run={},p=t.form={next:{topflag:"0"},preset:[],field:[]};t.addPreset=function(){p.preset.push({topflag:"0",prcsUserOp:"",prcsUser:""}),i(function(){a.resize()})},o.fromTemplateUrl("./templates/workflow/workflow-field-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.modal=e}),t.removePreset=function(t){p.preset.splice(t,1)},t.getPresetIndex=function(t,e){return t+1+ +f.processid},t.save=function(){if(f.notAllFinished){var t="经办人 "+f.notAllFinished+" 未办理完毕";if(!window.confirm(t+", 是否确认转交？"))return!1}var e={op:f.op,key:f.key,topflagOld:f.topflag,freeItemOld:"",tmpCount:"",lineCount:p.preset.length,message:p.message,formhash:c.formhash};""!=f.preset?(e.preset="1",e.prcsUserOp="1",e.prcsUser="1",e.topflag="1"):(e.topflag=p.next.topflag,e.prcsUserOp=c.addPrefix(p.next.prcsUserOp),e.prcsUser=c.addPrefix(p.next.prcsUser),angular.forEach(p.preset,function(t,n){var i=n+1;e["topflag"+i]=t.topflag,e["prcsUserOp"+i]=c.addPrefix(t.prcsUserOp),e["prcsUser"+i]=c.addPrefix(t.prcsUser)}),angular.forEach(p.field,function(t){e.freeItemOld+=e.freeItemOld?","+t:t})),r.show(),l.handoverFree(e).success(u.onHandoverSuccess)["finally"](r.hide)},t.validate=function(){if(""!=f.preset)return!0;if(!d(p.next))return!1;var t,e=0;if(t=p.preset.length)for(;e<t;e++)if(!d(p.preset[e]))return!1;return!0},r.show(),l.getFreeNext(n.key).success(function(e){"string"==typeof e?s.alert({title:e}):(f=t.run=e,t.form.message="请您及时办理工作【"+f.runName+"】，谢谢")})["finally"](r.hide),t.$on("$ionicView.leave",function(){t.modal.hide()}),t.$on("$destroy",function(){t.modal.remove()})}]).controller("FlowDetailCtrl",["$scope","$state","$stateParams","$timeout","$window","$ionicLoading","$ionicPopup","$filter","IbPopup","Settings","User","Flow","FlowUtils","FileUtils","FlowUpload",function(t,e,n,i,r,o,a,s,c,l,u,d,f,p,m){function h(e){angular.forEach(e,function(e){var n=e.filename.split(".").pop().toLowerCase();m.safeImgTypes.indexOf(n)!==-1?(e.url=s("fullUrl")(e.officereadurl),t.imageAttach.push(e)):t.fileAttach.push(e)})}function g(t){var e=[];return angular.forEach(t,function(t){e.push(t)}),e}t.flow={},t.key=n.key,t.formhash=u.formhash,t.viewSource=function(){r.open(l.hostUrl+"?r=workflow/preview/print&key="+t.key,"_blank","location=yes")},o.show(),t.imageAttach=[],t.fileAttach=[],t.downloadFile=function(t){return t.entireattachurl?p.download(s("fullUrl")(t.entireattachurl)):void(t.url&&p.workflowDownload(t.url))},d.getFlow(n.key,{type:"view"}).success(function(e){"undefined"==typeof e.isSuccess||e.isSuccess?(t.flow=e,!t.flow.feedback||t.flow.feedback instanceof Array||(t.flow.feedback=g(t.flow.feedback)),e.attachData&&h(e.attachData)):c.alert({title:"提示",template:e.msg}).then(f.goBackOrHome)})["finally"](o.hide)}]),angular.module("workflow.directives",[]).directive("icErrorTip",function(){return{restrict:"E",template:'<div ng-if="error.notempty" class="assertive fss">“{{ title }}”不能为空</div><div ng-if="error.chinese" class="assertive fss">“{{ title }}”只能为中文</div><div ng-if="error.letter" class="assertive fss">“{{ title }}”只能为英文</div><div ng-if="error.num" class="assertive fss">“{{ title }}”只能为数字</div><div ng-if="error.idcard" class="assertive fss">“{{ title }}”只能为身份证</div><div ng-if="error.mobile" class="assertive fss">“{{ title }}”只能为手机号码</div><div ng-if="error.money" class="assertive fss">“{{ title }}”只能为金额</div><div ng-if="error.tel" class="assertive fss">“{{ title }}”只能为电话号码</div><div ng-if="error.zipcode" class="assertive fss">“{{ title }}”只能为邮政编码</div><div ng-if="error.email" class="assertive fss">“{{ title }}”只能为Email</div>',scope:{error:"=",title:"="}}}).controller("icCtrl",["$scope","icPatternByTypeFilter",function(t,e){t.addPattern=function(n,i){function r(t){var r,o=!0;return i&&(t?(r=new RegExp(e(i)),o=r.test(t)):o=!1),n.$setValidity(i,o),o?t:void 0}n&&(n.$parsers.unshift(r),n.$formatters.unshift(r),t.$error=n.$error)}}]).directive("ic",["$parse","$rootScope","$location","$compile","icPatternByTypeFilter","icFactory",function(t,e,n,i,r,o){return e.icModelCtrls={},{restrict:"E",require:"?ngModel",controller:"icCtrl",template:'<ic-error-tip error="$error" title="ic[\'data-title\']"></ic-error-tip>',compile:function(r,a){var s,c=n.absUrl();return e.icModelCtrls[c]||(e.icModelCtrls[c]={}),s=e.icModelCtrls[c],function(e,n,r,c){var l=e.ic=t(a.data)(e)||{},u=t(a.ics)(e)||[];e.getIc=function(t){return u.filter(function(e){return e["data-id"]==t})[0]},e.setValue=function(t,e){s[t]&&s[t].$setViewValue(e)},e.getValue=function(t){if(s[t])return s[t].$viewValue;var n=e.getIc(t);return n?n["origin-value"]:""},c&&(s[l["data-id"]]=c,"date"!==l["data-type"]&&c.$setViewValue(l["origin-value"]||l["data-value"]||void 0),e.addPattern(c,r.patternType));var d=o.parse(l,r.ngModel,e),f=i(d)(e);n.addClass("wfic wfic-"+l["data-type"]),n.prepend(f)}}}}]).directive("icLabel",function(){return{restrict:"E",replace:!0,scope:{data:"="},template:'<span ng-style="getStyle()">{{ data["data-text"]  }}</span>',link:function(t){t.getStyle=function(){var e=t.data;return{"text-align":e["data-align"],"font-weight":1==e["data-bold"]?"700":"400","font-size":e["data-font-size"],"font-style":1==e["data-italic"]?"italic":"normal","text-decoration":1==e["data-underline"]?"underline":"normal",color:e["data-color"]}}}}}).constant("ROW_SPLITTER",/\n/g).constant("COL_SPLITTER","`").constant("VAL_SPLITTER",",").controller("icListViewCtrl",["$scope","$timeout","$ionicScrollDelegate","ROW_SPLITTER","COL_SPLITTER","VAL_SPLITTER",function(t,e,n,i,r,o){var a=t.split=function(t,e){return angular.isString(t)?t.split(e):[]},s=t.splitRaws=function(e){var n=[];if(angular.isString(e)){var o=t.split(e,i);angular.forEach(o,function(e){e&&n.push(t.split(e,r))})}return n};t.rows=[],t.lvTitles=a(t.data["data-lv-title"],r),t.lvColtypes=a(t.data["data-lv-coltype"],r),t.lvColvalues=a(t.data["data-lv-colvalue"],r),t.lvSums=a(t.data["data-lv-sum"],r),Array.prototype.push.apply(t.rows,s(t.data["origin-value"])),t.scrollDeletage=n.$getByHandle("ic-listview-"+t.data["data-title"]),e(function(){var e=t.scrollDeletage.getScrollView(),n=e.__container;n.removeEventListener("touchstart",e.touchStart),n.removeEventListener("mousedown",e.mouseDown),document.removeEventListener("touchmove",e.touchMove),document.removeEventListener("mousemove",e.mouseMove),angular.forEach(["touchStart","mouseDown","touchMove","mouseMove"],function(t){var n=e[t];e[t]=function(t){t.preventDefault=angular.noop,n&&n.call(e,t)}}),n.addEventListener("touchstart",e.touchStart,!1),n.addEventListener("mousedown",e.mouseDown,!1),document.addEventListener("touchmove",e.touchMove,!1),document.addEventListener("mousemove",e.mouseMove,!1)})}]).directive("icListview",["$ionicModal","$rootScope","$location","COL_SPLITTER","VAL_SPLITTER",function(t,e,n,i,r){return{restrict:"E",replace:!0,require:"ngModel",controller:"icListViewCtrl",scope:{data:"="},templateUrl:"templates/workflow/ic-listview.html",link:function(o,a,s,c){function l(t){var e=o.lvColtypes[t],n=o.lvColvalues[t];return["select","radio"].indexOf(e)!==-1?n.split(r)[0]||"":["text","textarea","date"].indexOf(e)!==-1?n:""}function u(){return o.lvColvalues.map(function(t,e){return l(e)})}function d(t){var e="";angular.isArray(t)&&t.length&&(e=o.joinRows(t)),c.$setViewValue(e),c.$render()}var f=e.icModelCtrls[n.absUrl()];f&&(f[o.data["data-id"]]=c),o.modal=null,o.edittingRow={},o.edittingRowIndex=-1,t.fromTemplateUrl("templates/workflow/ic-listview-modal.html",{scope:o}).then(function(t){o.modal=t}),o.joinRows=function(t){return t.map(function(t){return t.join(i)}).join("\n")},o.splitValue=function(t){return o.split(o.lvColvalues[t],r)},o.addRow=function(){o.edittingRow=u(),o.edittingRowIndex=-1,o.modal&&o.modal.show()},o.editRow=function(t){o.edittingRow=angular.copy(o.rows[t]),o.edittingRowIndex=t,o.modal&&o.modal.show()},o.removeRow=function(){o.rows.splice(o.edittingRowIndex,1),o.rows.length||o.scrollDeletage.scrollTop(!0),o.modal&&o.modal.hide()},o.save=function(){o.modal&&o.modal.hide(),o.edittingRowIndex===-1?o.rows.push(o.edittingRow):o.rows.splice(o.edittingRowIndex,1,o.edittingRow),o.edittingRow={},o.edittingRowIndex=-1},o.$watch("rows",d,!0)}}}]).directive("icListviewView",function(){return{restrict:"E",replace:!0,transclude:!0,controller:"icListViewCtrl",scope:{data:"=",onRowClick:"="},templateUrl:"templates/workflow/ic-listview-view.html",link:angular.noop}}).directive("icListviewCalc",function(){return{restrict:"E",require:"ngModel",replace:!0,template:'<input type="hidden" />',scope:{exp:"=",rowData:"="},link:function(t,e,n,i){if(t.__parseInt=function(t){return parseInt(t,10)},!angular.isString(t.exp))throw new Error("列表控件计算公式出错");var r=t.exp.replace(/\[(\d+)\]/g,function(t,e){return"__parseInt(rowData["+(e-1)+"])"});t.$watch(r,function(t){angular.isUndefined(t)?t=r:isNaN(t)&&(t=0),i.$setViewValue(t),i.$render()})}}}).directive("icListviewCheckbox",["VAL_SPLITTER",function(t){return{restrict:"E",require:"ngModel",template:'<label ng-repeat="item in list" class="checkbox"> <input type="checkbox" ng-model="item.checked" ng-change="updateViewValue()"> {{ item.value }}</label>',scope:{values:"="},link:function(e,n,i,r){e.list=[],e.$watch("values",function(n){var i=r.$viewValue,o=angular.isString(i)?i.split(t):[];n=n||"",e.list=n.split(t).map(function(t){return{value:t,checked:o.indexOf(t)!==-1}})}),e.updateViewValue=function(){var n=e.list.filter(function(t){return t.checked}).map(function(t){return t.value}).join(t);r.$setViewValue(n)}}}}]).controller("IcImguploadCtrl",["$scope","$window","attrFromTemplateFilter",function(t,e,n){t.setSizeAdjustWidth=function(e){var n=t.data["data-width"],i=t.data["data-height"],r=e.clientWidth;n&&i&&(n>r?(t.width=r,t.height=i/n*r):(t.width=n,t.height=i))},t.initAutoSizeAdjust=function(n){t.setSizeAdjustWidth(n),e.addEventListener("resize",function(){t.setSizeAdjustWidth(n),t.$applyAsync()},!1)},t.hasSrc=function(){return t.localSrc||t.originSrc};try{t.originSrc=n(t.data.value,"data-src")}catch(i){t.originSrc="",console.error("ic-imgupload: 获取原始图片地址失败")}}]).directive("icImgupload",["Utils",function(t){return{restrict:"E",require:"ngModel",scope:{data:"="},controller:"IcImguploadCtrl",replace:!0,templateUrl:"templates/workflow/ic-imgupload.html",link:function(e,n,i,r){r.$setViewValue(new File([],"")),e.updateFile=function(n){var i=n.target.files[0];i&&(r.$setViewValue(i),t.getImagePreviewUrl(i,function(t){e.localSrc=t,e.$applyAsync()}))},e.initAutoSizeAdjust(n[0])}}}]).directive("icImguploadView",function(){return{restrict:"E",scope:{data:"="},controller:"IcImguploadCtrl",replace:!0,templateUrl:"templates/workflow/ic-imgupload-view.html",link:function(t,e,n){t.initAutoSizeAdjust(e[0])}}}).directive("icFileupload",["$window","FileUtils","fullUrlFilter",function(t,e,n){return{restrict:"E",require:"ngModel",controller:"icCtrl",scope:{data:"=",name:"="},replace:!0,templateUrl:"templates/workflow/ic-fileupload.html",link:function(i,r,o,a){if(i.data["origin-value"]&&i.data.value){var s=angular.element(i.data.value)[0].dataset;i.file=angular.extend({},s)}i.selectFile=function(t){var n=t.target.files[0];n&&(a.$setViewValue(n),i.file={iseditable:"1",read:"1",name:n.name,type:e.getExtname(n.name),src:"",value:""},t.target.value="",a.$setValidity("notempty",!0),i.$applyAsync())},i.removeFile=function(){delete i.file,a.$setViewValue(null),"notempty"==o.patternType&&(a.$error.notempty=!0,i.addPattern(a,o.patternType))},i.download=function(){t.location.href=n(i.file.src)},i.hasOwnProperty("file")&&""==i.file.name&&delete i.file,"notempty"==o.patternType&&i.hasOwnProperty("file")&&void 0!=i.file.src&&""!=i.file.src?(a.$setValidity("notempty",!0),i.$applyAsync()):i.addPattern(a,o.patternType)}}}]).directive("icFileuploadView",["$window","FileUtils","fullUrlFilter",function(t,e,n){return{restrict:"E",scope:{data:"="},replace:!0,templateUrl:"templates/workflow/ic-fileupload-view.html",link:function(e,i,r){if(e.data["origin-value"]&&e.data.value){var o=angular.element(e.data.value)[0].dataset;e.file=angular.extend({},o)}e.download=function(){t.location.href=n(e.file.src)}}}}]).directive("icFileuploadHidden",function(){return{restrict:"E",require:"ngModel",scope:{data:"=",file:"=",name:"=",value:"=ngModel"},replace:!0,template:'<div><input type="hidden" value="{{ value }}" name="{{ name }}"/></div>',link:function(t,e,n,i){t.$watch(function(){return t.data["origin-value"]},function(t){i.$setViewValue(t)}),t.$watch("file",function(t){t?i.$setViewValue(t.name):null===t&&i.$setViewValue("")})}}}).directive("icSign",["$q","$window","$ionicModal","$ionicLoading","IbPopup","CommonApi",function(t,e,n,i,r,o){function a(t,e){for(var n,i,r,o,e=e||[0,0,0,0],a=t.getContext("2d").getImageData(0,0,t.width,t.height).data,s=0;s<t.width;s++)for(var c=0;c<t.height;c++){var l=4*(t.width*c+s),u=a[l],d=a[l+1];cb=a[l+2],ca=a[l+3],e[0]===u&&e[1]===d&&e[2]===cb&&e[3]===ca||("undefined"==typeof n?(n=i=s,r=o=c):(n=Math.min(s,n),i=Math.max(s,i),r=Math.min(c,r),o=Math.max(c,o)))}return{offsetLeft:n,offsetRight:i,offsetTop:r,offsetBottom:o,width:i-n+1,height:o-r+1}}function s(t){var e=document.getElementById(t),n=10,i="";if(e){var r=a(e,[255,255,255,255]),o=document.createElement("canvas"),s=o.getContext("2d");o.width=r.width+2*n,o.height=r.height+2*n,s.drawImage(e,r.offsetLeft,r.offsetTop,r.width,r.height,n,n,r.width,r.height),i=o.toDataURL(),o=s=null}return i}var c=0;return{restrict:"E",require:"ngModel",controller:"icCtrl",scope:{data:"=",src:"=ngModel",patternType:"@"},replace:!0,templateUrl:"templates/workflow/ic-sign.html",link:function(t,a,l,u){var d="icSignCanvas"+c++;t.pwCanvas={options:{undo:!0,width:e.innerWidth,height:e.innerHeight,lineWidth:5,color:t.data["data-sign-color"]||"#000",customCanvasId:d},version:0},n.fromTemplateUrl("templates/workflow/ic-sign-modal.html",{scope:t}).then(function(e){t.modal=e,t.modal.hideDelay=!0}),t.reset=function(){0===t.pwCanvas.version?t.modal.hide():t.pwCanvas.version=0},t.done=function(){if(0!==t.pwCanvas.version){var e=s(d);i.show(),o.uploadBase64Img(e).success(function(e){e.isSuccess?(u.$setViewValue(e.host+e.data),u.$render(),t.modal.hide()):r.tip("手写签名保存失败，请重试")}).error(function(){r.tip("手写签名保存失败，请重试")})["finally"](function(){i.hide(),t.reset()})}else t.modal.hide()},t.remove=function(){u.$setViewValue(""),u.$render()},t.addPattern(u,l.patternType),t.data["origin-value"]&&u.$setViewValue(t.data["origin-value"])}}}]).directive("icScript",["$document","IbPopup",function(t,e){return{restrict:"E",scope:{data:"="},link:function(n){var i=t[0],r=!1;n.$watch("data",function(t){if(t&&!r){try{var o=i.createElement("script");o.innerHTML=n.data,i.body.appendChild(o)}catch(a){e.tip("自定义脚本执行出错")}r=!0}})}}}]).directive("wfProcess",function(){return{restrict:"E",replace:!0,scope:{process:"="},templateUrl:"templates/workflow/wf-process.html"}}).directive("wfIcValueFields",function(){return{restrict:"E",replace:!0,scope:{fields:"=",hiddenField:"="},templateUrl:"templates/workflow/wf-ic-value-fields.html",link:function(t){t.isHidden=function(e){return!(!angular.isString(t.hiddenField)||!t.hiddenField)&&t.hiddenField.split(",").indexOf(e["data-id"])!==-1}}}}).directive("wfIcEmptyFields",["$ionicScrollDelegate",function(t){return{restrict:"E",scope:{fields:"="},templateUrl:"templates/workflow/wf-ic-empty-fields.html",link:function(e){e.emptyFieldShown=!1,e.toggleFieldShown=function(){e.emptyFieldShown=!e.emptyFieldShown,t.resize()}}}}]),function(){var t=function(){function t(t,e){return{restrict:"A",link:function(n,i,r){var o=r.horizontalScrollFix,a=r.delegateHandle,s=function(t){return t.touches&&(t.touches.length?t.touches:[{pageX:t.pageX,pageY:t.pageY}])},c=function(){var n,i;n=e.$getByHandle(o).getScrollView(),i=e.$getByHandle(a).getScrollView(),i.__container.removeEventListener("touchstart",i.touchStart),i.touchStart=function(e){var r;if(i.startCoordinates=ionic.tap.pointerCoord(e),!ionic.tap.ignoreScrollStart(e)){if(i.__isDown=!0,ionic.tap.containsOrIsTextInput(e.target)||"SELECT"===e.target.tagName)return void(i.__hasStarted=!1);i.__isSelectable=!0,i.__enableScrollY=!0,i.__hasStarted=!0,i.doTouchStart(s(e),e.timeStamp),r=n.__scrollTop,t(function(){var t,e;return e=r-n.__scrollTop,i.__isDragging&&e<2&&e>-2?(n.__isTracking=!1,n.doTouchEnd(),t=!1,n.scrollTo(0,r,t)):i.doTouchEnd()},100)}},i.__container.addEventListener("touchstart",i.touchStart)};t(function(){c()})}}}return t}();angular.module("workflow.directives").directive("horizontalScrollFix",["$timeout","$ionicScrollDelegate",t])}.call(this),angular.module("workflow.filters",[]).filter("wfStatus",function(){var t={1:"未接收",2:"办理中",3:"转交下一步，下一步经办人无人接收",5:"自由流程预设步骤",4:"已办结",6:"已挂起"};return function(e){return t[+e]||""}}).filter("wfic",["userInfoFilter","departmentInfoFilter","positionInfoFilter","User",function(t,e,n,i){var r={user:function(r){var o=r["origin-value"];switch(r["data-select-type"]){case"department":return e(i.removeDepartmentPrefix(o),"deptname");case"position":return n(i.removePositionPrefix(o),"posname");default:return t(i.removePrefix(o),"realname")}}};return function(t){var e=t["data-type"];return r[e]?r[e].call(null,t):t["origin-value"]}}]).filter("attrFromTemplate",function(){return function(t,e){var n;return t&&(n=angular.element(t),n.length&&e)?n.attr(e)||"":""}}).filter("icPatternType",function(){function t(t){var e={};return t.split(",").forEach(function(t){var n=t.split("=");e[n[0]]=n[1]}),e}return function(e,n){var i,r="";return e&&n&&(i=t(n),r=i[e]||""),r}}).filter("icPatternByType",["icPatternTypeFilter","REGEXP_ENUM",function(t,e){return function(t){return e[t]||""}}]).filter("icPattern",["icPatternTypeFilter","REGEXP_ENUM",function(t,e){return function(n,i){return e[t(n,i)]||""}}]).filter("wfFilenameFormat",function(){var t=function(t){return t.replace(/&#(x)?([^&]{1,5});?/g,function(t,e,n){return String.fromCharCode(parseInt(n,e?16:10))})};return function(e){var n=t(e).split("."),i="."+n.pop(),r=n.join(".");return r.length>18?r.slice(0,14)+"..."+r.slice(-4)+i:e}}).filter("wfIsSponsor",function(){return function(t){return t&&t.rp&&"1"==t.rp.opflag}}).filter("sumArrayBy",function(){return function(t,e){e=angular.isDefined(e)?e:0;var n=t.map(function(t){return angular.isArray(t)&&angular.isDefined(t)?t[e]:0});return n.reduce(function(t,e){return t=isNaN(+t)?0:+t,e=isNaN(+e)?0:+e,t+e},0)}}),angular.module("workflow.services",[]).factory("Flow",["$rootScope","$http","$ionicLoading","Utils","Settings","User","IbPopup",function(t,e,n,i,r,o,a){var s=r.rootUrl+"/work",c={create:function(n){return e.get(s+"/add",{params:{flowid:n}}).success(function(e){t.$broadcast("workflow.create",n,e)}).error(r.requestError)},getFlow:function(t,n){return n=n||{},n.key=t,e.get(s+"/form",{params:n}).error(r.requestError)},getProcess:function(){return e.get(s+"/new").error(r.requestError)},saveFlow:function(e){var n=new FormData;return angular.forEach(e,function(t,e){n.append(e,t)}),i.postFormData(s+"/form",n).success(function(n){t.$broadcast("workflow.saveFlow",e,n)}).error(r.requestError)},getNext:function(t){return e.get(s+"/shownext",{params:t}).error(r.requestError)},getFreeNext:function(t){return e.get(s+"/freenext",{params:{key:t}}).error(r.requestError)},rollback:function(n,i){return e.post(s+"/fallback&key="+n,i).success(function(e){e.isSuccess&&t.$broadcast("workflow.rollback",n,i,e)}).error(r.requestError)},takeback:function(n){return e.post(s+"/takeback&key="+n).success(function(e){e.isSuccess&&t.$broadcast("workflow.takeback",n,e)}).error(r.requestError)},confirmTakeback:function(t){var e=this;a.confirm({title:"下一步骤尚未接收时可收回至本步骤重新办理，确认要收回吗？"}).then(function(i){i&&(n.show(),e.takeback(t.key)["finally"](n.hide))})},handover:function(n){return e.post(s+"/turnNextPost",n).success(function(e){e.isSuccess&&t.$broadcast("workflow.handover",n,e)}).error(r.requestError)},handoverFree:function(n){return e.post(s+"/freenext",n).success(function(e){t.$broadcast("workflow.handoverFree",n,e)}).error(r.requestError)},signFlow:function(n,i){return i=i||{},i.key=n,e.get(s+"/complete",{params:i}).success(function(e){t.$broadcast("workflow.signFlow",i,e)}).error(r.requestError)},remove:function(n){return e.post(s+"/del",{id:n}).success(function(e){e.isSuccess&&t.$broadcast("workflow.remove",n,e)}).error(r.requestError)},confirmRemove:function(t){var e=this;a.confirm({title:"确定要删除该工作吗？"}).then(function(n){n&&e.remove(t.runid)})}};return c}]).factory("FlowUtils",["$timeout","$state","$ionicHistory","IbPopup",function(t,e,n,i){return{goBackOrHome:function(){n.backView()?n.goBack():(n.nextViewOptions({disableBack:!0}),e.go("workflow.index"))},onHandoverSuccess:function(r){if(r.isSuccess){var o=i.alert({title:"转交成功"});o.then(function(){n.clearCache(["workflow.todo","workflow.trans","workflow.done"]),n.nextViewOptions({disableBack:!0});var t=n.backView().stateId,i=n.currentView().stateId;e.go("workflow.index").then(function(){n.clearCache([t,i])})}),t(o.close.bind(o),2e3)}else i.alert({title:r.msg})}}}]).factory("FlowListUtil",function(){return{removeByKey:function(t){var e=this;this.items.length&&angular.forEach(this.items,function(n,i){if(n.key==t)return e.items.splice(i,1),!1})}}}).factory("FlowTodo",["$rootScope","Settings","IbList",function(t,e,n){var i=new n(e.rootUrl+"/work&type=todo",{idAttr:"runid"}),r=angular.bind(i,i.reset);return t.$on("workflow.handover",r),t.$on("workflow.handoverFree",r),t.$on("workflow.signFlow",r),t.$on("workflow.create",r),t.$on("workflow.rollback",r),t.$on("workflow.takeback",r),t.$on("workflow.remove",function(t,e){i.remove(e)}),i}]).factory("FlowTrans",["$rootScope","Settings","IbList","FlowListUtil",function(t,e,n,i){var r=new n(e.rootUrl+"/work&type=trans",{idAttr:"runid"});angular.extend(r,i);var o=angular.bind(r,r.reset);return t.$on("workflow.handover",o),t.$on("workflow.handoverFree",o),t.$on("workflow.signFlow",o),t.$on("workflow.rollback",o),t.$on("workflow.remove",function(t,e){r.remove(e)}),t.$on("workflow.takeback",function(t,e,n){r.removeByKey(e)}),r}]).factory("FlowDone",["$rootScope","Settings","IbList",function(t,e,n){var i=new n(e.rootUrl+"/work&type=done",{idAttr:"runid"}),r=angular.bind(i,i.reset);return t.$on("workflow.handover",r),t.$on("workflow.handoverFree",r),t.$on("workflow.signFlow",r),t.$on("workflow.rollback",r),t.$on("workflow.remove",function(t,e){i.remove(e)}),i}]).factory("FlowFollow",["$rootScope","Settings","IbList",function(t,e,n){var i=new n(e.rootUrl+"/work/follow",{idAttr:"runid"});return t.$on("workflow.remove",function(t,e){i.remove(e)}),i}]).service("FlowUpload",["Settings","FileUtils","IbPopup","UploadFile","fileSizeFilter","Utils",function(t,e,n,i,r,o){var a=this;this.safeImgTypes=["gif","jpg","jpeg","png"],this.safeFileTypes=["chm","pdf","zip","rar","tar","gz","bzip2","txt","doc","xls","ppt","docx","xlsx","pptx"],this.isSafeFile=function(t,n){for(var i=0;i<n.length;i++){var r=n[i],o=e.getExtname(r.name).toLowerCase();if(t.indexOf(o)===-1)return!1}return!0},this.hasEmptyFile=function(t){for(var e=0;e<t.length;e++){var n=t[e];if(0===n.size)return!0}return!1},this.isSafeSize=function(t,e){for(var n=0;n<e.length;n++){var i=e[n];if(i.size>1024*t*1024)return!1}return!0},this.closeLoading=function(t,e){t.$apply(function(){e.uploading=!1,e.uploaded=!0})},this.upload=function(t,e,s,c){angular.forEach(e,function(e){var l={filename:e.name,filesize:r(e.size),filetype:e.type.split("/")[1],"delete":!0,xhr:null,uploading:!0,uploaded:!1};o.getImagePreviewUrl(e,function(t){l.url=t}),l.index=s.length,t.$apply(function(){s.push(l)});var u=new FormData;u.append("Filedata[]",e),l.xhr=i.upload({data:u,params:{type:"workflow",flowprocess:c},onSuccess:function(e){a.closeLoading(t,l),e.isSuccess?l.aid=e.data[0].aid:(s.splice(l.index,1),n.alert({title:e.msg}))},onProgress:function(t){},onFail:function(t){if(s.splice(l.index,1),t){var e=t.msg||"上传失败";n.alert({title:e})}}})})}}]).factory("icFactory",["$filter","$timeout","attrFromTemplateFilter","Utils","UserSelector","User",function($filter,$timeout,attrFromTemplateFilter,Utils,UserSelector,User){function removeStyle(t){return t?t.replace(/\s+style=['"].*?['"]/g,""):""}function getIc(t,e){for(var n in e.flow.enableArr){var i=e.flow.enableArr[n];if(i["data-id"]==t)return i}return null}var ics={text:function(t,e){return"1"==t["data-hide"]?'<input type="hidden" ng-model="'+e+'" name="data_'+t["data-id"]+'">隐藏字段':'<input type="text" ng-model="'+e+'" name="data_'+t["data-id"]+'">'},textarea:function(t,e){return'<textarea ng-model="'+e+' " name="data_'+t["data-id"]+'" rows="'+t["data-rows"]+'" style="width: 100%;"></textarea>'},select:function(t,e,n){return n.options=t["data-select-field"].split("`"),t["origin-value"]||$timeout(function(){n.setValue(t["data-id"],t["data-select-check"])},100),'<select ng-model="'+e+'" ng-init="'+e+'= options[0]"  name="data_'+t["data-id"]+'" size="'+t["data-size"]+'"><option ng-selected="op=='+e+'"  value="{{op}}" ng-repeat="op in options">{{op}}</option></select>'},radio:function(t,e,n){return n.radios=t["data-radio-field"].split("`"),t["origin-value"]||n.setValue(t["data-id"],t["data-radio-check"]),'<label class="checkbox" ng-repeat="r in radios"><input type="radio" ng-model="'+e+'" name="data_'+t["data-id"]+'" value="{{r}}">{{r}}</label>'},checkbox:function(t,e){return'<label class="checkbox"><input type="checkbox" ng-model="'+e+'" ng-true-value="\'on\'" ng-false-value="" name="data_'+t["data-id"]+'">'+t["data-title"]+"</label>"},date:function(t,e,n){var i,r,o=$filter("date"),a=Utils.isFormTypeSupported,s=t["data-date-format"].replace("mm","MM").replace("hh","HH").replace("ii","mm"),c=t["origin-value"],l="";if(c){var u=c.split(/[\-\s\:]/);i=new Date(u[0],u[1]?+u[1]-1:0,u[2]?+u[2]:1,u[3]?+u[3]:0,u[4]?+u[4]:0,u[5]?+u[5]:0)}var d="yyyy-MM-dd"==s||"yyyy-MM"==s||"yyyy"==s,f="yyyy-MM-dd HH:mm:ss"==s||"yyyy-MM-dd HH:mm"==s||"yyyy-MM-dd HH"==s;d&&a("date")?(r="date",i&&(c=i)):f&&a("datetime-local")?(r="datetime-local",i&&(c=i)):(r="text",l="格式为 "+o(new Date,s));var p='<input type="'+r+'" ng-model="'+e+'" placeholder="'+l+'" name="data_'+t["data-id"]+'"/><span class="rp-icon-calendar"></span>';return n.setValue(t["data-id"],c),p},user:function(t,e,n){function i(t){r=t}var r,o,a=t["data-select-type"],s=t["data-single"],c={maxSelection:1==s&&1};return"position"==a?(o=User.removePositionPrefix(n.ic["origin-value"]),UserSelector.createPosition(c).then(i)):"department"==a?(o=User.removeDepartmentPrefix(n.ic["origin-value"]),UserSelector.createDepartment(c).then(i)):(o=User.removePrefix(n.ic["origin-value"]),UserSelector.create(c).then(i)),n.select=function(){o=n.getValue(t["data-id"]),r.show({values:o?o.split(","):[]},function(e){n.setValue(t["data-id"],e.join(",")),r.hide()})},n.$on("$destroy",function(){r.remove()}),n.setValue(t["data-id"],o),'<user-selector select-type="'+t["data-select-type"]+'" name="data_'+t["data-id"]+'" ng-model="'+e+'"></user-selector> <i class="icon ion-ios-plus positive" ng-click="select()"></i>'},auto:function(t,e,n){var i;return t["origin-value"]||n.setValue(t["data-id"],attrFromTemplateFilter(t.value,"value")),i=removeStyle(t.value).replace(/<(input|select|textarea)\s+/,function(t){return t+' ng-model="'+e+'" '}),1!=t["data-hide"]?i:i+"隐藏字段"},calc:function(ic,modelName,scope){function setPrec(t){return(+t).toFixed(ic["data-prec"])}var calc={getVal:function(t){var e=scope.getIc(t),n=0;return e&&"date"===e["data-type"]?n=new Date(scope.getValue(t)):e&&"listview"===e["data-type"]?n=scope.getValue(t):(n=parseFloat(scope.getValue(t)),isNaN(n)&&(n=0)),n},date:function(t){return t/=1e3,t>=0?Math.floor(t/86400)+"天"+Math.floor(t%86400/3600)+"小时"+Math.floor(t%3600/60)+"分"+Math.floor(t%60)+"秒":"时间格式无效"},day:function(t){return setPrec(t<=0?0:Math.floor(t/864e5))},hour:function(t){return setPrec(t<=0?0:Math.floor(t/36e5))},sum:function(){if(0===arguments.length)return"";for(var t=arguments,e=0,n=0;n<t.length;n++)e+=t[n];return setPrec(parseFloat(e))},max:function(){return 0===arguments.length?"":setPrec(parseFloat(Math.max.apply(null,arguments)))},min:function(){return 0===arguments.length?"":setPrec(parseFloat(Math.min.apply(null,arguments)))},mod:function(){if(0!==arguments.length){
var t=arguments[0],e=arguments[1],n=t%e;return n=isNaN(n)?"":parseFloat(n),setPrec(n)}},abs:function(t){return setPrec(Math.abs(parseFloat(t)))},avg:function(){for(var t=0,e=arguments.length,n=0;n<e;n++)t+=parseFloat(arguments[n]||0);return setPrec(t/e)},rmb:function(t){var e,n,i,r,o,a,s,c,l,u,d,f,p,m,h=99999999999.99;if(t=t.toString(),""==t)return"";if(null!=t.match(/[^,.\d]/))return"";if(null==t.match(/^((\d{1,3}(,\d{3})*(.((\d{3},)*\d{1,3}))?)|(\d+(.\d+)?))$/))return"";if(t=t.replace(/,/g,""),t=t.replace(/^0+/,""),Number(t)>h)return"";if(r=t.split("."),r.length>1?(e=r[0],n=r[1],n=n.substr(0,2)):(e=r[0],n=""),o=["零","壹","贰","叁","肆","伍","陆","柒","捌","玖"],a=["","拾","佰","仟"],s=["","万","亿"],c=["角","分"],i="",Number(e)>0){for(l=0,u=0;u<e.length;u++)d=e.length-u-1,f=e.substr(u,1),p=d/4,m=d%4,"0"==f?l++:(l>0&&(i+=o[0]),l=0,i+=o[Number(f)]+a[m]),0==m&&l<4&&(i+=s[p]);i+="元"}if(""!=n)for(u=0;u<n.length;u++)f=n.substr(u,1),"0"!=f&&(i+=o[Number(f)]+c[u]);return""==i&&(i="零元"),""==n&&(i+="整"),i},list:function(t,e){var n=0;return t.split("\n").map(function(t){t.split("`").map(function(t,i){i===e-1&&(n+=parseFloat(t))})}),n}},exp=attrFromTemplateFilter(ic.value,"data-exp"),icIds=exp?exp.match(/\d+/g):null;return icIds&&scope.$watch(function(){return icIds.map(function(t){return scope.getValue(t)}).join()},function(){try{var evalExp=eval(exp);scope.setValue(ic["data-id"],"number"==typeof evalExp?evalExp.toFixed(ic["data-prec"]):evalExp)}catch(e){}}),'<input type="text" ng-model="'+modelName+'" name="data_'+ic["data-id"]+'" />'},imgupload:function(t,e){attrFromTemplateFilter(t.value,"data-src");return"<span>暂不支持图片上传控件</span>"},listview:function(t,e){return"<span>暂不支持列表控件</span>"},sign:function(t,e){return"<span>暂不支持签章控件</span>"},progressbar:function(t,e){return"<span>暂不支持进度条控件</span>"},qrcode:function(t,e){return"<span>暂不支持二维码控件</span>"}},ret={parse:function(t,e,n){var i=t&&t["data-type"];return ics[i]?ics[i].call(null,t,e,n):t.value||""}};return ret.serializes={date:function(t,e){if(!t)return"";var n=e["data-date-format"].replace("mm","MM").replace("hh","HH").replace("ii","mm");return Utils.isFormTypeSupported("datetime-local")||Utils.isFormTypeSupported("date")?$filter("date")(t,n):t},user:function(t,e){var n=e["data-select-type"];return"user"==n?User.addPrefix(t):"position"==n?User.addPositionPrefix(t):User.addDepartmentPrefix(t)}},ret.serialize=function(t,e){return e&&e.length?(angular.forEach(e,function(e){var n=e["data-type"],i=e["data-id"];ret.serializes[n]&&(t["data_"+i]=ret.serializes[n].call(null,t["data_"+i],e))}),t):t},ret}]),angular.module("workflow",["ionic","workflow.controllers","workflow.services","workflow.filters","workflow.directives"]).run(["Apps",function(t){t.install({name:"workflow",title:"工作流",route:"#/workflow",state:"workflow.index",icon:"img/modicon/workflow.png"})}]).config(["$stateProvider","$urlRouterProvider","UserProvider","ResolversProvider",function(t,e,n,i){e.when("/workflow","/workflow/index"),t.state("workflow",{url:"/workflow","abstract":!0,template:'<ion-nav-view name="workflow"></ion-nav-view>',resolve:n.resolve}),t.state("workflow.index",{url:"/index",talkingDataLabel:"工作流-首页",views:{workflow:{templateUrl:"templates/workflow/workflow-index.html",controller:"FlowIndexCtrl"}}}).state("workflow.todo",{url:"/todo",talkingDataLabel:"工作流-待办工作",views:{workflow:{templateUrl:"templates/workflow/workflow-list.html",controller:"FlowTodoCtrl"}}}).state("workflow.trans",{url:"/trans",talkingDataLabel:"工作流-已办结",views:{workflow:{templateUrl:"templates/workflow/workflow-list.html",controller:"FlowTransCtrl"}}}).state("workflow.done",{url:"/done",talkingDataLabel:"工作流-已完成",views:{workflow:{templateUrl:"templates/workflow/workflow-list.html",controller:"FlowDoneCtrl"}}}).state("workflow.follow",{url:"/follow",talkingDataLabel:"工作流-我的关注",views:{workflow:{templateUrl:"templates/workflow/workflow-follow-list.html",controller:"FlowFollowCtrl"}}}).state("workflow.create",{url:"/create",talkingDataLabel:"工作流-发布工作",views:{workflow:{templateUrl:"templates/workflow/workflow-create.html",controller:"FlowCreateCtrl"}}}).state("workflow.handle",{url:"/handle/:key?topflag",talkingDataLabel:"工作流-主办",resolve:i.get(["canvasPainter"]),views:{workflow:{templateUrl:"templates/workflow/workflow-handle.html",controller:"FlowHandleCtrl"}}}).state("workflow.handover",{url:"/handover/:key?topflag",talkingDataLabel:"工作流-转交",views:{workflow:{templateUrl:"templates/workflow/workflow-handover.html",controller:"FlowHandoverCtrl"}}}).state("workflow.handoverFree",{url:"/handoverFree/:key",talkingDataLabel:"工作流-转交自由流程",views:{workflow:{templateUrl:"templates/workflow/workflow-handover-free.html",controller:"FlowHandoverFreeCtrl"}}}).state("workflow.detail",{url:"/detail/:key",talkingDataLabel:"工作流-查看工作流",views:{workflow:{templateUrl:"templates/workflow/workflow-detail.html",controller:"FlowDetailCtrl"}}})}]).run(["$rootScope","$ionicHistory",function(t,e){}]);try{angular.module("ibosApp.templates")}catch(e){angular.module("ibosApp.templates",[])}var installed=["calendar","cabinet","diary","news","docs","contacts","email","workflow","assignment","thread","activity","vote","crm","report"];angular.module("ibosApp",["ionic","oc.lazyLoad","angular.filter","datetime","ibosApp.templates","ibosApp.services","ibosApp.filters","ibosApp.directives","ibosApp.controllers"].concat(installed)).run(["$window","$injector",function(t,e){t.addEventListener("load",function(){function e(t,i){return i||(i={},n=angular.element(document.body).injector().get),angular.forEach(angular.module(t).requires,function(t){e(t,i)}),angular.forEach(angular.module(t)._invokeQueue,function(t){try{i[t[2][0]]=n(t[2][0])}catch(e){}}),i}var n;t.sv=e("ibosApp")},!1)}]).run(["$rootScope","Utils",function(t,e){t.$on("$ionicView.afterEnter",function(t,n){n&&n.title&&e.setDocumentTitle(n.title)})}]).config(["$httpProvider","$httpParamSerializerJQLikeProvider",function(t,e){var n=e.$get();t.defaults.useXDomain=!0,t.defaults.withCredentials=!0,t.defaults.headers.common.ISCORS=!0,t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",t.defaults.transformRequest=[function(t){return angular.isObject(t)&&"[object File]"!==String(t)?n(t):t}],t.interceptors.push(["$q",function(t){return{response:function(t){var e=t.data;return angular.isDefined(e.isSuccess)&&!e.isSuccess&&"undefined"!=typeof TDAPP&&TDAPP.onEvent("response warn","api",{response:t}),t},responseError:function(e){return"undefined"!=typeof TDAPP&&TDAPP.onEvent("response error","api",{response:e}),t.reject(e)}}}])}]).config(["$animateProvider",function(t){t.classNameFilter(/^(?:(?!no-animation).)*$/)}]).config(["$compileProvider",function(t){t.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob):|data:image\/)/)}]).config(["$stateProvider","$urlRouterProvider","UserProvider",function(t,e,n){t.state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl"}).state("portal",{url:"/portal",templateUrl:"templates/tab-apps.html",controller:"AppsCtrl",resolve:n.resolve}),e.otherwise("/portal")}]).constant("$ionicLoadingConfig",{noBackdrop:!0,template:"<ion-spinner></ion-spinner>"}).config(["$ionicConfigProvider",function(t){t.backButton.text("返回").icon("ion-ios-arrow-back").previousTitleText(!0),t.tabs.style("standard").position("bottom"),t.navBar.alignTitle("center").positionPrimaryButtons("left").positionSecondaryButtons("right"),t.views.transition("ios"),t.spinner.icon("android")}]).config(["$provide",function(t){t.decorator("$ionicHistory",["$delegate",function(t){return t.removeBackView=function(){var t=this,e=t.viewHistory(),n=e.histories[this.currentHistoryId()],i=n.cursor,r=n.stack[i],o=n.stack[i-1],a=n.stack[i-2];o&&a&&(n.stack.splice(i-1,1),t.clearCache([o.viewId]),r.backViewId=a.viewId,r.index=r.index-1,a.forwardViewId=r.viewId,e.backView=a,n.currentCursor+=-1)},t}])}]).run(["$document","$rootScope","$ionicHistory","Settings",function(t,e,n,i){e.isWeiXin=/micromessenger/.test(window.navigator.userAgent.toLowerCase()),e.hasBackView=function(){return!!n.backView()},e.isBackView=function(t){var e=n.backView();if(e){if(angular.isString(t))return e.stateId==t;if(angular.isArray(t))return t.indexOf(e.stateId)!==-1}return!1}}]).run(["$rootScope","TalkingData",function(t,e){t.$on("$stateChangeSuccess",function(t,n,i,r){n.talkingDataLabel&&(n.talkingDataParams?e.onEvent(n.talkingDataLabel,"",i):e.onEvent(n.talkingDataLabel,""))})}]),angular.bootstrap(document.body,["ibosApp"]);
//# sourceMappingURL=all.js.map
